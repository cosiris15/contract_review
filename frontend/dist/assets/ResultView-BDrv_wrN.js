import{q as Ee,u as Ue,r as T,c as V,o as De,E as B,b as a,x as Le,y as Ae,d as P,e as x,h as n,i as t,w as o,j as u,t as i,f as E,g as N,F as Be,m as Ne,v as Se}from"./index-7sGP7AR4.js";import{u as $e}from"./index-HkzzAu3n.js";import{_ as je,a as U}from"./_plugin-vue_export-helper-DvhFouXh.js";const Pe={class:"result-view"},Me={class:"result-header"},qe={class:"header-info"},Ie={class:"header-meta"},Oe={class:"header-actions"},ze={class:"redline-dialog-content"},Fe={class:"export-option"},Je={class:"option-header"},We={class:"option-count"},Ge={class:"export-option"},He={class:"option-header"},Ke={key:0,class:"option-count"},Qe={class:"stat-value"},Xe={class:"stat-detail"},Ye={class:"stat-value"},Ze={class:"stat-value"},et={class:"stat-detail"},tt={class:"stat-value"},ot={class:"stat-detail"},lt={class:"text-ellipsis"},nt={key:1},at={class:"modification-list"},st={class:"mod-header"},it={class:"mod-reason"},dt={class:"text-box original"},rt={__name:"ResultView",setup(ut){const te=Ee(),oe=Ue(),S=$e(),M=T(!1),W=T("risks"),g=V(()=>te.params.taskId),q=T(!1),p=T(null),D=T(!1),$=T(!1),c=V(()=>S.reviewResult),w=V(()=>{var l;return((l=c.value)==null?void 0:l.summary)||{total_risks:0,high_risks:0,medium_risks:0,low_risks:0,total_modifications:0,must_modify:0,should_modify:0,total_actions:0,immediate_actions:0}}),le=V(()=>{var l;return((l=c.value)==null?void 0:l.material_type)==="contract"?"合同":"营销材料"}),I=V(()=>{var l;return(l=c.value)!=null&&l.modifications?c.value.modifications.filter(e=>e.user_confirmed).length:0}),O=V(()=>{var l;return((l=p.value)==null?void 0:l.commentable_actions)>0}),ne=V(()=>!(p.value&&!p.value.can_export||I.value===0&&!O.value));De(async()=>{var l;if(g.value){M.value=!0;try{await S.loadResult(g.value),(l=c.value)!=null&&l.modifications&&c.value.modifications.forEach(e=>{e.editText=e.user_modified_text||e.suggested_text}),await ae()}catch{B.error("加载结果失败")}finally{M.value=!1}}});async function ae(){try{const l=await U.getRedlinePreview(g.value);p.value=l.data}catch(l){console.error("获取 Redline 预览失败:",l)}}function se(){oe.push("/")}function ie(l){return l?new Date(l).toLocaleString("zh-CN"):"-"}function de(l){return{high:"danger",medium:"warning",low:"info"}[l]||"info"}function re(l){return{high:"高",medium:"中",low:"低"}[l]||l}function ue(l){return{must:"danger",should:"warning",may:"info"}[l]||"info"}function ce(l){return{must:"必须",should:"应该",may:"可以"}[l]||l}function pe(l){return{immediate:"danger",soon:"warning",normal:"info"}[l]||"info"}function _e(l){return{immediate:"立即",soon:"尽快",normal:"一般"}[l]||l}async function G(l,e){var f;try{await S.updateModification(g.value,l.id,e),(f=c.value)!=null&&f.modifications&&c.value.modifications.forEach(_=>{_.editText=_.user_modified_text||_.suggested_text})}catch{B.error("更新失败")}}async function me(l,e){try{await S.updateAction(g.value,l.id,e)}catch{B.error("更新失败")}}function fe(l){const f={excel:U.exportExcel(g.value),csv:U.exportCsv(g.value),json:U.exportJson(g.value),report:U.exportReport(g.value)}[l];f&&window.open(f,"_blank")}async function ve(){q.value=!0;try{const l=await U.exportRedline(g.value,null,$.value),e=l.headers["content-disposition"];let f="document_redline.docx";if(e){const h=e.match(/filename="?([^"]+)"?/);h&&(f=h[1])}const _=new Blob([l.data],{type:"application/vnd.openxmlformats-officedocument.wordprocessingml.document"}),k=window.URL.createObjectURL(_),b=document.createElement("a");b.href=k,b.download=f,document.body.appendChild(b),b.click(),document.body.removeChild(b),window.URL.revokeObjectURL(k);const L=l.headers["x-redline-applied"]||0,j=l.headers["x-comments-added"]||0;let A="导出成功！";L>0&&(A+=`已应用 ${L} 条修改`),j>0&&(A+=`${L>0?"，":""}添加 ${j} 条批注`),B.success(A),D.value=!1}catch(l){console.error("导出 Redline 失败:",l),B.error(l.message||"导出失败，请重试")}finally{q.value=!1}}return(l,e)=>{var Y,Z,ee;const f=a("ArrowLeft"),_=a("el-icon"),k=a("el-button"),b=a("el-tag"),L=a("EditPen"),j=a("Download"),A=a("ArrowDown"),h=a("el-dropdown-item"),ye=a("el-dropdown-menu"),ge=a("el-dropdown"),H=a("el-alert"),we=a("Document"),be=a("el-divider"),xe=a("ChatLineSquare"),z=a("el-checkbox"),ke=a("el-dialog"),C=a("el-card"),R=a("el-col"),K=a("el-row"),F=a("el-badge"),v=a("el-table-column"),he=a("el-popover"),Q=a("el-table"),J=a("el-tab-pane"),Ve=a("el-input"),X=a("el-empty"),Ce=a("el-tabs"),Re=Le("loading");return Ae((x(),P("div",Pe,[n("div",Me,[n("div",qe,[t(k,{text:"",onClick:se},{default:o(()=>[t(_,null,{default:o(()=>[t(f)]),_:1}),e[5]||(e[5]=u(" 返回 ",-1))]),_:1}),n("h2",null,i(((Y=c.value)==null?void 0:Y.document_name)||"审阅结果"),1),n("div",Ie,[t(b,null,{default:o(()=>[u(i(le.value),1)]),_:1}),n("span",null,"我方: "+i((Z=c.value)==null?void 0:Z.our_party),1),n("span",null,"审阅时间: "+i(ie((ee=c.value)==null?void 0:ee.reviewed_at)),1)])]),n("div",Oe,[t(k,{type:"success",onClick:e[0]||(e[0]=s=>D.value=!0),disabled:!ne.value},{default:o(()=>[t(_,null,{default:o(()=>[t(L)]),_:1}),e[6]||(e[6]=u(" 导出修订版 Word ",-1))]),_:1},8,["disabled"]),t(ge,{onCommand:fe},{dropdown:o(()=>[t(ye,null,{default:o(()=>[t(h,{command:"excel"},{default:o(()=>[...e[8]||(e[8]=[u("导出 Excel",-1)])]),_:1}),t(h,{command:"csv"},{default:o(()=>[...e[9]||(e[9]=[u("导出 CSV",-1)])]),_:1}),t(h,{command:"json"},{default:o(()=>[...e[10]||(e[10]=[u("导出 JSON",-1)])]),_:1}),t(h,{command:"report"},{default:o(()=>[...e[11]||(e[11]=[u("导出报告",-1)])]),_:1})]),_:1})]),default:o(()=>[t(k,{type:"primary"},{default:o(()=>[t(_,null,{default:o(()=>[t(j)]),_:1}),e[7]||(e[7]=u(" 导出 ",-1)),t(_,{class:"el-icon--right"},{default:o(()=>[t(A)]),_:1})]),_:1})]),_:1})])]),t(ke,{modelValue:D.value,"onUpdate:modelValue":e[3]||(e[3]=s=>D.value=s),title:"导出修订版 Word",width:"500px"},{footer:o(()=>[t(k,{onClick:e[2]||(e[2]=s=>D.value=!1)},{default:o(()=>[...e[18]||(e[18]=[u("取消",-1)])]),_:1}),t(k,{type:"primary",onClick:ve,loading:q.value,disabled:I.value===0&&(!$.value||!O.value)},{default:o(()=>[...e[19]||(e[19]=[u(" 导出 ",-1)])]),_:1},8,["loading","disabled"])]),default:o(()=>{var s,r,y,d,m;return[n("div",ze,[!((s=p.value)!=null&&s.can_export)&&((r=p.value)!=null&&r.reason)?(x(),E(H,{key:0,title:p.value.reason,type:"warning","show-icon":"",closable:!1,style:{"margin-bottom":"16px"}},null,8,["title"])):N("",!0),n("div",Fe,[n("div",Je,[t(_,null,{default:o(()=>[t(we)]),_:1}),e[12]||(e[12]=n("span",null,"修改建议（修订标记）",-1))]),e[14]||(e[14]=n("div",{class:"option-desc"}," 将已确认的修改建议以删除线和插入标记形式显示 ",-1)),n("div",We,[e[13]||(e[13]=u(" 已确认 ",-1)),n("strong",null,i(I.value),1),u(" 条 / 共 "+i(((y=p.value)==null?void 0:y.total_modifications)||0)+" 条 ",1)])]),t(be),n("div",Ge,[n("div",He,[t(z,{modelValue:$.value,"onUpdate:modelValue":e[1]||(e[1]=Te=>$.value=Te),disabled:!O.value},{default:o(()=>[t(_,null,{default:o(()=>[t(xe)]),_:1}),e[15]||(e[15]=n("span",null,"行动建议（批注）",-1))]),_:1},8,["modelValue","disabled"])]),e[17]||(e[17]=n("div",{class:"option-desc"}," 将行动建议作为批注添加到对应风险点的文本位置 ",-1)),p.value?(x(),P("div",Ke,[e[16]||(e[16]=u(" 可添加 ",-1)),n("strong",null,i(p.value.commentable_actions||0),1),u(" 条批注 / 共 "+i(p.value.total_actions||0)+" 条行动建议 ",1)])):N("",!0),((d=p.value)==null?void 0:d.total_actions)>0&&((m=p.value)==null?void 0:m.commentable_actions)===0?(x(),E(H,{key:1,title:"行动建议未关联风险点原文，无法生成批注",type:"info","show-icon":"",closable:!1,style:{"margin-top":"8px"}})):N("",!0)])])]}),_:1},8,["modelValue"]),t(K,{gutter:16,class:"stat-cards"},{default:o(()=>[t(R,{span:6},{default:o(()=>[t(C,{class:"stat-card danger"},{default:o(()=>[n("div",Qe,i(w.value.total_risks),1),e[20]||(e[20]=n("div",{class:"stat-label"},"风险总数",-1)),n("div",Xe," 高 "+i(w.value.high_risks)+" / 中 "+i(w.value.medium_risks)+" / 低 "+i(w.value.low_risks),1)]),_:1})]),_:1}),t(R,{span:6},{default:o(()=>[t(C,{class:"stat-card warning"},{default:o(()=>[n("div",Ye,i(w.value.high_risks),1),e[21]||(e[21]=n("div",{class:"stat-label"},"高风险",-1)),e[22]||(e[22]=n("div",{class:"stat-detail"},"需优先处理",-1))]),_:1})]),_:1}),t(R,{span:6},{default:o(()=>[t(C,{class:"stat-card primary"},{default:o(()=>[n("div",Ze,i(w.value.total_modifications),1),e[23]||(e[23]=n("div",{class:"stat-label"},"修改建议",-1)),n("div",et," 必须 "+i(w.value.must_modify)+" / 应该 "+i(w.value.should_modify),1)]),_:1})]),_:1}),t(R,{span:6},{default:o(()=>[t(C,{class:"stat-card success"},{default:o(()=>[n("div",tt,i(w.value.total_actions),1),e[24]||(e[24]=n("div",{class:"stat-label"},"行动建议",-1)),n("div",ot," 立即处理 "+i(w.value.immediate_actions),1)]),_:1})]),_:1})]),_:1}),t(C,{class:"content-card"},{default:o(()=>[t(Ce,{modelValue:W.value,"onUpdate:modelValue":e[4]||(e[4]=s=>W.value=s)},{default:o(()=>[t(J,{label:"风险点",name:"risks"},{label:o(()=>{var s,r;return[n("span",null,[e[25]||(e[25]=u(" 风险点 ",-1)),t(F,{value:((r=(s=c.value)==null?void 0:s.risks)==null?void 0:r.length)||0,type:"danger"},null,8,["value"])])]}),default:o(()=>{var s;return[t(Q,{data:((s=c.value)==null?void 0:s.risks)||[],stripe:"",border:""},{default:o(()=>[t(v,{label:"风险等级",width:"100",align:"center"},{default:o(({row:r})=>[t(b,{type:de(r.risk_level)},{default:o(()=>[u(i(re(r.risk_level)),1)]),_:2},1032,["type"])]),_:1}),t(v,{prop:"risk_type",label:"风险类型",width:"120"}),t(v,{prop:"description",label:"风险描述","min-width":"200"}),t(v,{prop:"reason",label:"判定理由","min-width":"200"}),t(v,{label:"原文摘录",width:"200"},{default:o(({row:r})=>{var y;return[(y=r.location)!=null&&y.original_text?(x(),E(he,{key:0,trigger:"hover",width:"400",placement:"top"},{reference:o(()=>[n("span",lt,i(r.location.original_text.slice(0,50))+"... ",1)]),default:o(()=>[n("div",null,i(r.location.original_text),1)]),_:2},1024)):(x(),P("span",nt,"-"))]}),_:1})]),_:1},8,["data"])]}),_:1}),t(J,{label:"修改建议",name:"modifications"},{label:o(()=>{var s,r;return[n("span",null,[e[26]||(e[26]=u(" 修改建议 ",-1)),t(F,{value:((r=(s=c.value)==null?void 0:s.modifications)==null?void 0:r.length)||0,type:"primary"},null,8,["value"])])]}),default:o(()=>{var s,r,y;return[n("div",at,[(x(!0),P(Be,null,Ne(((s=c.value)==null?void 0:s.modifications)||[],d=>(x(),E(C,{key:d.id,class:Se(["modification-card",{confirmed:d.user_confirmed}])},{default:o(()=>[n("div",st,[t(b,{type:ue(d.priority)},{default:o(()=>[u(i(ce(d.priority)),1)]),_:2},1032,["type"]),n("span",it,i(d.modification_reason),1),t(z,{modelValue:d.user_confirmed,"onUpdate:modelValue":m=>d.user_confirmed=m,onChange:m=>G(d,{user_confirmed:m})},{default:o(()=>[...e[27]||(e[27]=[u(" 确认采纳 ",-1)])]),_:1},8,["modelValue","onUpdate:modelValue","onChange"])]),t(K,{gutter:20,class:"mod-content"},{default:o(()=>[t(R,{span:12},{default:o(()=>[e[28]||(e[28]=n("div",{class:"text-label"},"当前文本",-1)),n("div",dt,i(d.original_text),1)]),_:2},1024),t(R,{span:12},{default:o(()=>[e[29]||(e[29]=n("div",{class:"text-label"},"建议修改为",-1)),t(Ve,{type:"textarea",rows:4,modelValue:d.editText,"onUpdate:modelValue":m=>d.editText=m,onBlur:m=>G(d,{user_modified_text:d.editText})},null,8,["modelValue","onUpdate:modelValue","onBlur"])]),_:2},1024)]),_:2},1024)]),_:2},1032,["class"]))),128)),(y=(r=c.value)==null?void 0:r.modifications)!=null&&y.length?N("",!0):(x(),E(X,{key:0,description:"无修改建议"}))])]}),_:1}),t(J,{label:"行动建议",name:"actions"},{label:o(()=>{var s,r;return[n("span",null,[e[30]||(e[30]=u(" 行动建议 ",-1)),t(F,{value:((r=(s=c.value)==null?void 0:s.actions)==null?void 0:r.length)||0,type:"success"},null,8,["value"])])]}),default:o(()=>{var s,r,y;return[t(Q,{data:((s=c.value)==null?void 0:s.actions)||[],stripe:"",border:""},{default:o(()=>[t(v,{label:"紧急程度",width:"100",align:"center"},{default:o(({row:d})=>[t(b,{type:pe(d.urgency)},{default:o(()=>[u(i(_e(d.urgency)),1)]),_:2},1032,["type"])]),_:1}),t(v,{prop:"action_type",label:"行动类型",width:"120"}),t(v,{prop:"description",label:"具体行动","min-width":"250"}),t(v,{prop:"responsible_party",label:"负责方",width:"100"}),t(v,{prop:"deadline_suggestion",label:"建议时限",width:"120"},{default:o(({row:d})=>[u(i(d.deadline_suggestion||"-"),1)]),_:1}),t(v,{label:"确认",width:"80",align:"center"},{default:o(({row:d})=>[t(z,{modelValue:d.user_confirmed,"onUpdate:modelValue":m=>d.user_confirmed=m,onChange:m=>me(d,m)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:1})]),_:1},8,["data"]),(y=(r=c.value)==null?void 0:r.actions)!=null&&y.length?N("",!0):(x(),E(X,{key:0,description:"无行动建议"}))]}),_:1})]),_:1},8,["modelValue"])]),_:1})])),[[Re,M.value]])}}},mt=je(rt,[["__scopeId","data-v-4fcd2586"]]);export{mt as default};
