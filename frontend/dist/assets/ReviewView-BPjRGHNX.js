import{q as He,u as Je,r as b,c as h,o as Ke,E as v,s as ie,b as r,d as _,e as i,i as t,f as M,g as C,w as a,k as y,h as s,l as Qe,t as c,T as We,j as p,F as P,m as A,v as Ye}from"./index-7sGP7AR4.js";import{u as Ze}from"./index-HkzzAu3n.js";import{_ as et,a as de}from"./_plugin-vue_export-helper-DvhFouXh.js";const tt={class:"review-view"},at={key:0,class:"operation-status-bar"},lt={class:"upload-section"},ot={key:0,class:"uploaded-file"},st={key:1,class:"upload-placeholder"},nt={class:"upload-section"},rt={style:{color:"#909399","font-size":"12px","margin-left":"8px"}},it={key:0,class:"uploaded-file"},dt={key:1,class:"upload-placeholder"},ut={class:"library-section"},ct={class:"library-actions"},pt={key:0,class:"selected-standards"},mt={class:"selected-count"},_t={class:"standards-preview"},vt={key:0,class:"more-count"},ft={key:1,class:"library-tip"},gt={key:0,class:"standard-status"},yt={key:0},bt={class:"recommend-list"},wt=["onClick"],kt={class:"recommend-content"},ht={class:"recommend-header"},xt={class:"recommend-title"},Ct={class:"recommend-reason"},St={class:"recommend-desc"},Vt={class:"library-selector"},Rt={key:0,class:"waiting-state"},Tt={key:1,class:"progress-state"},zt={class:"progress-content"},Lt={class:"progress-info"},$t={class:"progress-steps"},Dt={key:2,class:"completed-state"},Ut={key:0},Et={key:3,class:"failed-state"},Ft={__name:"ReviewView",setup(Mt){const G=He(),B=Je(),n=Ze(),H=b(null),u=b(G.params.taskId||null),w=b({name:"",our_party:"",material_type:"contract"}),ue={name:[{required:!0,message:"请输入任务名称",trigger:"blur"}],our_party:[{required:!0,message:"请输入我方身份",trigger:"blur"}]},I=b("template"),x=b(""),J=b([]),N=b(!1),S=b(!1),V=b(!1),L=b([]),m=b([]),$=b([]),D=b(""),K=b([]),X=b(!1),f=h(()=>n.currentTask),Q=h(()=>{var l;return((l=f.value)==null?void 0:l.status)==="completed"}),ce=h(()=>{var l;return((l=f.value)==null?void 0:l.status)==="failed"}),pe=h(()=>u.value?n.canStartReview:!1),me=h(()=>({idle:"准备中",analyzing:"分析文档",generating:"生成建议",completed:"已完成"})[n.progress.stage]||"处理中"),_e=h(()=>{const l=n.progress.stage;return l==="idle"?0:l==="analyzing"?1:l==="generating"?2:l==="completed"?4:1});Ke(async()=>{if(await n.fetchTemplates(),J.value=n.templates,u.value)try{await n.loadTask(u.value),w.value={name:f.value.name,our_party:f.value.our_party,material_type:f.value.material_type},f.value.status==="reviewing"&&(n.isReviewing=!0,n.startPolling(u.value))}catch{v.error("加载任务失败"),B.push("/")}}),ie(()=>G.params.taskId,async l=>{l&&l!==u.value&&(u.value=l,await n.loadTask(l))});async function ve(l){if(!u.value){if(!await H.value.validate().catch(()=>!1)){v.warning("请先填写基本信息");return}try{const d=await n.createTask({name:w.value.name,our_party:w.value.our_party,material_type:w.value.material_type});u.value=d.id,B.replace(`/review/${d.id}`)}catch{v.error("创建任务失败");return}}try{await n.uploadDocument(u.value,l.raw),v.success("文档上传成功")}catch(e){v.error(e.message||"上传失败")}}async function fe(l){if(!u.value){v.warning("请先上传文档");return}try{x.value="",await n.uploadStandard(u.value,l.raw),v.success("审核标准上传成功")}catch(e){v.error(e.message||"上传失败")}}async function ge(l){if(!u.value){v.warning("请先上传文档"),x.value="";return}try{await n.useTemplate(u.value,l),v.success("模板应用成功")}catch(e){v.error(e.message||"应用模板失败"),x.value=""}}async function ye(){if(!u.value){v.warning("请先完成配置");return}try{await n.startReview(u.value)}catch(l){v.error(l.message||"启动审阅失败")}}function be(){n.progress={stage:"idle",percentage:0,message:""},f.value&&(f.value.status="created")}function we(){B.push(`/result/${u.value}`)}function ke(){n.operationState.lastError=null}async function he(){try{const l=await de.getLibraryStandards({material_type:w.value.material_type});$.value=l.data}catch(l){console.error("加载标准库失败:",l)}}async function xe(){var l;if(!((l=f.value)!=null&&l.document_filename)){v.warning("请先上传文档");return}N.value=!0;try{const e=await de.recommendStandards({document_text:"待审阅文档内容",material_type:w.value.material_type});L.value=e.data,m.value=L.value.filter(d=>d.relevance_score>=.5).map(d=>d.standard),S.value=!0}catch(e){v.error("推荐失败: "+e.message)}finally{N.value=!1}}function W(l){return m.value.some(e=>e.id===l)}function Ce(l){const e=m.value.findIndex(d=>d.id===l.standard_id);e>=0?m.value.splice(e,1):m.value.push(l.standard)}function Se(){S.value=!1,m.value.length&&v.success(`已选择 ${m.value.length} 条标准`)}function Ve(l){m.value=m.value.filter(e=>e.id!==l)}function Re(l){return l>=.8?"success":l>=.5?"warning":"info"}const Te=h(()=>{if(!D.value)return $.value;const l=D.value.toLowerCase();return $.value.filter(e=>e.category.toLowerCase().includes(l)||e.item.toLowerCase().includes(l)||e.description.toLowerCase().includes(l))});function ze(l){K.value=l}function Le(){m.value=[...K.value],V.value=!1,m.value.length&&v.success(`已选择 ${m.value.length} 条标准`)}function $e(l){return{high:"danger",medium:"warning",low:"success"}[l]||"info"}function De(l){return{high:"高",medium:"中",low:"低"}[l]||l}async function Ue(){if(!(!u.value||!m.value.length)){X.value=!0;try{const e=["审核分类,审核要点,详细说明,风险等级,适用材料类型",...m.value.map(g=>({category:g.category,item:g.item,description:g.description,risk_level:g.risk_level,applicable_to:g.applicable_to})).map(g=>`"${g.category}","${g.item}","${g.description}","${g.risk_level==="high"?"高":g.risk_level==="medium"?"中":"低"}","${g.applicable_to.join(",")}"`)].join(`
`),d=new Blob([e],{type:"text/csv;charset=utf-8"}),U=new File([d],"selected_standards.csv",{type:"text/csv"});await n.uploadStandard(u.value,U),v.success("标准应用成功")}catch(l){v.error("应用标准失败: "+l.message)}finally{X.value=!1}}}return ie(I,l=>{l==="library"&&!$.value.length&&he()}),(l,e)=>{const d=r("el-icon"),U=r("el-alert"),g=r("el-input"),j=r("el-form-item"),Y=r("el-radio"),Ee=r("el-radio-group"),Fe=r("el-form"),q=r("el-divider"),Z=r("Document"),ee=r("DocumentChecked"),k=r("el-button"),te=r("UploadFilled"),ae=r("el-upload"),Me=r("List"),Be=r("el-option"),Ie=r("el-select"),O=r("el-tab-pane"),Ne=r("MagicStick"),E=r("el-tag"),Xe=r("Collection"),je=r("el-tabs"),qe=r("el-checkbox"),le=r("el-empty"),oe=r("el-dialog"),R=r("el-table-column"),Oe=r("el-table"),se=r("el-card"),ne=r("el-col"),Pe=r("el-progress"),F=r("el-step"),Ae=r("el-steps"),re=r("el-result"),Ge=r("el-row");return i(),_("div",tt,[t(We,{name:"fade"},{default:a(()=>[y(n).isOperationInProgress?(i(),_("div",at,[t(d,{class:"is-loading"},{default:a(()=>[t(y(Qe))]),_:1}),s("span",null,c(y(n).currentOperationMessage),1)])):C("",!0)]),_:1}),y(n).operationError&&!y(n).isOperationInProgress?(i(),M(U,{key:0,type:"error",title:y(n).operationError.message,description:y(n).operationError.detail,"show-icon":"",closable:"",class:"error-alert",onClose:ke},null,8,["title","description"])):C("",!0),t(Ge,{gutter:24},{default:a(()=>[t(ne,{span:10},{default:a(()=>[t(se,{class:"config-card"},{header:a(()=>[...e[11]||(e[11]=[s("div",{class:"card-header"},[s("span",null,"审阅配置")],-1)])]),default:a(()=>{var T;return[t(Fe,{ref_key:"formRef",ref:H,model:w.value,rules:ue,"label-position":"top"},{default:a(()=>[t(j,{label:"任务名称",prop:"name"},{default:a(()=>[t(g,{modelValue:w.value.name,"onUpdate:modelValue":e[0]||(e[0]=o=>w.value.name=o),placeholder:"例如：XX合同审阅",disabled:!!u.value},null,8,["modelValue","disabled"])]),_:1}),t(j,{label:"我方身份",prop:"our_party"},{default:a(()=>[t(g,{modelValue:w.value.our_party,"onUpdate:modelValue":e[1]||(e[1]=o=>w.value.our_party=o),placeholder:"例如：XX科技有限公司",disabled:!!u.value},null,8,["modelValue","disabled"])]),_:1}),t(j,{label:"材料类型",prop:"material_type"},{default:a(()=>[t(Ee,{modelValue:w.value.material_type,"onUpdate:modelValue":e[2]||(e[2]=o=>w.value.material_type=o),disabled:!!u.value},{default:a(()=>[t(Y,{value:"contract"},{default:a(()=>[...e[12]||(e[12]=[p("合同",-1)])]),_:1}),t(Y,{value:"marketing"},{default:a(()=>[...e[13]||(e[13]=[p("营销材料",-1)])]),_:1})]),_:1},8,["modelValue","disabled"])]),_:1})]),_:1},8,["model"]),t(q),s("div",lt,[s("h4",null,[t(d,null,{default:a(()=>[t(Z)]),_:1}),e[14]||(e[14]=p(" 上传待审阅文档 ",-1))]),t(ae,{class:"upload-box",drag:"","auto-upload":!1,"show-file-list":!1,"on-change":ve,accept:".md,.txt,.docx,.pdf"},{default:a(()=>{var o;return[(o=f.value)!=null&&o.document_filename?(i(),_("div",ot,[t(d,{size:40,color:"#67c23a"},{default:a(()=>[t(ee)]),_:1}),s("span",null,c(f.value.document_filename),1),t(k,{type:"primary",text:"",size:"small"},{default:a(()=>[...e[15]||(e[15]=[p("重新上传",-1)])]),_:1})])):(i(),_("div",st,[t(d,{size:40},{default:a(()=>[t(te)]),_:1}),e[16]||(e[16]=s("p",null,"拖拽文件到此处或点击上传",-1)),e[17]||(e[17]=s("span",null,"支持 .md, .txt, .docx, .pdf 格式",-1))]))]}),_:1})]),t(q),s("div",nt,[s("h4",null,[t(d,null,{default:a(()=>[t(Me)]),_:1}),e[18]||(e[18]=p(" 审核标准 ",-1))]),t(je,{modelValue:I.value,"onUpdate:modelValue":e[5]||(e[5]=o=>I.value=o)},{default:a(()=>[t(O,{label:"使用模板",name:"template"},{default:a(()=>[t(Ie,{modelValue:x.value,"onUpdate:modelValue":e[3]||(e[3]=o=>x.value=o),placeholder:"选择审核标准模板",style:{width:"100%"},onChange:ge},{default:a(()=>[(i(!0),_(P,null,A(J.value,o=>(i(),M(Be,{key:o.name,label:o.name,value:o.name},{default:a(()=>[s("span",null,c(o.name),1),s("span",rt,c(o.description),1)]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(O,{label:"上传自定义",name:"upload"},{default:a(()=>[t(ae,{class:"upload-box",drag:"","auto-upload":!1,"show-file-list":!1,"on-change":fe,accept:".xlsx,.xls,.csv,.docx,.md,.txt"},{default:a(()=>{var o;return[(o=f.value)!=null&&o.standard_filename&&!x.value?(i(),_("div",it,[t(d,{size:40,color:"#67c23a"},{default:a(()=>[t(ee)]),_:1}),s("span",null,c(f.value.standard_filename),1),t(k,{type:"primary",text:"",size:"small"},{default:a(()=>[...e[19]||(e[19]=[p("重新上传",-1)])]),_:1})])):(i(),_("div",dt,[t(d,{size:40},{default:a(()=>[t(te)]),_:1}),e[20]||(e[20]=s("p",null,"上传自定义审核标准",-1)),e[21]||(e[21]=s("span",null,"支持 .xlsx, .csv, .docx, .md 格式",-1))]))]}),_:1})]),_:1}),t(O,{label:"从标准库选择",name:"library"},{default:a(()=>{var o;return[s("div",ut,[s("div",ct,[t(k,{type:"primary",loading:N.value,disabled:!((o=f.value)!=null&&o.document_filename),onClick:xe},{default:a(()=>[t(d,null,{default:a(()=>[t(Ne)]),_:1}),e[22]||(e[22]=p(" 智能推荐 ",-1))]),_:1},8,["loading","disabled"]),t(k,{onClick:e[4]||(e[4]=z=>V.value=!0)},{default:a(()=>[...e[23]||(e[23]=[p(" 手动选择 ",-1)])]),_:1})]),m.value.length?(i(),_("div",pt,[s("p",mt,"已选择 "+c(m.value.length)+" 条标准",1),s("div",_t,[(i(!0),_(P,null,A(m.value.slice(0,5),z=>(i(),M(E,{key:z.id,closable:"",onClose:Bt=>Ve(z.id),style:{margin:"4px"}},{default:a(()=>[p(c(z.item),1)]),_:2},1032,["onClose"]))),128)),m.value.length>5?(i(),_("span",vt," +"+c(m.value.length-5)+" 条 ",1)):C("",!0)]),t(k,{type:"primary",size:"small",style:{"margin-top":"12px"},onClick:Ue,loading:X.value},{default:a(()=>[...e[24]||(e[24]=[p(" 应用选中标准 ",-1)])]),_:1},8,["loading"])])):(i(),_("div",ft,[t(d,{size:32,color:"#909399"},{default:a(()=>[t(Xe)]),_:1}),e[25]||(e[25]=s("p",null,"点击「智能推荐」或「手动选择」从标准库中选择标准",-1))]))])]}),_:1})]),_:1},8,["modelValue"]),(T=f.value)!=null&&T.standard_filename?(i(),_("div",gt,[t(E,{type:"success"},{default:a(()=>[p(" 已选择: "+c(f.value.standard_filename),1)]),_:1})])):C("",!0)]),t(oe,{modelValue:S.value,"onUpdate:modelValue":e[7]||(e[7]=o=>S.value=o),title:"智能推荐标准",width:"700px"},{footer:a(()=>[t(k,{onClick:e[6]||(e[6]=o=>S.value=!1)},{default:a(()=>[...e[27]||(e[27]=[p("取消",-1)])]),_:1}),t(k,{type:"primary",onClick:Se},{default:a(()=>[p(" 确认选择 ("+c(m.value.length)+") ",1)]),_:1})]),default:a(()=>[L.value.length?(i(),_("div",yt,[t(U,{type:"info",closable:!1,style:{"margin-bottom":"16px"}},{default:a(()=>[...e[26]||(e[26]=[p(" 根据您上传的文档，推荐以下审核标准： ",-1)])]),_:1}),s("div",bt,[(i(!0),_(P,null,A(L.value,o=>(i(),_("div",{key:o.standard_id,class:Ye(["recommend-item",{selected:W(o.standard_id)}]),onClick:z=>Ce(o)},[t(qe,{"model-value":W(o.standard_id)},null,8,["model-value"]),s("div",kt,[s("div",ht,[s("span",xt,c(o.standard.item),1),t(E,{size:"small",type:Re(o.relevance_score)},{default:a(()=>[p(" 相关度 "+c(Math.round(o.relevance_score*100))+"% ",1)]),_:2},1032,["type"])]),s("p",Ct,c(o.match_reason),1),s("p",St,c(o.standard.description),1)])],10,wt))),128))])])):(i(),M(le,{key:1,description:"暂无推荐结果"}))]),_:1},8,["modelValue"]),t(oe,{modelValue:V.value,"onUpdate:modelValue":e[10]||(e[10]=o=>V.value=o),title:"从标准库选择",width:"800px"},{footer:a(()=>[t(k,{onClick:e[9]||(e[9]=o=>V.value=!1)},{default:a(()=>[...e[28]||(e[28]=[p("取消",-1)])]),_:1}),t(k,{type:"primary",onClick:Le},{default:a(()=>[...e[29]||(e[29]=[p(" 确认选择 ",-1)])]),_:1})]),default:a(()=>[s("div",Vt,[t(g,{modelValue:D.value,"onUpdate:modelValue":e[8]||(e[8]=o=>D.value=o),placeholder:"搜索标准...",clearable:"",style:{"margin-bottom":"16px"}},null,8,["modelValue"]),t(Oe,{data:Te.value,"max-height":"400",onSelectionChange:ze},{default:a(()=>[t(R,{type:"selection",width:"55"}),t(R,{prop:"category",label:"分类",width:"100"}),t(R,{prop:"item",label:"审核要点",width:"150"}),t(R,{prop:"description",label:"说明","show-overflow-tooltip":""}),t(R,{label:"风险",width:"60"},{default:a(({row:o})=>[t(E,{type:$e(o.risk_level),size:"small"},{default:a(()=>[p(c(De(o.risk_level)),1)]),_:2},1032,["type"])]),_:1})]),_:1},8,["data"])])]),_:1},8,["modelValue"]),t(q),t(k,{type:"primary",size:"large",class:"start-btn",loading:y(n).isReviewing,disabled:!pe.value,onClick:ye},{default:a(()=>[p(c(y(n).isReviewing?"审阅中...":"开始审阅"),1)]),_:1},8,["loading","disabled"])]}),_:1})]),_:1}),t(ne,{span:14},{default:a(()=>[t(se,{class:"progress-card"},{header:a(()=>[...e[30]||(e[30]=[s("div",{class:"card-header"},[s("span",null,"审阅进度")],-1)])]),default:a(()=>[!y(n).isReviewing&&!Q.value?(i(),_("div",Rt,[t(le,{description:"完成配置后点击开始审阅"},{image:a(()=>[t(d,{size:80,color:"#909399"},{default:a(()=>[t(Z)]),_:1})]),_:1})])):y(n).isReviewing?(i(),_("div",Tt,[s("div",zt,[t(Pe,{type:"circle",percentage:y(n).progress.percentage,width:150,"stroke-width":10},null,8,["percentage"]),s("div",Lt,[s("h3",null,c(me.value),1),s("p",null,c(y(n).progress.message),1)])]),s("div",$t,[t(Ae,{active:_e.value,"align-center":""},{default:a(()=>[t(F,{title:"分析文档"}),t(F,{title:"识别风险"}),t(F,{title:"生成建议"}),t(F,{title:"完成"})]),_:1},8,["active"])])])):Q.value?(i(),_("div",Dt,[t(re,{icon:"success",title:"审阅完成"},{"sub-title":a(()=>[y(n).reviewResult?(i(),_("p",Ut," 发现 "+c(y(n).reviewResult.summary.total_risks)+" 个风险点， 生成 "+c(y(n).reviewResult.summary.total_modifications)+" 条修改建议 ",1)):C("",!0)]),extra:a(()=>[t(k,{type:"primary",onClick:we},{default:a(()=>[...e[31]||(e[31]=[p(" 查看完整结果 ",-1)])]),_:1})]),_:1})])):ce.value?(i(),_("div",Et,[t(re,{icon:"error",title:"审阅失败"},{"sub-title":a(()=>{var T;return[s("p",null,c(((T=f.value)==null?void 0:T.message)||"发生未知错误"),1)]}),extra:a(()=>[t(k,{type:"primary",onClick:be},{default:a(()=>[...e[32]||(e[32]=[p("重试",-1)])]),_:1})]),_:1})])):C("",!0)]),_:1})]),_:1})]),_:1})])}}},jt=et(Ft,[["__scopeId","data-v-a7cce38a"]]);export{jt as default};
