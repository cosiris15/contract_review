import{r,A as Ie,o as Le,b as c,x as ze,d as S,e as _,h as o,g as re,i as a,w as t,j as i,k as C,B as Ae,C as De,t as u,D as Ee,F as Me,m as Te,f as j,G as $e,y as Be,H as Fe,I as ve,J as Re,v as A,E as p,p as Ne}from"./index-7sGP7AR4.js";import{_ as je,a as g}from"./_plugin-vue_export-helper-DvhFouXh.js";const qe={class:"standards-view"},Ge={class:"page-header"},He={class:"header-actions"},Je={key:0,class:"stats-row"},Ke={class:"stat-value"},Oe={class:"stat-value high"},We={class:"stat-value medium"},Pe={class:"stat-value low"},Qe={class:"filter-row"},Xe={key:0},Ye={class:"table-footer"},Ze={key:0},el={key:1},ll={style:{"margin-top":"16px"}},al={class:"ai-edit-container"},tl={class:"current-standard"},sl={class:"ai-input-section"},ol={class:"section-title"},il={class:"ai-input-actions"},nl={key:0,class:"ai-result-section"},ul={class:"section-title"},dl={__name:"StandardsView",setup(rl){const X=r(!1),D=r([]),U=r(null),te=r([]),q=r(""),G=r(""),H=r(""),J=r(""),E=r(!1),M=r(null),k=r([]),Y=r(!1),w=r(!1),K=r(!1),T=r(!1),v=Ie({category:"",item:"",description:"",risk_level:"medium",applicable_to:["contract","marketing"],usage_instruction:""}),$=r(!1),d=r(null),h=r(""),Z=r(!1),n=r(null),O=r([]);async function V(){X.value=!0;try{const s={};G.value&&(s.category=G.value),J.value&&(s.material_type=J.value),q.value&&(s.keyword=q.value);const e=await g.getLibraryStandards(s);D.value=e.data,H.value&&(D.value=D.value.filter(b=>b.risk_level===H.value))}catch(s){p.error("加载标准失败: "+s.message)}finally{X.value=!1}}async function B(){try{const s=await g.getLibraryStats();U.value=s.data}catch(s){console.error("加载统计失败:",s)}}async function F(){try{const s=await g.getLibraryCategories();te.value=s.data.categories}catch(s){console.error("加载分类失败:",s)}}let se=null;function pe(){clearTimeout(se),se=setTimeout(()=>{V()},300)}function ee(s){return{high:"danger",medium:"warning",low:"success"}[s]||"info"}function W(s){return{high:"高",medium:"中",low:"低"}[s]||s}function R(s){return s?s.map(e=>e==="contract"?"合同":"营销").join("、"):""}function ce(s){M.value=s.raw,k.value=[]}async function fe(){if(M.value){Y.value=!0;try{const s=await g.previewStandards(M.value);k.value=s.data.standards,p.success(`解析成功，共 ${s.data.total_count} 条标准`)}catch(s){p.error("解析失败: "+s.message)}finally{Y.value=!1}}}async function me(){if(k.value.length){w.value=!0;try{const s=await g.saveToLibrary({standards:k.value,replace:K.value});p.success(s.data.message),E.value=!1,oe(),V(),B(),F()}catch(s){p.error("保存失败: "+s.message)}finally{w.value=!1}}}function oe(){M.value=null,k.value=[],K.value=!1}function _e(s){d.value=s,h.value="",n.value=null,$.value=!0}async function ge(){if(!v.category||!v.item||!v.description){p.warning("请填写必填字段");return}w.value=!0;try{d.value?(await g.updateLibraryStandard(d.value.id,v),p.success("更新成功")):(await g.createLibraryStandard(v),p.success("添加成功")),T.value=!1,ie(),V(),B(),F()}catch(s){p.error("保存失败: "+s.message)}finally{w.value=!1}}async function ye(s){try{await Ne.confirm(`确定要删除标准「${s.item}」吗？`,"确认删除",{type:"warning"}),await g.deleteLibraryStandard(s.id),p.success("删除成功"),V(),B(),F()}catch(e){e!=="cancel"&&p.error("删除失败: "+e.message)}}function ie(){Object.assign(v,{category:"",item:"",description:"",risk_level:"medium",applicable_to:["contract","marketing"],usage_instruction:""})}function ne(){d.value=null,h.value="",n.value=null}async function be(){if(!(!h.value.trim()||!d.value)){Z.value=!0;try{const s=await g.aiModifyStandard(d.value.id,h.value);n.value=s.data.modified_standard,p.success("AI 已生成修改建议，请确认")}catch(s){p.error("AI 修改失败: "+s.message)}finally{Z.value=!1}}}async function ke(){if(!(!n.value||!d.value)){w.value=!0;try{await g.updateLibraryStandard(d.value.id,{category:n.value.category,item:n.value.item,description:n.value.description,risk_level:n.value.risk_level,applicable_to:n.value.applicable_to,usage_instruction:n.value.usage_instruction}),p.success("标准已更新"),$.value=!1,ne(),V(),B(),F()}catch(s){p.error("保存失败: "+s.message)}finally{w.value=!1}}}async function we(s){O.value.push(s.id);try{const e=await g.generateUsageInstruction({standard_ids:[s.id]});e.data.success_count>0?(s.usage_instruction=e.data.results[0].usage_instruction,p.success("生成成功")):p.error("生成失败: "+e.data.errors[0])}catch(e){p.error("生成失败: "+e.message)}finally{O.value=O.value.filter(e=>e!==s.id)}}async function Ve(){try{window.open(g.exportLibrary("csv"),"_blank")}catch(s){p.error("导出失败: "+s.message)}}return Le(()=>{V(),B(),F()}),(s,e)=>{const b=c("el-icon"),f=c("el-button"),I=c("el-card"),L=c("el-input"),x=c("el-option"),P=c("el-select"),y=c("el-table-column"),Q=c("el-tag"),ue=c("el-table"),xe=c("el-upload"),Ce=c("el-alert"),le=c("el-checkbox"),ae=c("el-dialog"),z=c("el-form-item"),he=c("el-checkbox-group"),Se=c("el-form"),m=c("el-descriptions-item"),de=c("el-descriptions"),Ue=ze("loading");return _(),S("div",qe,[o("div",Ge,[e[22]||(e[22]=o("div",{class:"header-left"},[o("h1",null,"审核标准管理"),o("p",{class:"subtitle"},"管理和维护审核标准库，支持导入、编辑、删除标准")],-1)),o("div",He,[a(f,{type:"primary",onClick:e[0]||(e[0]=l=>E.value=!0)},{default:t(()=>[a(b,null,{default:t(()=>[a(C(Ae))]),_:1}),e[20]||(e[20]=i(" 上传标准 ",-1))]),_:1}),a(f,{onClick:Ve},{default:t(()=>[a(b,null,{default:t(()=>[a(C(De))]),_:1}),e[21]||(e[21]=i(" 导出 ",-1))]),_:1})])]),U.value?(_(),S("div",Je,[a(I,{class:"stat-card"},{default:t(()=>[o("div",Ke,u(U.value.total),1),e[23]||(e[23]=o("div",{class:"stat-label"},"标准总数",-1))]),_:1}),a(I,{class:"stat-card"},{default:t(()=>{var l;return[o("div",Oe,u(((l=U.value.by_risk_level)==null?void 0:l.high)||0),1),e[24]||(e[24]=o("div",{class:"stat-label"},"高风险",-1))]}),_:1}),a(I,{class:"stat-card"},{default:t(()=>{var l;return[o("div",We,u(((l=U.value.by_risk_level)==null?void 0:l.medium)||0),1),e[25]||(e[25]=o("div",{class:"stat-label"},"中风险",-1))]}),_:1}),a(I,{class:"stat-card"},{default:t(()=>{var l;return[o("div",Pe,u(((l=U.value.by_risk_level)==null?void 0:l.low)||0),1),e[26]||(e[26]=o("div",{class:"stat-label"},"低风险",-1))]}),_:1})])):re("",!0),a(I,{class:"filter-card"},{default:t(()=>[o("div",Qe,[a(L,{modelValue:q.value,"onUpdate:modelValue":e[1]||(e[1]=l=>q.value=l),placeholder:"搜索标准...",clearable:"",style:{width:"300px"},onInput:pe},{prefix:t(()=>[a(b,null,{default:t(()=>[a(C(Ee))]),_:1})]),_:1},8,["modelValue"]),a(P,{modelValue:G.value,"onUpdate:modelValue":e[2]||(e[2]=l=>G.value=l),placeholder:"选择分类",clearable:"",style:{width:"200px"},onChange:V},{default:t(()=>[(_(!0),S(Me,null,Te(te.value,l=>(_(),j(x,{key:l,label:l,value:l},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),a(P,{modelValue:H.value,"onUpdate:modelValue":e[3]||(e[3]=l=>H.value=l),placeholder:"风险等级",clearable:"",style:{width:"150px"},onChange:V},{default:t(()=>[a(x,{label:"高",value:"high"}),a(x,{label:"中",value:"medium"}),a(x,{label:"低",value:"low"})]),_:1},8,["modelValue"]),a(P,{modelValue:J.value,"onUpdate:modelValue":e[4]||(e[4]=l=>J.value=l),placeholder:"适用类型",clearable:"",style:{width:"150px"},onChange:V},{default:t(()=>[a(x,{label:"合同",value:"contract"}),a(x,{label:"营销材料",value:"marketing"})]),_:1},8,["modelValue"]),a(f,{type:"primary",text:"",onClick:e[5]||(e[5]=l=>T.value=!0)},{default:t(()=>[a(b,null,{default:t(()=>[a(C($e))]),_:1}),e[27]||(e[27]=i(" 手动添加 ",-1))]),_:1})])]),_:1}),a(I,{class:"table-card"},{default:t(()=>[Be((_(),j(ue,{data:D.value,stripe:"",style:{width:"100%"}},{default:t(()=>[a(y,{prop:"category",label:"分类",width:"120"}),a(y,{prop:"item",label:"审核要点","min-width":"180"}),a(y,{prop:"description",label:"说明","min-width":"250","show-overflow-tooltip":""}),a(y,{label:"风险等级",width:"100",align:"center"},{default:t(({row:l})=>[a(Q,{type:ee(l.risk_level),size:"small"},{default:t(()=>[i(u(W(l.risk_level)),1)]),_:2},1032,["type"])]),_:1}),a(y,{label:"适用类型",width:"120"},{default:t(({row:l})=>[o("span",null,u(R(l.applicable_to)),1)]),_:1}),a(y,{prop:"usage_instruction",label:"适用说明","min-width":"200","show-overflow-tooltip":""},{default:t(({row:l})=>[l.usage_instruction?(_(),S("span",Xe,u(l.usage_instruction),1)):(_(),j(f,{key:1,type:"primary",text:"",size:"small",onClick:N=>we(l),loading:O.value.includes(l.id)},{default:t(()=>[...e[28]||(e[28]=[i(" 生成 ",-1)])]),_:1},8,["onClick","loading"]))]),_:1}),a(y,{label:"操作",width:"150",fixed:"right"},{default:t(({row:l})=>[a(f,{type:"primary",text:"",size:"small",onClick:N=>_e(l)},{default:t(()=>[...e[29]||(e[29]=[i(" 编辑 ",-1)])]),_:1},8,["onClick"]),a(f,{type:"danger",text:"",size:"small",onClick:N=>ye(l)},{default:t(()=>[...e[30]||(e[30]=[i(" 删除 ",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[Ue,X.value]]),o("div",Ye,[o("span",null,"共 "+u(D.value.length)+" 条标准",1)])]),_:1}),a(ae,{modelValue:E.value,"onUpdate:modelValue":e[8]||(e[8]=l=>E.value=l),title:"上传审核标准",width:"700px",onClose:oe},{footer:t(()=>[a(f,{onClick:e[7]||(e[7]=l=>E.value=!1)},{default:t(()=>[...e[34]||(e[34]=[i("取消",-1)])]),_:1}),k.value.length?(_(),j(f,{key:1,type:"primary",onClick:me,loading:w.value},{default:t(()=>[...e[36]||(e[36]=[i(" 确认入库 ",-1)])]),_:1},8,["loading"])):(_(),j(f,{key:0,type:"primary",onClick:fe,loading:Y.value,disabled:!M.value},{default:t(()=>[...e[35]||(e[35]=[i(" 预览 ",-1)])]),_:1},8,["loading","disabled"]))]),default:t(()=>[k.value.length?(_(),S("div",el,[a(Ce,{type:"success",closable:!1,style:{"margin-bottom":"16px"}},{default:t(()=>[i(" 解析成功，共 "+u(k.value.length)+" 条标准 ",1)]),_:1}),a(ue,{data:k.value,"max-height":"400",size:"small"},{default:t(()=>[a(y,{prop:"category",label:"分类",width:"100"}),a(y,{prop:"item",label:"审核要点",width:"150"}),a(y,{prop:"description",label:"说明","show-overflow-tooltip":""}),a(y,{label:"风险",width:"60"},{default:t(({row:l})=>[i(u(W(l.risk_level)),1)]),_:1})]),_:1},8,["data"]),o("div",ll,[a(le,{modelValue:K.value,"onUpdate:modelValue":e[6]||(e[6]=l=>K.value=l)},{default:t(()=>[...e[33]||(e[33]=[i(" 替换现有标准库（清空后导入） ",-1)])]),_:1},8,["modelValue"])])])):(_(),S("div",Ze,[a(xe,{ref:"uploadRef",drag:"","auto-upload":!1,"on-change":ce,accept:".xlsx,.xls,.csv,.docx,.md,.txt"},{tip:t(()=>[...e[31]||(e[31]=[o("div",{class:"el-upload__tip"}," 支持 Excel (.xlsx/.xls)、CSV、Word (.docx)、Markdown (.md)、文本 (.txt) 格式 ",-1)])]),default:t(()=>[a(b,{class:"el-icon--upload"},{default:t(()=>[a(C(Fe))]),_:1}),e[32]||(e[32]=o("div",{class:"el-upload__text"},[i(" 拖拽文件到此处，或 "),o("em",null,"点击上传")],-1))]),_:1},512)]))]),_:1},8,["modelValue"]),a(ae,{modelValue:T.value,"onUpdate:modelValue":e[16]||(e[16]=l=>T.value=l),title:"添加标准",width:"600px",onClose:ie},{footer:t(()=>[a(f,{onClick:e[15]||(e[15]=l=>T.value=!1)},{default:t(()=>[...e[39]||(e[39]=[i("取消",-1)])]),_:1}),a(f,{type:"primary",onClick:ge,loading:w.value},{default:t(()=>[...e[40]||(e[40]=[i(" 保存 ",-1)])]),_:1},8,["loading"])]),default:t(()=>[a(Se,{model:v,"label-width":"100px"},{default:t(()=>[a(z,{label:"分类",required:""},{default:t(()=>[a(L,{modelValue:v.category,"onUpdate:modelValue":e[9]||(e[9]=l=>v.category=l),placeholder:"如：主体资格、权利义务"},null,8,["modelValue"])]),_:1}),a(z,{label:"审核要点",required:""},{default:t(()=>[a(L,{modelValue:v.item,"onUpdate:modelValue":e[10]||(e[10]=l=>v.item=l),placeholder:"简要描述审核要点"},null,8,["modelValue"])]),_:1}),a(z,{label:"详细说明",required:""},{default:t(()=>[a(L,{modelValue:v.description,"onUpdate:modelValue":e[11]||(e[11]=l=>v.description=l),type:"textarea",rows:3,placeholder:"详细的审核说明"},null,8,["modelValue"])]),_:1}),a(z,{label:"风险等级"},{default:t(()=>[a(P,{modelValue:v.risk_level,"onUpdate:modelValue":e[12]||(e[12]=l=>v.risk_level=l),style:{width:"100%"}},{default:t(()=>[a(x,{label:"高",value:"high"}),a(x,{label:"中",value:"medium"}),a(x,{label:"低",value:"low"})]),_:1},8,["modelValue"])]),_:1}),a(z,{label:"适用类型"},{default:t(()=>[a(he,{modelValue:v.applicable_to,"onUpdate:modelValue":e[13]||(e[13]=l=>v.applicable_to=l)},{default:t(()=>[a(le,{label:"contract"},{default:t(()=>[...e[37]||(e[37]=[i("合同",-1)])]),_:1}),a(le,{label:"marketing"},{default:t(()=>[...e[38]||(e[38]=[i("营销材料",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1}),a(z,{label:"适用说明"},{default:t(()=>[a(L,{modelValue:v.usage_instruction,"onUpdate:modelValue":e[14]||(e[14]=l=>v.usage_instruction=l),type:"textarea",rows:2,placeholder:"可选，说明何时使用该标准"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),a(ae,{modelValue:$.value,"onUpdate:modelValue":e[19]||(e[19]=l=>$.value=l),title:"编辑标准",width:"800px",onClose:ne},{footer:t(()=>[a(f,{onClick:e[18]||(e[18]=l=>$.value=!1)},{default:t(()=>[...e[45]||(e[45]=[i("取消",-1)])]),_:1}),a(f,{type:"primary",onClick:ke,loading:w.value,disabled:!n.value},{default:t(()=>[...e[46]||(e[46]=[i(" 确认修改 ",-1)])]),_:1},8,["loading","disabled"])]),default:t(()=>[o("div",al,[o("div",tl,[e[41]||(e[41]=o("div",{class:"section-title"},"当前标准",-1)),a(de,{column:2,border:"",size:"small"},{default:t(()=>[a(m,{label:"分类"},{default:t(()=>{var l;return[i(u((l=d.value)==null?void 0:l.category),1)]}),_:1}),a(m,{label:"风险等级"},{default:t(()=>{var l;return[a(Q,{type:ee((l=d.value)==null?void 0:l.risk_level),size:"small"},{default:t(()=>{var N;return[i(u(W((N=d.value)==null?void 0:N.risk_level)),1)]}),_:1},8,["type"])]}),_:1}),a(m,{label:"审核要点",span:2},{default:t(()=>{var l;return[i(u((l=d.value)==null?void 0:l.item),1)]}),_:1}),a(m,{label:"详细说明",span:2},{default:t(()=>{var l;return[i(u((l=d.value)==null?void 0:l.description),1)]}),_:1}),a(m,{label:"适用类型"},{default:t(()=>{var l;return[i(u(R((l=d.value)==null?void 0:l.applicable_to)),1)]}),_:1}),a(m,{label:"适用说明"},{default:t(()=>{var l;return[i(u(((l=d.value)==null?void 0:l.usage_instruction)||"（无）"),1)]}),_:1})]),_:1})]),o("div",sl,[o("div",ol,[a(b,null,{default:t(()=>[a(C(ve))]),_:1}),e[42]||(e[42]=i(" 告诉 AI 如何修改 ",-1))]),a(L,{modelValue:h.value,"onUpdate:modelValue":e[17]||(e[17]=l=>h.value=l),type:"textarea",rows:3,placeholder:`用自然语言描述您想要的修改，例如：
• 把风险等级提高到高
• 在说明中增加关于违约金比例的要求
• 这个标准只适用于采购合同
• 让描述更加具体，包含具体的检查步骤`},null,8,["modelValue"]),o("div",il,[a(f,{type:"primary",onClick:be,loading:Z.value,disabled:!h.value.trim()},{default:t(()=>[a(b,null,{default:t(()=>[a(C(ve))]),_:1}),e[43]||(e[43]=i(" 生成修改建议 ",-1))]),_:1},8,["loading","disabled"])])]),n.value?(_(),S("div",nl,[o("div",ul,[a(b,null,{default:t(()=>[a(C(Re))]),_:1}),e[44]||(e[44]=i(" AI 修改建议 ",-1)),a(Q,{type:"info",size:"small",style:{"margin-left":"8px"}},{default:t(()=>[i(u(n.value.modification_summary),1)]),_:1})]),a(de,{column:2,border:"",size:"small"},{default:t(()=>[a(m,{label:"分类"},{default:t(()=>{var l;return[o("span",{class:A({changed:n.value.category!==((l=d.value)==null?void 0:l.category)})},u(n.value.category),3)]}),_:1}),a(m,{label:"风险等级"},{default:t(()=>{var l;return[a(Q,{type:ee(n.value.risk_level),size:"small",class:A({changed:n.value.risk_level!==((l=d.value)==null?void 0:l.risk_level)})},{default:t(()=>[i(u(W(n.value.risk_level)),1)]),_:1},8,["type","class"])]}),_:1}),a(m,{label:"审核要点",span:2},{default:t(()=>{var l;return[o("span",{class:A({changed:n.value.item!==((l=d.value)==null?void 0:l.item)})},u(n.value.item),3)]}),_:1}),a(m,{label:"详细说明",span:2},{default:t(()=>{var l;return[o("span",{class:A({changed:n.value.description!==((l=d.value)==null?void 0:l.description)})},u(n.value.description),3)]}),_:1}),a(m,{label:"适用类型"},{default:t(()=>{var l;return[o("span",{class:A({changed:R(n.value.applicable_to)!==R((l=d.value)==null?void 0:l.applicable_to)})},u(R(n.value.applicable_to)),3)]}),_:1}),a(m,{label:"适用说明"},{default:t(()=>{var l;return[o("span",{class:A({changed:n.value.usage_instruction!==((l=d.value)==null?void 0:l.usage_instruction)})},u(n.value.usage_instruction||"（无）"),3)]}),_:1})]),_:1})])):re("",!0)])]),_:1},8,["modelValue"])])}}},cl=je(dl,[["__scopeId","data-v-6c19624b"]]);export{cl as default};
