import{Z as n,R as s,$ as l,a0 as c}from"./index-CQyTNtbu.js";const d=n("review",{state:()=>({currentTask:null,tasks:[],templates:[],reviewResult:null,isReviewing:!1,progress:{stage:"idle",percentage:0,message:""},pollTimer:null,operationState:{currentOperation:null,operationStartTime:null,operationMessage:"",isLoading:!1,lastError:null,backendStatus:"unknown"}}),getters:{hasDocument:t=>{var e;return!!((e=t.currentTask)!=null&&e.document_filename)},hasStandard:t=>{var e;return!!((e=t.currentTask)!=null&&e.standard_filename)},canStartReview:t=>t.currentTask&&t.currentTask.document_filename&&t.currentTask.standard_filename&&t.currentTask.status!=="reviewing",isCompleted:t=>{var e;return((e=t.currentTask)==null?void 0:e.status)==="completed"},isFailed:t=>{var e;return((e=t.currentTask)==null?void 0:e.status)==="failed"},isOperationInProgress:t=>t.operationState.isLoading,currentOperationMessage:t=>t.operationState.operationMessage,operationError:t=>t.operationState.lastError,isBackendReady:t=>t.operationState.backendStatus==="ready"},actions:{_startOperation(t,e){this.operationState.currentOperation=t,this.operationState.operationStartTime=Date.now(),this.operationState.operationMessage=e,this.operationState.isLoading=!0,this.operationState.lastError=null},_endOperation(t=null){this.operationState.currentOperation=null,this.operationState.operationStartTime=null,this.operationState.operationMessage="",this.operationState.isLoading=!1,t&&(this.operationState.lastError=t.errorInfo||{type:"unknown",message:t.message||"操作失败",detail:null})},_updateOperationMessage(t){this.operationState.operationMessage=t},async checkBackendStatus(t){this.operationState.backendStatus="connecting",this._startOperation("checking_backend","正在检查后端服务状态...");const e=await s.warmupBackend(t);return e.success?(this.operationState.backendStatus="ready",this._endOperation(),!0):(this.operationState.backendStatus="error",this._endOperation({message:e.error}),!1)},async fetchTasks(){this._startOperation("loading_tasks","正在加载任务列表...");try{const t=await s.getTasks();this.tasks=t.data,this._endOperation()}catch(t){throw console.error("获取任务列表失败:",t),this._endOperation(t),t}},async fetchTemplates(){this._startOperation("loading_templates","正在加载审核模板...");try{const t=await s.getTemplates();this.templates=t.data,this._endOperation()}catch(t){throw console.error("获取模板列表失败:",t),this._endOperation(t),t}},async createTask(t){this._startOperation("creating_task","正在创建审阅任务...");try{const e=await s.createTask(t);return this.currentTask=e.data,this._updateOperationMessage("任务创建成功，正在刷新任务列表..."),await this.fetchTasks(),this._endOperation(),e.data}catch(e){throw console.error("创建任务失败:",e),this._endOperation(e),e}},async loadTask(t){this._startOperation("loading_task","正在加载任务详情...");try{const e=await s.getTask(t);return this.currentTask=e.data,this._endOperation(),e.data}catch(e){throw console.error("加载任务失败:",e),this._endOperation(e),e}},async deleteTask(t){var e;this._startOperation("deleting_task","正在删除任务...");try{await s.deleteTask(t),((e=this.currentTask)==null?void 0:e.id)===t&&(this.currentTask=null),await this.fetchTasks(),this._endOperation()}catch(a){throw console.error("删除任务失败:",a),this._endOperation(a),a}},async uploadDocument(t,e){this._startOperation("uploading_document",`正在上传文档: ${e.name}...`);try{await s.uploadDocument(t,e),this._updateOperationMessage("上传成功，正在刷新任务状态..."),await this.loadTask(t),this._endOperation()}catch(a){throw console.error("上传文档失败:",a),this._endOperation(a),a}},async uploadStandard(t,e){this._startOperation("uploading_standard",`正在上传审核标准: ${e.name}...`);try{await s.uploadStandard(t,e),this._updateOperationMessage("上传成功，正在刷新任务状态..."),await this.loadTask(t),this._endOperation()}catch(a){throw console.error("上传审核标准失败:",a),this._endOperation(a),a}},async useTemplate(t,e){this._startOperation("applying_template",`正在应用模板: ${e}...`);try{await s.useTemplate(t,e),this._updateOperationMessage("模板应用成功，正在刷新任务状态..."),await this.loadTask(t),this._endOperation()}catch(a){throw console.error("应用模板失败:",a),this._endOperation(a),a}},async startReview(t,e=null,a=null){var i;this._startOperation("starting_review","正在启动审阅任务...");try{this.isReviewing=!0,this.progress={stage:"analyzing",percentage:0,message:"正在启动..."};const o=l().llmProvider;await s.startReview(t,o,e,a),this._updateOperationMessage("审阅任务已启动，正在处理中..."),this._endOperation(),this.startPolling(t)}catch(r){throw this.isReviewing=!1,console.error("启动审阅失败:",r),((i=r.errorInfo)==null?void 0:i.type)==="quota_exceeded"?this._endOperation({errorInfo:{type:"quota_exceeded",message:"免费额度已用完",detail:"您的免费试用额度已全部使用完毕。如需继续使用，请联系我们获取更多额度。"}}):this._endOperation(r),r}},startPolling(t){this.pollTimer&&clearInterval(this.pollTimer);const e=async()=>{try{const a=await s.getTaskStatus(t),{status:i,message:r,progress:o}=a.data;this.progress=o,this.currentTask&&(this.currentTask.status=i,this.currentTask.message=r),i==="completed"?(this.isReviewing=!1,this.stopPolling(),await this.loadResult(t),c().refreshQuota()):i==="failed"&&(this.isReviewing=!1,this.stopPolling())}catch(a){console.error("轮询状态失败:",a)}};e(),this.pollTimer=setInterval(e,2e3)},stopPolling(){this.pollTimer&&(clearInterval(this.pollTimer),this.pollTimer=null)},async loadResult(t){try{const e=await s.getResult(t);return this.reviewResult=e.data,e.data}catch(e){throw console.error("加载结果失败:",e),e}},async updateModification(t,e,a){var i;try{if(await s.updateModification(t,e,a),(i=this.reviewResult)!=null&&i.modifications){const r=this.reviewResult.modifications.find(o=>o.id===e);r&&(a.user_modified_text!==void 0&&(r.user_modified_text=a.user_modified_text),a.user_confirmed!==void 0&&(r.user_confirmed=a.user_confirmed))}}catch(r){throw console.error("更新修改建议失败:",r),r}},async updateAction(t,e,a){var i;try{if(await s.updateAction(t,e,a),(i=this.reviewResult)!=null&&i.actions){const r=this.reviewResult.actions.find(o=>o.id===e);r&&(typeof a=="object"?Object.assign(r,a):typeof a=="boolean"&&(r.user_confirmed=a))}}catch(r){throw console.error("更新行动建议失败:",r),r}},resetState(){this.currentTask=null,this.reviewResult=null,this.isReviewing=!1,this.progress={stage:"idle",percentage:0,message:""},this.stopPolling()}}});export{d as u};
