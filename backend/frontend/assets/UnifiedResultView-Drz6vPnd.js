import{_ as Te,r as b,q as K,v as Ae,c as N,a as y,f as e,w as l,a9 as Le,J as $e,e as d,t as r,ar as He,av as Oe,aw as Pe,al as Be,am as Ne,R as Ee,g as p,b as U,ax as ze,ay as je,d as fe,N as Ve,O as Fe,P as We,az as qe,L as Ce,E as Re,F as Ge,M as Je,aA as Ke,aB as Ze,G as Qe,H as Xe,a3 as De,x as A,a4 as Ye,u as et,o as tt,a5 as de,as as ce,at as lt,y as at,K as st,k as ot,i as J,aG as nt,ad as it,aN as ut,aO as rt,m as dt,aI as ct,an as ft,n as pt,aD as mt,ah as vt,ai as _t,A as ye,aM as gt,ag as yt,h as ht,aP as bt,W as we}from"./index-BJeSEZfb.js";/* empty css                 *//* empty css                  *//* empty css                *//* empty css                 *//* empty css                         *//* empty css                   */import{D as kt,C as xt}from"./ChatPanel-CrYftxOx.js";/* empty css                     *//* empty css                  *//* empty css                 *//* empty css               */import{u as wt}from"./index-D3Dc79ak.js";const Tt={class:"result-list-view"},Et={class:"stat-value"},Vt={class:"stat-label"},Ct={class:"stat-detail"},Rt={class:"stat-value"},Dt={class:"stat-label"},Mt={class:"stat-detail"},Ut={class:"stat-value"},It={class:"stat-label"},St={class:"stat-detail"},At={class:"stat-value"},Lt={class:"stat-label"},$t={class:"stat-detail"},Ht={class:"text-ellipsis"},Ot={key:1},Pt={class:"modification-list"},Bt={class:"mod-header"},Nt={class:"mod-reason"},zt={class:"mod-actions"},jt={class:"text-label"},Ft=["innerHTML"],Wt={key:1,class:"text-box original"},qt={class:"text-label"},Gt=["innerHTML"],Jt={key:1,class:"text-box suggested"},Kt={__name:"ResultListView",props:{result:{type:Object,default:null},language:{type:String,default:"zh-CN"}},emits:["update-modification","update-action","refresh"],setup(z,{emit:ve}){const j=z,F=ve,E=b("risks"),Z=b({}),H=b(!1),O=b(!1),P=b(null),V=b({description:"",action_type:"",urgency:"normal",responsible_party:"",deadline_suggestion:""}),le=K(()=>j.language==="en"),_=K(()=>{var o;return((o=j.result)==null?void 0:o.summary)||{total_risks:0,high_risks:0,medium_risks:0,low_risks:0,total_modifications:0,must_modify:0,should_modify:0,total_actions:0,immediate_actions:0}}),u=K(()=>le.value?{materialType:{contract:"Contract",marketing:"Marketing Material"},riskLevel:{high:"High",medium:"Medium",low:"Low"},priority:{must:"Must",should:"Should",may:"May"},urgency:{immediate:"Immediate",soon:"Soon",normal:"Normal"},labels:{totalRisks:"Total Risks",highRisks:"High Risks",priorityNeeded:"Priority needed",modifications:"Modifications",actions:"Actions",risks:"Risks",highDetail:"H",mediumDetail:"M",lowDetail:"L",mustModify:"must",shouldModify:"should",immediateActions:"immediate",riskLevelCol:"Risk Level",riskType:"Risk Type",riskDescription:"Description",reason:"Reason",originalText:"Original Text",urgencyCol:"Urgency",actionType:"Action Type",specificAction:"Specific Action",responsibleParty:"Responsible Party",deadline:"Deadline",operation:"Operation",confirm:"Confirm",edit:"Edit",currentText:"Current Text",suggestedText:"Suggested Modification",save:"Save",confirmAdopt:"Confirm",diff:"Diff",fullText:"Full",noModifications:"No modification suggestions",noActions:"No action recommendations"}}:{materialType:{contract:"合同",marketing:"营销材料"},riskLevel:{high:"高",medium:"中",low:"低"},priority:{must:"必须",should:"应该",may:"可以"},urgency:{immediate:"立即",soon:"尽快",normal:"一般"},labels:{totalRisks:"风险总数",highRisks:"高风险",priorityNeeded:"需优先处理",modifications:"修改建议",actions:"行动建议",risks:"风险点",highDetail:"高",mediumDetail:"中",lowDetail:"低",mustModify:"必须",shouldModify:"应该",immediateActions:"立即处理",riskLevelCol:"风险等级",riskType:"风险类型",riskDescription:"风险描述",reason:"判定理由",originalText:"原文摘录",urgencyCol:"紧急程度",actionType:"行动类型",specificAction:"具体行动",responsibleParty:"负责方",deadline:"建议时限",operation:"操作",confirm:"确认",edit:"编辑",currentText:"当前文本",suggestedText:"建议修改为",save:"保存",confirmAdopt:"确认采纳",diff:"差异",fullText:"全文",noModifications:"无修改建议",noActions:"无行动建议"}});Ae(()=>j.result,()=>{ae()},{immediate:!0});function k(o){var i,x;if(!Z.value[o]){const v=(x=(i=j.result)==null?void 0:i.modifications)==null?void 0:x.find($=>$.id===o);Z.value[o]={showDiff:!0,isEditing:!1,editText:(v==null?void 0:v.user_modified_text)||(v==null?void 0:v.suggested_text)||""}}return Z.value[o]}function ae(){var o;(o=j.result)!=null&&o.modifications&&j.result.modifications.forEach(i=>{Z.value[i.id]||(Z.value[i.id]={showDiff:!0,isEditing:!1,editText:i.user_modified_text||i.suggested_text||""})})}function pe(o){return{high:"danger",medium:"warning",low:"info"}[o]||"info"}function ne(o){return u.value.riskLevel[o]||o}function Y(o){return{must:"danger",should:"warning",may:"info"}[o]||"info"}function ee(o){return u.value.priority[o]||o}function C(o){return{immediate:"danger",soon:"warning",normal:"info"}[o]||"info"}function ie(o){return u.value.urgency[o]||o}function ue(o,i){if(!o||!i)return{originalHtml:o||"",modifiedHtml:i||""};if(o===i)return{originalHtml:o,modifiedHtml:i};const x=s=>{const n=[];let m="",h=null;for(const R of s){const D=/[\u4e00-\u9fa5]/.test(R),c=/[a-zA-Z0-9]/.test(R),g=/\s/.test(R);let T;D?T="cn":c?T="en":g?T="space":T="punct",T==="cn"?(m&&n.push(m),n.push(R),m="",h=null):T===h&&T==="en"?m+=R:(m&&n.push(m),m=R,h=T)}return m&&n.push(m),n},v=x(o),$=x(i),W=v.length,q=$.length,w=Array(W+1).fill(null).map(()=>Array(q+1).fill(0));for(let s=1;s<=W;s++)for(let n=1;n<=q;n++)v[s-1]===$[n-1]?w[s][n]=w[s-1][n-1]+1:w[s][n]=Math.max(w[s-1][n],w[s][n-1]);const te=[];let I=W,S=q;for(;I>0&&S>0;)v[I-1]===$[S-1]?(te.unshift({origIdx:I-1,modIdx:S-1,token:v[I-1]}),I--,S--):w[I-1][S]>w[I][S-1]?I--:S--;const G=s=>s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");let Q="",B=-1;for(const s of te){for(let n=B+1;n<s.origIdx;n++)Q+=`<del class="diff-del">${G(v[n])}</del>`;Q+=G(s.token),B=s.origIdx}for(let s=B+1;s<W;s++)Q+=`<del class="diff-del">${G(v[s])}</del>`;let a="",t=-1;for(const s of te){for(let n=t+1;n<s.modIdx;n++)a+=`<ins class="diff-ins">${G($[n])}</ins>`;a+=G(s.token),t=s.modIdx}for(let s=t+1;s<q;s++)a+=`<ins class="diff-ins">${G($[s])}</ins>`;return{originalHtml:Q,modifiedHtml:a}}function L(o){const i=o.original_text||"",v=k(o.id).editText||o.user_modified_text||o.suggested_text||"";return ue(i,v)}async function _e(o){const i=k(o.id);try{F("update-modification",o.id,{user_modified_text:i.editText,user_confirmed:!0}),i.isEditing=!1,o.user_confirmed=!0,o.user_modified_text=i.editText,A.success("保存成功")}catch{A.error("保存失败")}}async function se(o,i){F("update-modification",o.id,i)}async function re(o,i){o.user_confirmed=i,F("update-action",o.id,i)}function ge(o){P.value=o.id,V.value={description:o.description||"",action_type:o.action_type||"",urgency:o.urgency||"normal",responsible_party:o.responsible_party||"",deadline_suggestion:o.deadline_suggestion||""},H.value=!0}async function me(){var o,i;O.value=!0;try{const x=(i=(o=j.result)==null?void 0:o.actions)==null?void 0:i.find(v=>v.id===P.value);x&&(Object.assign(x,V.value),x.user_confirmed=!0),F("update-action",P.value,{...V.value,user_confirmed:!0}),H.value=!1,A.success("保存成功")}catch{A.error("保存失败")}finally{O.value=!1}}return(o,i)=>{const x=$e,v=Le,$=He,W=je,q=Ee,w=Ne,te=ze,I=Be,S=Pe,G=qe,Q=Ce,B=Re,a=Ge,t=Je,s=Oe,n=Ze,m=Xe,h=Qe,R=Ke,D=De;return y(),N("div",Tt,[e($,{gutter:16,class:"stat-cards"},{default:l(()=>[e(v,{span:6},{default:l(()=>[e(x,{class:"stat-card danger"},{default:l(()=>[d("div",Et,r(_.value.total_risks),1),d("div",Vt,r(u.value.labels.totalRisks),1),d("div",Ct,r(u.value.labels.highDetail)+" "+r(_.value.high_risks)+" / "+r(u.value.labels.mediumDetail)+" "+r(_.value.medium_risks)+" / "+r(u.value.labels.lowDetail)+" "+r(_.value.low_risks),1)]),_:1})]),_:1}),e(v,{span:6},{default:l(()=>[e(x,{class:"stat-card warning"},{default:l(()=>[d("div",Rt,r(_.value.high_risks),1),d("div",Dt,r(u.value.labels.highRisks),1),d("div",Mt,r(u.value.labels.priorityNeeded),1)]),_:1})]),_:1}),e(v,{span:6},{default:l(()=>[e(x,{class:"stat-card primary"},{default:l(()=>[d("div",Ut,r(_.value.total_modifications),1),d("div",It,r(u.value.labels.modifications),1),d("div",St,r(u.value.labels.mustModify)+" "+r(_.value.must_modify)+" / "+r(u.value.labels.shouldModify)+" "+r(_.value.should_modify),1)]),_:1})]),_:1}),e(v,{span:6},{default:l(()=>[e(x,{class:"stat-card success"},{default:l(()=>[d("div",At,r(_.value.total_actions),1),d("div",Lt,r(u.value.labels.actions),1),d("div",$t,r(u.value.labels.immediateActions)+" "+r(_.value.immediate_actions),1)]),_:1})]),_:1})]),_:1}),e(x,{class:"content-card"},{default:l(()=>[e(s,{modelValue:E.value,"onUpdate:modelValue":i[0]||(i[0]=c=>E.value=c)},{default:l(()=>[e(S,{label:u.value.labels.risks,name:"risks"},{label:l(()=>{var c,g;return[d("span",null,[p(r(u.value.labels.risks)+" ",1),e(W,{value:((g=(c=z.result)==null?void 0:c.risks)==null?void 0:g.length)||0,type:"danger"},null,8,["value"])])]}),default:l(()=>{var c;return[e(I,{data:((c=z.result)==null?void 0:c.risks)||[],stripe:"",border:""},{default:l(()=>[e(w,{label:u.value.labels.riskLevelCol,width:"100",align:"center"},{default:l(({row:g})=>[e(q,{type:pe(g.risk_level)},{default:l(()=>[p(r(ne(g.risk_level)),1)]),_:2},1032,["type"])]),_:1},8,["label"]),e(w,{prop:"risk_type",label:u.value.labels.riskType,width:"120"},null,8,["label"]),e(w,{prop:"description",label:u.value.labels.riskDescription,"min-width":"200"},null,8,["label"]),e(w,{prop:"reason",label:u.value.labels.reason,"min-width":"200"},null,8,["label"]),e(w,{label:u.value.labels.originalText,width:"200"},{default:l(({row:g})=>{var T;return[(T=g.location)!=null&&T.original_text?(y(),U(te,{key:0,trigger:"hover",width:"400",placement:"top"},{reference:l(()=>[d("span",Ht,r(g.location.original_text.slice(0,50))+"... ",1)]),default:l(()=>[d("div",null,r(g.location.original_text),1)]),_:2},1024)):(y(),N("span",Ot,"-"))]}),_:1},8,["label"])]),_:1},8,["data"])]}),_:1},8,["label"]),e(S,{label:u.value.labels.modifications,name:"modifications"},{label:l(()=>{var c,g;return[d("span",null,[p(r(u.value.labels.modifications)+" ",1),e(W,{value:((g=(c=z.result)==null?void 0:c.modifications)==null?void 0:g.length)||0,type:"primary"},null,8,["value"])])]}),default:l(()=>{var c,g,T;return[d("div",Pt,[(y(!0),N(Ve,null,Fe(((c=z.result)==null?void 0:c.modifications)||[],f=>(y(),U(x,{key:f.id,class:We(["modification-card",{confirmed:f.user_confirmed}])},{default:l(()=>[d("div",Bt,[e(q,{type:Y(f.priority)},{default:l(()=>[p(r(ee(f.priority)),1)]),_:2},1032,["type"]),d("span",Nt,r(f.modification_reason),1),d("div",zt,[e(G,{modelValue:k(f.id).showDiff,"onUpdate:modelValue":M=>k(f.id).showDiff=M,"active-text":u.value.labels.diff,"inactive-text":u.value.labels.fullText,size:"small",style:{"margin-right":"12px"}},null,8,["modelValue","onUpdate:modelValue","active-text","inactive-text"]),e(Q,{modelValue:f.user_confirmed,"onUpdate:modelValue":M=>f.user_confirmed=M,onChange:M=>se(f,{user_confirmed:M})},{default:l(()=>[p(r(u.value.labels.confirmAdopt),1)]),_:1},8,["modelValue","onUpdate:modelValue","onChange"])])]),e($,{gutter:20,class:"mod-content"},{default:l(()=>[e(v,{span:12},{default:l(()=>[d("div",jt,r(u.value.labels.currentText),1),k(f.id).showDiff?(y(),N("div",{key:0,class:"text-box diff-view",innerHTML:L(f).originalHtml},null,8,Ft)):(y(),N("div",Wt,r(f.original_text),1))]),_:2},1024),e(v,{span:12},{default:l(()=>[d("div",qt,[p(r(u.value.labels.suggestedText)+" ",1),k(f.id).isEditing?(y(),U(B,{key:1,type:"success",link:"",size:"small",onClick:M=>_e(f)},{default:l(()=>[p(r(u.value.labels.save),1)]),_:1},8,["onClick"])):(y(),U(B,{key:0,type:"primary",link:"",size:"small",onClick:M=>k(f.id).isEditing=!0},{default:l(()=>[p(r(u.value.labels.edit),1)]),_:1},8,["onClick"]))]),k(f.id).showDiff&&!k(f.id).isEditing?(y(),N("div",{key:0,class:"text-box diff-view suggested",innerHTML:L(f).modifiedHtml},null,8,Gt)):k(f.id).isEditing?(y(),U(a,{key:2,type:"textarea",rows:4,modelValue:k(f.id).editText,"onUpdate:modelValue":M=>k(f.id).editText=M},null,8,["modelValue","onUpdate:modelValue"])):(y(),N("div",Jt,r(k(f.id).editText||f.suggested_text),1))]),_:2},1024)]),_:2},1024)]),_:2},1032,["class"]))),128)),(T=(g=z.result)==null?void 0:g.modifications)!=null&&T.length?fe("",!0):(y(),U(t,{key:0,description:u.value.labels.noModifications},null,8,["description"]))])]}),_:1},8,["label"]),e(S,{label:u.value.labels.actions,name:"actions"},{label:l(()=>{var c,g;return[d("span",null,[p(r(u.value.labels.actions)+" ",1),e(W,{value:((g=(c=z.result)==null?void 0:c.actions)==null?void 0:g.length)||0,type:"success"},null,8,["value"])])]}),default:l(()=>{var c,g,T;return[e(I,{data:((c=z.result)==null?void 0:c.actions)||[],stripe:"",border:""},{default:l(()=>[e(w,{label:u.value.labels.urgencyCol,width:"100",align:"center"},{default:l(({row:f})=>[e(q,{type:C(f.urgency)},{default:l(()=>[p(r(ie(f.urgency)),1)]),_:2},1032,["type"])]),_:1},8,["label"]),e(w,{prop:"action_type",label:u.value.labels.actionType,width:"120"},null,8,["label"]),e(w,{prop:"description",label:u.value.labels.specificAction,"min-width":"250"},null,8,["label"]),e(w,{prop:"responsible_party",label:u.value.labels.responsibleParty,width:"100"},null,8,["label"]),e(w,{prop:"deadline_suggestion",label:u.value.labels.deadline,width:"120"},{default:l(({row:f})=>[p(r(f.deadline_suggestion||"-"),1)]),_:1},8,["label"]),e(w,{label:u.value.labels.operation,width:"130",align:"center"},{default:l(({row:f})=>[e(Q,{modelValue:f.user_confirmed,"onUpdate:modelValue":M=>f.user_confirmed=M,onChange:M=>re(f,M),style:{"margin-right":"8px"}},{default:l(()=>[p(r(u.value.labels.confirm),1)]),_:1},8,["modelValue","onUpdate:modelValue","onChange"]),e(B,{type:"primary",link:"",size:"small",onClick:M=>ge(f)},{default:l(()=>[p(r(u.value.labels.edit),1)]),_:1},8,["onClick"])]),_:1},8,["label"])]),_:1},8,["data"]),(T=(g=z.result)==null?void 0:g.actions)!=null&&T.length?fe("",!0):(y(),U(t,{key:0,description:u.value.labels.noActions},null,8,["description"]))]}),_:1},8,["label"])]),_:1},8,["modelValue"])]),_:1}),e(D,{modelValue:H.value,"onUpdate:modelValue":i[7]||(i[7]=c=>H.value=c),title:"编辑行动建议",width:"500px","close-on-click-modal":!1},{footer:l(()=>[e(B,{onClick:i[6]||(i[6]=c=>H.value=!1)},{default:l(()=>[...i[8]||(i[8]=[p("取消",-1)])]),_:1}),e(B,{type:"primary",onClick:me,loading:O.value},{default:l(()=>[...i[9]||(i[9]=[p(" 保存 ",-1)])]),_:1},8,["loading"])]),default:l(()=>[e(R,{model:V.value,"label-width":"80px"},{default:l(()=>[e(n,{label:"具体行动"},{default:l(()=>[e(a,{modelValue:V.value.description,"onUpdate:modelValue":i[1]||(i[1]=c=>V.value.description=c),type:"textarea",rows:3,placeholder:"请输入具体行动描述"},null,8,["modelValue"])]),_:1}),e(n,{label:"行动类型"},{default:l(()=>[e(h,{modelValue:V.value.action_type,"onUpdate:modelValue":i[2]||(i[2]=c=>V.value.action_type=c),style:{width:"100%"}},{default:l(()=>[e(m,{label:"沟通协商",value:"沟通协商"}),e(m,{label:"补充材料",value:"补充材料"}),e(m,{label:"法务确认",value:"法务确认"}),e(m,{label:"内部审批",value:"内部审批"}),e(m,{label:"核实信息",value:"核实信息"})]),_:1},8,["modelValue"])]),_:1}),e(n,{label:"紧急程度"},{default:l(()=>[e(h,{modelValue:V.value.urgency,"onUpdate:modelValue":i[3]||(i[3]=c=>V.value.urgency=c),style:{width:"100%"}},{default:l(()=>[e(m,{label:"立即处理",value:"immediate"}),e(m,{label:"尽快处理",value:"soon"}),e(m,{label:"一般",value:"normal"})]),_:1},8,["modelValue"])]),_:1}),e(n,{label:"负责方"},{default:l(()=>[e(a,{modelValue:V.value.responsible_party,"onUpdate:modelValue":i[4]||(i[4]=c=>V.value.responsible_party=c),placeholder:"请输入负责方"},null,8,["modelValue"])]),_:1}),e(n,{label:"建议时限"},{default:l(()=>[e(a,{modelValue:V.value.deadline_suggestion,"onUpdate:modelValue":i[5]||(i[5]=c=>V.value.deadline_suggestion=c),placeholder:"如：签署前、3个工作日内"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}},Zt=Te(Kt,[["__scopeId","data-v-067832f2"]]),Qt={class:"unified-result-view"},Xt={class:"result-header"},Yt={class:"header-left"},el={class:"document-name"},tl={class:"header-center"},ll={class:"header-right"},al={key:0,class:"progress-info"},sl={class:"progress-text"},ol={class:"result-content"},nl={class:"content-left"},il={class:"content-right"},ul={class:"redline-dialog-content"},rl={class:"export-option"},dl={class:"option-header"},cl={class:"option-count"},fl={class:"export-option"},pl={class:"option-header"},ml={class:"option-count"},vl={key:1,class:"export-progress"},_l={class:"progress-header"},gl={__name:"UnifiedResultView",setup(z){const ve=Ye(),j=et(),F=wt(),E=K(()=>ve.params.taskId),Z=b(!1),H=b("interactive"),O=b(null),P=b(null),V=b(!1),le=b(!1),_=b([]),u=b(null),k=b([]),ae=b(""),pe=b([]),ne=b(null),Y=b(!1),ee=b(!1),C=b(null),ie=b(!1),ue=b(!1);let L=null;const _e=K(()=>{var a;return!!((a=O.value)!=null&&a.standard_filename)}),se=K(()=>_.value.find(a=>a.id===u.value)),re=K(()=>_.value.filter(a=>a.status==="completed").length),ge=K(()=>_.value.length===0?0:Math.round(re.value/_.value.length*100)),me=K(()=>{var a;return(a=P.value)!=null&&a.modifications?P.value.modifications.filter(t=>t.user_confirmed).length:0}),o=K(()=>{var a;return(a=P.value)!=null&&a.actions?P.value.actions.filter(t=>t.user_confirmed).length:0});tt(async()=>{await i()});async function i(){Z.value=!0;try{const[a,t]=await Promise.all([de.getTask(E.value),ce.getInteractiveItems(E.value)]);O.value=a.data,_.value=t.data||[],await F.loadResult(E.value),P.value=F.reviewResult,x();const s=_.value.find(n=>n.status!=="completed");s?await v(s):_.value.length>0&&await v(_.value[0])}catch(a){console.error("加载数据失败:",a),A.error("加载数据失败: "+(a.message||"请重试"))}finally{Z.value=!1}}async function x(){V.value=!0;try{const a=await ce.getDocumentText(E.value);pe.value=a.data.paragraphs||[]}catch(a){console.error("加载文档内容失败:",a)}finally{V.value=!1}}async function v(a){var t;if(u.value!==a.id){u.value=a.id,k.value=[],ae.value=a.current_suggestion||a.suggested_text||"";try{const n=(await ce.getItemDetail(E.value,a.id)).data;k.value=n.messages||[],ae.value=n.current_suggestion||a.suggested_text||"";const m=_.value.find(h=>h.id===a.id);m&&(m.status=n.status,m.message_count=((t=n.messages)==null?void 0:t.length)||0)}catch(s){console.error("加载条目详情失败:",s),k.value=a.messages||[]}}}function $(){var a;ne.value&&((a=se.value)!=null&&a.original_text)&&ne.value.scrollToText(se.value.original_text)}async function W(a){if(!(!u.value||le.value)){k.value.push({role:"user",content:a,timestamp:new Date().toISOString()}),le.value=!0;try{const s=(await ce.sendChatMessage(E.value,u.value,a,"deepseek")).data;k.value.push({role:"assistant",content:s.assistant_reply,timestamp:new Date().toISOString(),suggestion_snapshot:s.updated_suggestion}),ae.value=s.updated_suggestion;const n=_.value.find(m=>m.id===u.value);n&&(n.status="in_progress",n.current_suggestion=s.updated_suggestion,n.message_count=k.value.length)}catch(t){console.error("发送消息失败:",t),A.error("发送消息失败: "+(t.message||"请重试")),k.value.pop()}finally{le.value=!1}}}async function q(a){if(u.value)try{await ce.completeItem(E.value,u.value,a);const t=_.value.find(n=>n.id===u.value);t&&(t.status="completed",t.current_suggestion=a),A.success("条目已确认");const s=_.value.find(n=>n.status!=="completed");s?await v(s):we.confirm("恭喜！所有条目已审阅完成。是否导出结果？","审阅完成",{confirmButtonText:"导出 Word",cancelButtonText:"稍后导出",type:"success"}).then(()=>{I("word")}).catch(()=>{})}catch(t){console.error("完成条目失败:",t),A.error("完成条目失败: "+(t.message||"请重试"))}}async function w(a,t){try{await F.updateModification(E.value,a,t)}catch{A.error("更新失败")}}async function te(a,t){try{typeof t=="boolean"?await F.updateAction(E.value,a,t):await F.updateAction(E.value,a,t)}catch{A.error("更新失败")}}async function I(a){var t,s;if(a==="word")Y.value=!0,C.value=null;else if(a==="json"){const n={task_id:E.value,document_name:(t=O.value)==null?void 0:t.document_filename,exported_at:new Date().toISOString(),items:_.value.map(D=>({id:D.id,type:D.item_type,priority:D.priority,original_text:D.original_text,final_suggestion:D.current_suggestion,status:D.status,risk_description:D.risk_description||D.modification_reason}))},m=new Blob([JSON.stringify(n,null,2)],{type:"application/json"}),h=window.URL.createObjectURL(m),R=document.createElement("a");R.href=h,R.download=`${((s=O.value)==null?void 0:s.document_filename)||"result"}_审阅结果.json`,R.click(),window.URL.revokeObjectURL(h),A.success("导出成功")}else if(a==="excel"){const n=de.exportExcel(E.value);n&&window.open(n,"_blank")}}async function S(){ee.value=!0,C.value={status:"pending",progress:0,message:"正在启动导出..."};try{const a=await de.startRedlineExport(E.value,null,ue.value);C.value=a.data,L&&clearInterval(L),L=setInterval(G,1e3)}catch(a){console.error("启动导出失败:",a),C.value={status:"failed",progress:0,message:"启动失败",error:a.message},ee.value=!1}}async function G(){try{const a=await de.getRedlineExportStatus(E.value);C.value=a.data,(a.data.status==="completed"||a.data.status==="failed")&&(L&&(clearInterval(L),L=null),ee.value=!1)}catch(a){console.error("获取导出状态失败:",a)}}async function Q(){ie.value=!0;try{const a=await de.downloadRedlineExport(E.value),t=a.headers["content-disposition"];let s="document_redline.docx";if(t){const R=t.match(/filename\*=UTF-8''([^;\s]+)/);if(R)s=decodeURIComponent(R[1]);else{const D=t.match(/filename="?([^"]+)"?/);D&&(s=D[1])}}const n=new Blob([a.data],{type:"application/vnd.openxmlformats-officedocument.wordprocessingml.document"}),m=window.URL.createObjectURL(n),h=document.createElement("a");h.href=m,h.download=s,document.body.appendChild(h),h.click(),document.body.removeChild(h),window.URL.revokeObjectURL(m),A.success("文件下载成功"),Y.value=!1}catch(a){console.error("下载失败:",a),A.error(a.message||"下载失败，请重试")}finally{ie.value=!1}}function B(){H.value==="interactive"&&re.value<_.value.length?we.confirm("还有未完成的条目，确定要离开吗？","确认离开",{confirmButtonText:"离开",cancelButtonText:"继续审阅",type:"warning"}).then(()=>{j.push("/")}).catch(()=>{}):j.push("/")}return lt(()=>{L&&(clearInterval(L),L=null)}),(a,t)=>{var he,be,ke,xe;const s=ot,n=Re,m=it,h=Ee,R=ut,D=ct,c=ft,g=_t,T=vt,f=yt,M=ht,Me=Ce,Ue=De,Ie=st;return at((y(),N("div",Qt,[d("div",Xt,[d("div",Yt,[e(n,{text:"",onClick:B},{default:l(()=>[e(s,null,{default:l(()=>[e(J(nt))]),_:1}),t[4]||(t[4]=p(" 返回 ",-1))]),_:1}),e(m,{direction:"vertical"}),d("span",el,r(((he=O.value)==null?void 0:he.document_filename)||"审阅结果"),1),_e.value?(y(),U(h,{key:0,type:"success",size:"small"},{default:l(()=>[...t[5]||(t[5]=[p("已应用标准",-1)])]),_:1})):(y(),U(h,{key:1,type:"info",size:"small"},{default:l(()=>[...t[6]||(t[6]=[p("AI 自主审阅",-1)])]),_:1}))]),d("div",tl,[e(D,{modelValue:H.value,"onUpdate:modelValue":t[0]||(t[0]=X=>H.value=X),size:"small"},{default:l(()=>[e(R,{value:"interactive"},{default:l(()=>[e(s,null,{default:l(()=>[e(J(rt))]),_:1}),t[7]||(t[7]=p(" 交互视图 ",-1))]),_:1}),e(R,{value:"list"},{default:l(()=>[e(s,null,{default:l(()=>[e(J(dt))]),_:1}),t[8]||(t[8]=p(" 列表视图 ",-1))]),_:1})]),_:1},8,["modelValue"])]),d("div",ll,[H.value==="interactive"?(y(),N("div",al,[e(c,{percentage:ge.value,"stroke-width":8,style:{width:"120px"}},null,8,["percentage"]),d("span",sl,r(re.value)+"/"+r(_.value.length),1)])):fe("",!0),e(f,{trigger:"click",onCommand:I},{dropdown:l(()=>[e(T,null,{default:l(()=>[e(g,{command:"word"},{default:l(()=>[e(s,null,{default:l(()=>[e(J(ye))]),_:1}),t[10]||(t[10]=p(" 导出 Word（修订版） ",-1))]),_:1}),e(g,{command:"json"},{default:l(()=>[e(s,null,{default:l(()=>[e(J(gt))]),_:1}),t[11]||(t[11]=p(" 导出 JSON ",-1))]),_:1}),e(g,{command:"excel"},{default:l(()=>[e(s,null,{default:l(()=>[e(J(ye))]),_:1}),t[12]||(t[12]=p(" 导出 Excel ",-1))]),_:1})]),_:1})]),default:l(()=>[e(n,{type:"primary"},{default:l(()=>[e(s,null,{default:l(()=>[e(J(pt))]),_:1}),t[9]||(t[9]=p(" 导出 ",-1)),e(s,{class:"el-icon--right"},{default:l(()=>[e(J(mt))]),_:1})]),_:1})]),_:1})])]),d("div",ol,[H.value==="interactive"?(y(),N(Ve,{key:0},[d("div",nl,[e(kt,{ref_key:"documentViewerRef",ref:ne,"document-name":(be=O.value)==null?void 0:be.document_filename,paragraphs:pe.value,"highlight-text":(ke=se.value)==null?void 0:ke.original_text,loading:V.value},null,8,["document-name","paragraphs","highlight-text","loading"])]),d("div",il,[e(xt,{items:_.value,"active-item":se.value,messages:k.value,"current-suggestion":ae.value,loading:le.value,onSelectItem:v,onSendMessage:W,onComplete:q,onLocate:$},null,8,["items","active-item","messages","current-suggestion","loading"])])],64)):(y(),U(Zt,{key:1,result:P.value,language:((xe=O.value)==null?void 0:xe.language)||"zh-CN",onUpdateModification:w,onUpdateAction:te,onRefresh:i},null,8,["result","language"]))]),e(Ue,{modelValue:Y.value,"onUpdate:modelValue":t[3]||(t[3]=X=>Y.value=X),title:"导出修订版 Word",width:"500px"},{footer:l(()=>{var X;return[e(n,{onClick:t[2]||(t[2]=oe=>Y.value=!1)},{default:l(()=>{var oe;return[p(r(((oe=C.value)==null?void 0:oe.status)==="completed"?"关闭":"取消"),1)]}),_:1}),((X=C.value)==null?void 0:X.status)==="completed"?(y(),U(n,{key:0,type:"success",onClick:Q,loading:ie.value},{default:l(()=>[...t[22]||(t[22]=[p(" 下载文件 ",-1)])]),_:1},8,["loading"])):(y(),U(n,{key:1,type:"primary",onClick:S,loading:ee.value,disabled:me.value===0&&o.value===0},{default:l(()=>[p(r(ee.value?"正在导出...":"开始导出"),1)]),_:1},8,["loading","disabled"]))]}),default:l(()=>{var X,oe;return[d("div",ul,[C.value?fe("",!0):(y(),U(M,{key:0,title:"提示：生成修订版文档预计需要 2-3 分钟，请耐心等待",type:"info","show-icon":"",closable:!1,style:{"margin-bottom":"16px"}})),d("div",rl,[d("div",dl,[e(s,null,{default:l(()=>[e(J(ye))]),_:1}),t[13]||(t[13]=d("span",null,"修改建议（修订标记）",-1))]),t[15]||(t[15]=d("div",{class:"option-desc"}," 将已确认的修改建议以删除线和插入标记形式显示 ",-1)),d("div",cl,[t[14]||(t[14]=p(" 已确认 ",-1)),d("strong",null,r(me.value),1),p(" 条 / 共 "+r(((oe=(X=P.value)==null?void 0:X.modifications)==null?void 0:oe.length)||0)+" 条 ",1)])]),e(m),d("div",fl,[d("div",pl,[e(Me,{modelValue:ue.value,"onUpdate:modelValue":t[1]||(t[1]=Se=>ue.value=Se)},{default:l(()=>[e(s,null,{default:l(()=>[e(J(bt))]),_:1}),t[16]||(t[16]=d("span",null,"行动建议（批注）",-1))]),_:1},8,["modelValue"])]),t[19]||(t[19]=d("div",{class:"option-desc"}," 将已确认的行动建议作为批注添加到对应风险点的文本位置 ",-1)),d("div",ml,[t[17]||(t[17]=p(" 已确认 ",-1)),d("strong",null,r(o.value),1),t[18]||(t[18]=p(" 条 ",-1))])]),C.value?(y(),N("div",vl,[e(m),d("div",_l,[d("span",null,r(C.value.message),1),C.value.status==="completed"?(y(),U(h,{key:0,type:"success",size:"small"},{default:l(()=>[...t[20]||(t[20]=[p("完成",-1)])]),_:1})):C.value.status==="failed"?(y(),U(h,{key:1,type:"danger",size:"small"},{default:l(()=>[...t[21]||(t[21]=[p("失败",-1)])]),_:1})):(y(),U(h,{key:2,type:"info",size:"small"},{default:l(()=>[p(r(C.value.progress)+"%",1)]),_:1}))]),e(c,{percentage:C.value.progress,status:C.value.status==="completed"?"success":C.value.status==="failed"?"exception":"","stroke-width":10,style:{"margin-top":"8px"}},null,8,["percentage","status"])])):fe("",!0)])]}),_:1},8,["modelValue"])])),[[Ie,Z.value]])}}},Ul=Te(gl,[["__scopeId","data-v-842d5855"]]);export{Ul as default};
