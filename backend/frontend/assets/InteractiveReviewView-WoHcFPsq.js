import{_ as J,r as I,q as U,v as q,a as T,c as x,b as m,f as a,g as e,h as b,w as n,i as r,A as Z,t as S,d as H,e as M,G as Y,H as X,I as A,C as re,a8 as K,a9 as he,K as ye,l as ue,aa as de,ab as F,y as me,ac as oe,a2 as ge,V as we,J as G,S as xe,k as ke,a7 as le,ad as Ie,ae as be,B as $e,E as L,Q as Te,u as Ce,o as Re,R as ie,Y as E,x as Se,a5 as Be,n as ze,af as Ve,N as ce}from"./index-CQyTNtbu.js";const Le={class:"document-header"},Me={class:"document-title"},De={class:"paragraph-count"},Oe=["id"],je={class:"para-number"},Ne={class:"para-text"},Ee={key:1,class:"loading-state"},Ue={__name:"DocumentViewer",props:{documentName:{type:String,default:""},paragraphs:{type:Array,default:()=>[]},highlightText:{type:String,default:""},loading:{type:Boolean,default:!1}},setup(s,{expose:O}){const d=s,p=I(null),g=I(null),y=I(-1),$=U(()=>{if(!d.highlightText||d.paragraphs.length===0)return-1;const c=d.highlightText.slice(0,80);let u=d.paragraphs.findIndex(v=>v.text.includes(c));if(u===-1&&c.length>40){const v=c.slice(0,40);u=d.paragraphs.findIndex(l=>l.text.includes(v))}if(u===-1&&c.length>20){const v=c.slice(0,20);u=d.paragraphs.findIndex(l=>l.text.includes(v))}return u});function C(){$.value!==-1&&K(()=>{const c=document.getElementById(`para-${$.value}`);c&&g.value&&(c.scrollIntoView({behavior:"smooth",block:"center"}),y.value=$.value,setTimeout(()=>{y.value=-1},2e3))})}function _(c){if(!c||d.paragraphs.length===0)return!1;const u=c.slice(0,80);let v=d.paragraphs.findIndex(l=>l.text.includes(u));if(v===-1&&u.length>40){const l=u.slice(0,40);v=d.paragraphs.findIndex(t=>t.text.includes(l))}return v===-1?!1:(K(()=>{const l=document.getElementById(`para-${v}`);l&&(l.scrollIntoView({behavior:"smooth",block:"center"}),y.value=v,setTimeout(()=>{y.value=-1},2e3))}),!0)}return q(()=>d.highlightText,c=>{c&&C()}),O({scrollToHighlight:C,scrollToText:_}),(c,u)=>{const v=T("el-icon"),l=T("el-empty");return m(),x("div",{class:"document-viewer",ref_key:"containerRef",ref:p},[a("div",Le,[a("h3",Me,[e(v,null,{default:n(()=>[e(r(Z))]),_:1}),b(" "+S(s.documentName||"合同文档"),1)]),a("span",De,"共 "+S(s.paragraphs.length)+" 段",1)]),a("div",{class:"document-content",ref_key:"contentRef",ref:g},[(m(!0),x(Y,null,X(s.paragraphs,t=>(m(),x("div",{key:t.index,id:`para-${t.index}`,class:A(["paragraph",{highlighted:$.value===t.index,pulse:y.value===t.index}])},[a("span",je,S(t.index+1),1),a("span",Ne,S(t.text),1)],10,Oe))),128)),s.paragraphs.length===0&&!s.loading?(m(),H(l,{key:0,description:"暂无文档内容"})):M("",!0),s.loading?(m(),x("div",Ee,[e(v,{class:"is-loading",size:32},{default:n(()=>[e(r(re))]),_:1}),u[0]||(u[0]=a("span",null,"正在加载文档...",-1))])):M("",!0)],512)],512)}}},Ae=J(Ue,[["__scopeId","data-v-ac022b6e"]]),He={class:"message-avatar"},Pe={class:"message-content"},qe={class:"message-header"},Ke={class:"message-sender"},Je={class:"message-time"},We=["innerHTML"],Qe={key:0,class:"suggestion-snapshot"},Fe={class:"snapshot-header"},Ge={class:"snapshot-content"},Ye={__name:"ChatMessage",props:{message:{type:Object,required:!0},compact:{type:Boolean,default:!1}},emits:["copy-suggestion"],setup(s){function O(p){return p?new Date(p).toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}):""}function d(p){return p?p.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br>").replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>").replace(/\*(.+?)\*/g,"<em>$1</em>").replace(/`([^`]+)`/g,"<code>$1</code>"):""}return(p,g)=>{const y=T("el-icon"),$=T("el-button");return m(),x("div",{class:A(["chat-message",[s.message.role,{"has-suggestion":s.message.suggestion_snapshot,compact:s.compact}]])},[a("div",He,[s.message.role==="assistant"?(m(),H(y,{key:0,size:s.compact?18:24,color:"#409eff"},{default:n(()=>[e(r(he))]),_:1},8,["size"])):(m(),H(y,{key:1,size:s.compact?18:24,color:"#67c23a"},{default:n(()=>[e(r(ye))]),_:1},8,["size"]))]),a("div",Pe,[a("div",qe,[a("span",Ke,S(s.message.role==="assistant"?"AI 助手":"您"),1),a("span",Je,S(O(s.message.timestamp)),1)]),a("div",{class:"message-body",innerHTML:d(s.message.content)},null,8,We),s.message.role==="assistant"&&s.message.suggestion_snapshot?(m(),x("div",Qe,[a("div",Fe,[e(y,null,{default:n(()=>[e(r(ue))]),_:1}),g[2]||(g[2]=a("span",null,"当前修改建议",-1)),e($,{type:"primary",text:"",size:"small",onClick:g[0]||(g[0]=C=>p.$emit("copy-suggestion",s.message.suggestion_snapshot))},{default:n(()=>[e(y,null,{default:n(()=>[e(r(de))]),_:1}),g[1]||(g[1]=b(" 复制 ",-1))]),_:1})]),a("div",Ge,S(s.message.suggestion_snapshot),1)])):M("",!0)])],2)}}},Xe=J(Ye,[["__scopeId","data-v-03adec10"]]),Ze={class:"chat-panel"},et=["onClick"],tt={class:"tab-number"},st={key:0,class:"item-info"},at={class:"comparison-content"},nt={class:"comparison-item original"},ot={class:"comparison-label"},lt={class:"comparison-text"},it={class:"comparison-arrow"},ct={class:"comparison-item suggestion"},rt={class:"comparison-label"},ut={class:"comparison-text"},dt={key:0,class:"risk-hint"},mt={key:0,class:"empty-chat"},gt={key:1,class:"loading-message"},vt={key:1,class:"input-area"},ft={class:"quick-actions"},pt={class:"input-row"},_t={class:"action-row"},ht={class:"action-right"},yt={key:0,class:"completed-hint"},wt={key:2,class:"empty-state"},xt={__name:"ChatPanel",props:{items:{type:Array,default:()=>[]},activeItem:{type:Object,default:null},messages:{type:Array,default:()=>[]},currentSuggestion:{type:String,default:""},loading:{type:Boolean,default:!1}},emits:["select-item","send-message","complete","locate"],setup(s,{emit:O}){const d=s,p=O,g=I(""),y=I(!1),$=I(null),C=I(null);function _(){K(()=>{$.value&&($.value.scrollTop=$.value.scrollHeight)})}q(()=>d.messages.length,_),q(()=>d.loading,_),q(()=>{var l;return(l=d.activeItem)==null?void 0:l.id},()=>{K(()=>{if(C.value&&d.activeItem){const l=C.value.querySelector(".item-tab.active");l&&l.scrollIntoView({behavior:"smooth",block:"nearest",inline:"center"})}})});function c(){!g.value.trim()||d.loading||(p("send-message",g.value.trim()),g.value="")}function u(l){var t;d.loading||((t=d.activeItem)==null?void 0:t.status)==="completed"||p("send-message",l)}function v(){const l=d.currentSuggestion;l&&navigator.clipboard.writeText(l).then(()=>{L.success("已复制")}).catch(()=>{L.error("复制失败")})}return(l,t)=>{const w=T("el-icon"),B=T("el-button"),W=T("el-input"),Q=T("el-empty");return m(),x("div",Ze,[a("div",{class:"item-tabs",ref_key:"tabsRef",ref:C},[(m(!0),x(Y,null,X(s.items,(k,D)=>{var P;return m(),x("div",{key:k.id,class:A(["item-tab",{active:k.id===((P=s.activeItem)==null?void 0:P.id),completed:k.status==="completed","in-progress":k.status==="in_progress"}]),onClick:ee=>l.$emit("select-item",k)},[a("span",tt,S(D+1),1),k.status==="completed"?(m(),H(w,{key:0,class:"tab-icon",size:12},{default:n(()=>[e(r(F))]),_:1})):M("",!0)],10,et)}),128))],512),s.activeItem?(m(),x("div",st,[a("div",{class:A(["comparison-section",{collapsed:y.value}])},[a("div",{class:"comparison-header",onClick:t[0]||(t[0]=k=>y.value=!y.value)},[a("span",null,[e(w,null,{default:n(()=>[e(r(oe))]),_:1}),t[7]||(t[7]=b(" 条款对比 ",-1))]),e(w,{class:A({rotated:!y.value})},{default:n(()=>[e(r(ge))]),_:1},8,["class"])]),me(a("div",at,[a("div",nt,[a("div",ot,[e(w,null,{default:n(()=>[e(r(Z))]),_:1}),t[8]||(t[8]=b(" 原文 ",-1))]),a("div",lt,S(s.activeItem.original_text),1)]),a("div",it,[e(w,null,{default:n(()=>[e(r(oe))]),_:1})]),a("div",ct,[a("div",rt,[e(w,null,{default:n(()=>[e(r(ue))]),_:1}),t[9]||(t[9]=b(" 建议 ",-1)),e(B,{type:"primary",text:"",size:"small",onClick:G(v,["stop"])},{default:n(()=>[e(w,null,{default:n(()=>[e(r(de))]),_:1})]),_:1})]),a("div",ut,S(s.currentSuggestion),1)])],512),[[we,!y.value]]),s.activeItem.risk_description||s.activeItem.modification_reason?(m(),x("div",dt,[e(w,null,{default:n(()=>[e(r(xe))]),_:1}),a("span",null,S(s.activeItem.risk_description||s.activeItem.modification_reason),1)])):M("",!0)],2)])):M("",!0),a("div",{class:"chat-history",ref_key:"chatHistoryRef",ref:$},[s.messages.length===0&&!s.loading?(m(),x("div",mt,[e(w,{size:32},{default:n(()=>[e(r(ke))]),_:1}),t[10]||(t[10]=a("span",null,"开始与 AI 讨论这个条款",-1))])):M("",!0),(m(!0),x(Y,null,X(s.messages,(k,D)=>(m(),H(Xe,{key:D,message:k,compact:"",onCopySuggestion:v},null,8,["message"]))),128)),s.loading?(m(),x("div",gt,[e(w,{class:"is-loading",size:16},{default:n(()=>[e(r(re))]),_:1}),t[11]||(t[11]=a("span",null,"AI 思考中...",-1))])):M("",!0)],512),s.activeItem?(m(),x("div",vt,[a("div",ft,[e(B,{size:"small",onClick:t[1]||(t[1]=k=>u("同意这个建议"))},{default:n(()=>[e(w,null,{default:n(()=>[e(r(F))]),_:1}),t[12]||(t[12]=b(" 同意 ",-1))]),_:1}),e(B,{size:"small",onClick:t[2]||(t[2]=k=>u("请解释一下为什么这样修改"))},{default:n(()=>[...t[13]||(t[13]=[b(" 请解释 ",-1)])]),_:1}),e(B,{size:"small",onClick:t[3]||(t[3]=k=>u("这个建议太保守了"))},{default:n(()=>[...t[14]||(t[14]=[b(" 更激进 ",-1)])]),_:1})]),a("div",pt,[e(W,{modelValue:g.value,"onUpdate:modelValue":t[4]||(t[4]=k=>g.value=k),type:"textarea",rows:2,autosize:{minRows:2,maxRows:4},placeholder:"输入您的意见...",onKeydown:[le(G(c,["ctrl"]),["enter"]),le(G(c,["meta"]),["enter"])],disabled:s.loading||s.activeItem.status==="completed"},null,8,["modelValue","onKeydown","disabled"])]),a("div",_t,[e(B,{onClick:t[5]||(t[5]=k=>l.$emit("locate")),disabled:!s.activeItem},{default:n(()=>[e(w,null,{default:n(()=>[e(r(Ie))]),_:1}),t[15]||(t[15]=b(" 定位原文 ",-1))]),_:1},8,["disabled"]),a("div",ht,[e(B,{type:"primary",loading:s.loading,disabled:!g.value.trim()||s.activeItem.status==="completed",onClick:c},{default:n(()=>[e(w,null,{default:n(()=>[e(r(be))]),_:1}),t[16]||(t[16]=b(" 发送 ",-1))]),_:1},8,["loading","disabled"]),e(B,{type:"success",disabled:s.loading||s.activeItem.status==="completed",onClick:t[6]||(t[6]=k=>l.$emit("complete",s.currentSuggestion))},{default:n(()=>[e(w,null,{default:n(()=>[e(r(F))]),_:1}),t[17]||(t[17]=b(" 确认 ",-1))]),_:1},8,["disabled"])])]),s.activeItem.status==="completed"?(m(),x("div",yt,[e(w,null,{default:n(()=>[e(r($e))]),_:1}),t[18]||(t[18]=b(" 此条目已完成 ",-1))])):M("",!0)])):(m(),x("div",wt,[e(Q,{description:"请从上方选择条目开始审阅"})]))])}}},kt=J(xt,[["__scopeId","data-v-668cc032"]]),It={class:"interactive-review-view"},bt={class:"review-header"},$t={class:"header-left"},Tt={class:"document-name"},Ct={class:"header-center"},Rt={class:"progress-text"},St={class:"header-right"},Bt={class:"review-content"},zt={class:"content-left"},Vt={class:"content-right"},Lt={__name:"InteractiveReviewView",setup(s){const O=Te(),d=Ce(),p=U(()=>O.params.taskId),g=I(!1),y=I(!1),$=I(!1),C=I(null),_=I([]),c=I(null),u=I([]),v=I(""),l=I([]),t=I(null),w=U(()=>_.value.find(o=>o.id===c.value)),B=U(()=>_.value.filter(o=>o.status==="completed").length),W=U(()=>_.value.length===0?0:Math.round(B.value/_.value.length*100));Re(async()=>{await Q()});async function Q(){g.value=!0;try{const[o,i]=await Promise.all([ie.getTask(p.value),E.getInteractiveItems(p.value)]);C.value=o.data,_.value=i.data||[],k();const f=_.value.find(h=>h.status!=="completed");f?await D(f):_.value.length>0&&await D(_.value[0])}catch(o){console.error("加载数据失败:",o),L.error("加载数据失败: "+(o.message||"请重试"))}finally{g.value=!1}}async function k(){y.value=!0;try{const o=await E.getDocumentText(p.value);l.value=o.data.paragraphs||[]}catch(o){console.error("加载文档内容失败:",o)}finally{y.value=!1}}async function D(o){var i;if(c.value!==o.id){c.value=o.id,u.value=[],v.value=o.current_suggestion||o.suggested_text||"";try{const h=(await E.getItemDetail(p.value,o.id)).data;u.value=h.messages||[],v.value=h.current_suggestion||o.suggested_text||"";const R=_.value.find(j=>j.id===o.id);R&&(R.status=h.status,R.message_count=((i=h.messages)==null?void 0:i.length)||0)}catch(f){console.error("加载条目详情失败:",f),u.value=o.messages||[]}}}function P(){var o;t.value&&((o=w.value)!=null&&o.original_text)&&t.value.scrollToText(w.value.original_text)}async function ee(o){if(!(!c.value||$.value)){u.value.push({role:"user",content:o,timestamp:new Date().toISOString()}),$.value=!0;try{const f=(await E.sendChatMessage(p.value,c.value,o,"deepseek")).data;u.value.push({role:"assistant",content:f.assistant_reply,timestamp:new Date().toISOString(),suggestion_snapshot:f.updated_suggestion}),v.value=f.updated_suggestion;const h=_.value.find(R=>R.id===c.value);h&&(h.status="in_progress",h.current_suggestion=f.updated_suggestion,h.message_count=u.value.length)}catch(i){console.error("发送消息失败:",i),L.error("发送消息失败: "+(i.message||"请重试")),u.value.pop()}finally{$.value=!1}}}async function ve(o){if(c.value)try{await E.completeItem(p.value,c.value,o);const i=_.value.find(h=>h.id===c.value);i&&(i.status="completed",i.current_suggestion=o),L.success("条目已确认");const f=_.value.find(h=>h.status!=="completed");f?await D(f):ce.confirm("恭喜！所有条目已审阅完成。是否导出结果？","审阅完成",{confirmButtonText:"导出 Word",cancelButtonText:"稍后导出",type:"success"}).then(()=>{te("word")}).catch(()=>{})}catch(i){console.error("完成条目失败:",i),L.error("完成条目失败: "+(i.message||"请重试"))}}async function te(o){var i,f,h;if(o==="word")try{L.info("正在生成修订版 Word 文档...");const R=await ie.exportRedline(p.value),j=new Blob([R.data],{type:"application/vnd.openxmlformats-officedocument.wordprocessingml.document"}),N=window.URL.createObjectURL(j),z=document.createElement("a");z.href=N,z.download=`${((i=C.value)==null?void 0:i.document_filename)||"result"}_修订版.docx`,z.click(),window.URL.revokeObjectURL(N),L.success("导出成功")}catch(R){console.error("导出失败:",R),L.error("导出失败: "+(R.message||"请重试"))}else if(o==="json"){const R={task_id:p.value,document_name:(f=C.value)==null?void 0:f.document_filename,exported_at:new Date().toISOString(),items:_.value.map(V=>({id:V.id,type:V.item_type,priority:V.priority,original_text:V.original_text,final_suggestion:V.current_suggestion,status:V.status,risk_description:V.risk_description||V.modification_reason}))},j=new Blob([JSON.stringify(R,null,2)],{type:"application/json"}),N=window.URL.createObjectURL(j),z=document.createElement("a");z.href=N,z.download=`${((h=C.value)==null?void 0:h.document_filename)||"result"}_审阅结果.json`,z.click(),window.URL.revokeObjectURL(N),L.success("导出成功")}}function fe(){B.value<_.value.length?ce.confirm("还有未完成的条目，确定要离开吗？","确认离开",{confirmButtonText:"离开",cancelButtonText:"继续审阅",type:"warning"}).then(()=>{d.push("/")}).catch(()=>{}):d.push("/")}return(o,i)=>{var se,ae,ne;const f=T("el-icon"),h=T("el-button"),R=T("el-divider"),j=T("el-tag"),N=T("el-progress"),z=T("el-dropdown-item"),V=T("el-dropdown-menu"),pe=T("el-dropdown"),_e=Se("loading");return m(),x("div",It,[a("div",bt,[a("div",$t,[e(h,{text:"",onClick:fe},{default:n(()=>[e(f,null,{default:n(()=>[e(r(Be))]),_:1}),i[0]||(i[0]=b(" 返回 ",-1))]),_:1}),e(R,{direction:"vertical"}),a("span",Tt,S(((se=C.value)==null?void 0:se.document_filename)||"深度交互审阅"),1),e(j,{type:"success",size:"small"},{default:n(()=>[...i[1]||(i[1]=[b("交互模式",-1)])]),_:1})]),a("div",Ct,[e(N,{percentage:W.value,"stroke-width":8,style:{width:"200px"}},null,8,["percentage"]),a("span",Rt,S(B.value)+"/"+S(_.value.length)+" 已完成",1)]),a("div",St,[e(pe,{trigger:"click",onCommand:te},{dropdown:n(()=>[e(V,null,{default:n(()=>[e(z,{command:"word"},{default:n(()=>[e(f,null,{default:n(()=>[e(r(Z))]),_:1}),i[3]||(i[3]=b(" 导出 Word（修订版） ",-1))]),_:1}),e(z,{command:"json"},{default:n(()=>[e(f,null,{default:n(()=>[e(r(Ve))]),_:1}),i[4]||(i[4]=b(" 导出 JSON ",-1))]),_:1})]),_:1})]),default:n(()=>[e(h,{type:"primary",disabled:B.value===0},{default:n(()=>[e(f,null,{default:n(()=>[e(r(ze))]),_:1}),i[2]||(i[2]=b(" 导出 ",-1)),e(f,{class:"el-icon--right"},{default:n(()=>[e(r(ge))]),_:1})]),_:1},8,["disabled"])]),_:1})])]),me((m(),x("div",Bt,[a("div",zt,[e(Ae,{ref_key:"documentViewerRef",ref:t,"document-name":(ae=C.value)==null?void 0:ae.document_filename,paragraphs:l.value,"highlight-text":(ne=w.value)==null?void 0:ne.original_text,loading:y.value},null,8,["document-name","paragraphs","highlight-text","loading"])]),a("div",Vt,[e(kt,{items:_.value,"active-item":w.value,messages:u.value,"current-suggestion":v.value,loading:$.value,onSelectItem:D,onSendMessage:ee,onComplete:ve,onLocate:P},null,8,["items","active-item","messages","current-suggestion","loading"])])])),[[_e,g.value]])])}}},Dt=J(Lt,[["__scopeId","data-v-46698eea"]]);export{Dt as default};
