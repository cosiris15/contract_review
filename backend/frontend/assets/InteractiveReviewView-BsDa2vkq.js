import{_ as we,a4 as ye,u as xe,q as I,r as p,o as Ie,at as ke,a5 as K,as as w,x as d,c as M,a as L,f as u,e as r,y as be,w as _,d as Y,k as Ce,i as k,C as Z,a7 as Re,g as P,aG as ee,t as N,a0 as Se,$ as Te,n as Ee,ah as $e,ai as Be,A as De,aM as Me,ag as Le,K as Pe,W as O}from"./index-vDZ_Yr-s.js";/* empty css                 *//* empty css                         */import{D as Ne,C as Oe}from"./ChatPanel-BK7ioLPm.js";const je={class:"interactive-review-view"},Ae={key:0,class:"export-overlay"},Ue={class:"export-card"},Ve={class:"review-header"},We={class:"header-left"},Ge={class:"document-name"},Ke={class:"item-switcher"},qe=["disabled"],ze={class:"item-indicator"},He={class:"current-index"},Je={class:"total-count"},Qe={key:0,class:"loading-more-hint"},Fe=["disabled"],Xe={class:"header-right"},Ye={class:"progress-info"},Ze={class:"progress-text"},et={class:"progress-bar"},tt=["disabled"],st={class:"review-content"},at={class:"content-left"},nt={class:"content-right"},ot={__name:"InteractiveReviewView",setup(lt){const te=ye(),q=xe(),m=I(()=>te.params.taskId),j=p(!1),A=p(!1),T=p(!1),E=p(!1),U=p(!1),x=p(null),i=p([]),h=p(null),y=p(null),f=p([]),R=p(""),z=p([]),V=p(null),$=I(()=>i.value.find(e=>e.id===h.value)),B=I(()=>i.value.filter(e=>e.chat_status==="completed"||e.chat_status==="skipped"||e.status==="completed"||e.status==="skipped").length),se=I(()=>i.value.length===0?0:Math.round(B.value/i.value.length*100)),S=I(()=>h.value?i.value.findIndex(e=>e.id===h.value):-1),H=I(()=>S.value>0),J=I(()=>S.value<i.value.length-1);function ae(){if(!H.value)return;const e=i.value[S.value-1];e&&b(e)}function ne(){if(!J.value)return;const e=i.value[S.value+1];e&&b(e)}const oe=I(()=>f.value.some(e=>e.isStreaming)),W=p(!1);let D=null;Ie(async()=>{var e;await le(),((e=x.value)==null?void 0:e.status)==="partial_ready"&&re()}),ke(()=>{G()});async function le(){var e;j.value=!0;try{const[t,s]=await Promise.all([K.getTask(m.value),w.getInteractiveItems(m.value)]);x.value=t.data,i.value=((e=s.data)==null?void 0:e.items)||[],ie();const a=i.value.find(n=>n.status!=="completed");a?await b(a):i.value.length>0&&await b(i.value[0])}catch(t){console.error("加载数据失败:",t),d.error("加载数据失败: "+(t.message||"请重试"))}finally{j.value=!1}}async function ie(){A.value=!0;try{const e=await w.getDocumentText(m.value);z.value=e.data.paragraphs||[]}catch(e){console.error("加载文档内容失败:",e)}finally{A.value=!1}}function re(){W.value=!0,D=setInterval(async()=>{var e;try{const s=((e=(await w.getInteractiveItems(m.value)).data)==null?void 0:e.items)||[];if(s.length>i.value.length){const n=h.value;i.value=s,n&&!s.find(o=>o.id===n)&&s.length>0&&await b(s[0])}(await K.getTaskStatus(m.value)).data.status==="completed"&&(G(),x.value.status="completed")}catch(t){console.error("增量轮询失败:",t)}},3e3),setTimeout(()=>{G()},2*60*1e3)}function G(){D&&(clearInterval(D),D=null),W.value=!1}async function b(e){var t;if(h.value!==e.id){h.value=e.id,y.value=e.item_id,f.value=[],R.value=e.current_suggestion||e.suggested_text||"";try{const a=(await w.getItemDetail(m.value,e.item_id)).data;f.value=a.messages||[],R.value=a.current_suggestion||e.suggested_text||"";const n=i.value.find(g=>g.id===e.id);n&&(n.status=a.status,n.message_count=((t=a.messages)==null?void 0:t.length)||0)}catch(s){console.error("加载条目详情失败:",s),f.value=e.messages||[]}}}function ue(){var e;V.value&&((e=$.value)!=null&&e.original_text)&&V.value.scrollToText($.value.original_text)}async function ce(e){if(!y.value||T.value)return;f.value.push({role:"user",content:e,timestamp:new Date().toISOString()});const t=f.value.length;f.value.push({role:"assistant",content:"",timestamp:new Date().toISOString(),suggestion_snapshot:null,isStreaming:!0}),T.value=!0;let s="";try{await w.sendChatMessageStream(m.value,y.value,e,"deepseek",{onChunk:a=>{s+=a,f.value[t].content=s},onSuggestion:a=>{R.value=a,f.value[t].suggestion_snapshot=a},onDone:a=>{f.value[t].isStreaming=!1;const n=i.value.find(g=>g.id===h.value);n&&(n.status="in_progress",n.current_suggestion=R.value,n.message_count=f.value.length)},onError:a=>{console.error("流式对话失败:",a),f.value[t].content="抱歉，对话出错了："+a.message,f.value[t].isStreaming=!1,f.value[t].isError=!0}})}catch(a){console.error("发送消息失败:",a),d.error("发送消息失败: "+(a.message||"请重试")),s||(f.value.pop(),f.value.pop())}finally{T.value=!1}}async function de(e){if(y.value)try{await w.completeItem(m.value,y.value,e);const t=i.value.find(s=>s.id===h.value);t&&(t.chat_status="completed",t.status="completed",t.current_suggestion=e),d.success("条目已确认"),F()}catch(t){console.error("完成条目失败:",t),d.error("完成条目失败: "+(t.message||"请重试"))}}async function Q(e,t=3,s=1500){var n,g,o;let a;for(let l=1;l<=t;l++)try{return await e()}catch(c){if(a=c,(((n=c.message)==null?void 0:n.includes("网络"))||((g=c.message)==null?void 0:g.includes("Network"))||c.code==="ERR_NETWORK"||((o=c.originalError)==null?void 0:o.code)==="ERR_NETWORK")&&l<t){console.log(`网络错误，${s/1e3}秒后重试 (${l}/${t})...`),await new Promise(C=>setTimeout(C,s));continue}throw c}throw a}async function fe(){if(!(!y.value||E.value)){E.value=!0;try{const e=pe(f.value),t="用户确认此风险需要处理",s=await Q(()=>w.generateSingleModification(m.value,y.value,e,t)),a=i.value.find(n=>n.id===h.value);a&&(a.has_modification=!0,a.modification_id=s.data.id,a.suggested_text=s.data.suggested_text,a.modification_reason=s.data.modification_reason),R.value=s.data.suggested_text,d.success("已生成修改建议")}catch(e){console.error("生成修改建议失败:",e),d.error("生成修改建议失败: "+(e.message||"请重试"))}finally{E.value=!1}}}async function ve(){if(y.value)try{await w.skipItem(m.value,y.value);const e=i.value.find(t=>t.id===h.value);e&&(e.is_skipped=!0,e.chat_status="skipped",e.status="skipped"),d.info("已跳过此条目"),F()}catch(e){console.error("跳过条目失败:",e),d.error("跳过条目失败: "+(e.message||"请重试"))}}async function ge(e){if(!(!e.suggested_text||!e.item_id))try{await w.completeItem(m.value,e.item_id,e.suggested_text);const t=i.value.find(s=>s.id===e.id);t&&(t.chat_status="completed",t.status="completed",t.current_suggestion=e.suggested_text,t.has_modification=!0),d.success("已快速采纳")}catch(t){console.error("快速采纳失败:",t),d.error("快速采纳失败: "+(t.message||"请重试"))}}async function me(e){const t=i.value.filter(o=>o.priority===e&&o.suggested_text&&o.status!=="completed"&&o.chat_status!=="completed"&&!o.is_skipped&&o.chat_status!=="skipped");if(t.length===0){d.info("没有可采纳的条目");return}const s=e==="should"?"建议":"可选";try{await O.confirm(`确定要批量采纳 ${t.length} 个「${s}」级别的条目吗？`,"批量采纳确认",{confirmButtonText:"确定采纳",cancelButtonText:"取消",type:"info"})}catch{return}const a=d({message:`正在批量采纳 ${t.length} 个条目...`,type:"info",duration:0});let n=0,g=0;for(const o of t)try{await w.completeItem(m.value,o.item_id,o.suggested_text);const l=i.value.find(c=>c.id===o.id);l&&(l.chat_status="completed",l.status="completed",l.current_suggestion=o.suggested_text,l.has_modification=!0),n++}catch(l){console.error(`批量采纳失败 (${o.id}):`,l),g++}a.close(),g===0?d.success(`已批量采纳 ${n} 个「${s}」级别条目`):d.warning(`批量采纳完成：成功 ${n} 个，失败 ${g} 个`)}function pe(e){return!e||e.length===0?"":e.map(t=>`${t.role==="user"?"用户":"AI"}: ${t.content}`).join(`

`)}async function F(){const e=i.value.find(t=>t.chat_status!=="completed"&&t.chat_status!=="skipped"&&t.status!=="completed"&&t.status!=="skipped");e?await b(e):O.confirm("恭喜！所有条目已审阅完成。是否导出结果？","审阅完成",{confirmButtonText:"导出 Word",cancelButtonText:"稍后导出",type:"success"}).then(()=>{X("word")}).catch(()=>{})}function _e(){const e=i.value.filter(n=>n.status!=="completed"&&n.chat_status!=="completed"&&!n.is_skipped&&n.chat_status!=="skipped"),t=e.filter(n=>n.priority==="must").length,s=e.filter(n=>n.priority==="should").length,a=e.filter(n=>n.priority==="may").length;return{total:e.length,mustCount:t,shouldCount:s,mayCount:a}}async function X(e){var t,s,a,n;if(e==="word"){if(i.value.filter(l=>l.chat_status==="completed"&&l.has_modification).length===0){d.warning("请先完成至少一个条目的修改建议后再导出");return}const o=_e();if(o.total>0){let l=`还有 ${o.total} 个条目未处理：`;const c=[];o.mustCount>0&&c.push(`${o.mustCount} 个「必须」`),o.shouldCount>0&&c.push(`${o.shouldCount} 个「建议」`),o.mayCount>0&&c.push(`${o.mayCount} 个「可选」`),l+=c.join("、");const v=o.mustCount>0?"warning":"info",C=o.mustCount>0?"仍然导出":"忽略并导出";try{await O.confirm(l,"存在未处理条目",{confirmButtonText:C,cancelButtonText:"返回处理",type:v,dangerouslyUseHTMLString:!1})}catch{return}}U.value=!0;try{const l=await Q(()=>K.exportRedline(m.value),3,2e3),c=new Blob([l.data],{type:"application/vnd.openxmlformats-officedocument.wordprocessingml.document"}),v=window.URL.createObjectURL(c),C=document.createElement("a");C.href=v,C.download=`${((t=x.value)==null?void 0:t.document_filename)||"result"}_修订版.docx`,C.click(),window.URL.revokeObjectURL(v),d.success("导出成功！文档已下载")}catch(l){console.error("导出失败:",l),(s=l.message)!=null&&s.includes("没有已确认的修改建议")?d.error("请先完成至少一个条目的修改建议后再导出"):d.error("导出失败: "+(l.message||"请重试"))}finally{U.value=!1}}else if(e==="json"){const g={task_id:m.value,document_name:(a=x.value)==null?void 0:a.document_filename,exported_at:new Date().toISOString(),items:i.value.map(v=>({id:v.id,type:v.item_type,priority:v.priority,original_text:v.original_text,final_suggestion:v.current_suggestion,status:v.status,risk_description:v.risk_description||v.modification_reason}))},o=new Blob([JSON.stringify(g,null,2)],{type:"application/json"}),l=window.URL.createObjectURL(o),c=document.createElement("a");c.href=l,c.download=`${((n=x.value)==null?void 0:n.document_filename)||"result"}_审阅结果.json`,c.click(),window.URL.revokeObjectURL(l),d.success("导出成功")}}function he(){B.value<i.value.length?O.confirm("还有未完成的条目，确定要离开吗？","确认离开",{confirmButtonText:"离开",cancelButtonText:"继续审阅",type:"warning"}).then(()=>{q.push("/")}).catch(()=>{}):q.push("/")}return(e,t)=>{var l,c,v;const s=Ce,a=Be,n=$e,g=Le,o=Pe;return L(),M("div",je,[u(Re,{name:"fade"},{default:_(()=>[U.value?(L(),M("div",Ae,[r("div",Ue,[u(s,{class:"export-icon-spin",size:48},{default:_(()=>[u(k(Z))]),_:1}),t[0]||(t[0]=r("h3",{class:"export-title"},"正在生成修订版文档",-1)),t[1]||(t[1]=r("p",{class:"export-desc"},"AI 正在处理您的修改建议，生成 Word 文档...",-1)),t[2]||(t[2]=r("div",{class:"export-progress"},[r("div",{class:"export-progress-bar"})],-1)),t[3]||(t[3]=r("p",{class:"export-hint"},"预计需要 10-30 秒，请耐心等待",-1))])])):Y("",!0)]),_:1}),r("div",Ve,[r("div",We,[r("button",{class:"back-btn",onClick:he},[u(s,null,{default:_(()=>[u(k(ee))]),_:1}),t[4]||(t[4]=P(" 返回 ",-1))]),r("span",Ge,N(((l=x.value)==null?void 0:l.document_filename)||"合同审阅"),1)]),r("div",Ke,[r("button",{class:"switch-btn",disabled:!H.value,onClick:ae},[u(s,null,{default:_(()=>[u(k(ee))]),_:1})],8,qe),r("div",ze,[r("span",He,N(S.value+1),1),t[5]||(t[5]=r("span",{class:"separator"},"/",-1)),r("span",Je,N(i.value.length),1),W.value?(L(),M("span",Qe,[u(s,{class:"is-loading"},{default:_(()=>[u(k(Z))]),_:1})])):Y("",!0)]),r("button",{class:"switch-btn",disabled:!J.value,onClick:ne},[u(s,null,{default:_(()=>[u(k(Se))]),_:1})],8,Fe)]),r("div",Xe,[r("div",Ye,[r("span",Ze,N(B.value)+" 已完成",1),r("div",et,[r("div",{class:"progress-fill",style:Te({width:se.value+"%"})},null,4)])]),u(g,{trigger:"click",onCommand:X},{dropdown:_(()=>[u(n,null,{default:_(()=>[u(a,{command:"word"},{default:_(()=>[u(s,null,{default:_(()=>[u(k(De))]),_:1}),t[7]||(t[7]=P(" 导出 Word ",-1))]),_:1}),u(a,{command:"json"},{default:_(()=>[u(s,null,{default:_(()=>[u(k(Me))]),_:1}),t[8]||(t[8]=P(" 导出 JSON ",-1))]),_:1})]),_:1})]),default:_(()=>[r("button",{class:"export-btn",disabled:B.value===0},[u(s,null,{default:_(()=>[u(k(Ee))]),_:1}),t[6]||(t[6]=P(" 导出 ",-1))],8,tt)]),_:1})])]),be((L(),M("div",st,[r("div",at,[u(Ne,{ref_key:"documentViewerRef",ref:V,"document-name":(c=x.value)==null?void 0:c.document_filename,paragraphs:z.value,"highlight-text":(v=$.value)==null?void 0:v.original_text,loading:A.value},null,8,["document-name","paragraphs","highlight-text","loading"])]),r("div",nt,[u(Oe,{items:i.value,"active-item":$.value,messages:f.value,"current-suggestion":R.value,loading:T.value,streaming:oe.value,"confirming-risk":E.value,onSelectItem:b,onSendMessage:ce,onComplete:de,onConfirmRisk:fe,onSkip:ve,onLocate:ue,onQuickAccept:ge,onBatchAccept:me},null,8,["items","active-item","messages","current-suggestion","loading","streaming","confirming-risk"])])])),[[o,j.value]])])}}},dt=we(ot,[["__scopeId","data-v-541cda3e"]]);export{dt as default};
