import{_ as ve,T as me,u as fe,n as I,r as u,o as ge,a8 as pe,U as V,a0 as x,E as d,a as L,v as _e,c as A,b as $,f as i,x as he,g as l,h as M,w as v,i as y,a5 as F,t as P,e as we,B as Ie,R as xe,Q as ke,m as ye,z as be,a9 as Re,M as K}from"./index-BxL5DJ8Y.js";import{D as Se,C as Ce}from"./ChatPanel-is5ZT1LW.js";const De={class:"interactive-review-view"},Te={class:"review-header"},Be={class:"header-left"},Le={class:"document-name"},Me={class:"item-switcher"},Pe=["disabled"],Ee={class:"item-indicator"},Ue={class:"current-index"},je={class:"total-count"},Ne={key:0,class:"loading-more-hint"},Oe=["disabled"],Ve={class:"header-right"},Ae={class:"progress-info"},$e={class:"progress-text"},We={class:"progress-bar"},ze=["disabled"],Ge={class:"review-content"},Je={class:"content-left"},He={class:"content-right"},Qe={__name:"InteractiveReviewView",setup(qe){const X=me(),W=fe(),c=I(()=>X.params.taskId),E=u(!1),U=u(!1),S=u(!1),C=u(!1),w=u(null),n=u([]),f=u(null),_=u(null),r=u([]),b=u(""),z=u([]),j=u(null),D=I(()=>n.value.find(e=>e.id===f.value)),T=I(()=>n.value.filter(e=>e.chat_status==="completed"||e.chat_status==="skipped"||e.status==="completed"||e.status==="skipped").length),Y=I(()=>n.value.length===0?0:Math.round(T.value/n.value.length*100)),R=I(()=>f.value?n.value.findIndex(e=>e.id===f.value):-1),G=I(()=>R.value>0),J=I(()=>R.value<n.value.length-1);function Z(){if(!G.value)return;const e=n.value[R.value-1];e&&k(e)}function ee(){if(!J.value)return;const e=n.value[R.value+1];e&&k(e)}const te=I(()=>r.value.some(e=>e.isStreaming)),N=u(!1);let B=null;ge(async()=>{var e;await ae(),((e=w.value)==null?void 0:e.status)==="partial_ready"&&ne()}),pe(()=>{O()});async function ae(){var e;E.value=!0;try{const[t,a]=await Promise.all([V.getTask(c.value),x.getInteractiveItems(c.value)]);w.value=t.data,n.value=((e=a.data)==null?void 0:e.items)||[],se();const s=n.value.find(o=>o.status!=="completed");s?await k(s):n.value.length>0&&await k(n.value[0])}catch(t){console.error("加载数据失败:",t),d.error("加载数据失败: "+(t.message||"请重试"))}finally{E.value=!1}}async function se(){U.value=!0;try{const e=await x.getDocumentText(c.value);z.value=e.data.paragraphs||[]}catch(e){console.error("加载文档内容失败:",e)}finally{U.value=!1}}function ne(){N.value=!0,B=setInterval(async()=>{var e;try{const a=((e=(await x.getInteractiveItems(c.value)).data)==null?void 0:e.items)||[];if(a.length>n.value.length){const o=f.value;n.value=a,o&&!a.find(h=>h.id===o)&&a.length>0&&await k(a[0])}(await V.getTaskStatus(c.value)).data.status==="completed"&&(O(),w.value.status="completed")}catch(t){console.error("增量轮询失败:",t)}},3e3),setTimeout(()=>{O()},2*60*1e3)}function O(){B&&(clearInterval(B),B=null),N.value=!1}async function k(e){var t;if(f.value!==e.id){f.value=e.id,_.value=e.item_id,r.value=[],b.value=e.current_suggestion||e.suggested_text||"";try{const s=(await x.getItemDetail(c.value,e.item_id)).data;r.value=s.messages||[],b.value=s.current_suggestion||e.suggested_text||"";const o=n.value.find(g=>g.id===e.id);o&&(o.status=s.status,o.message_count=((t=s.messages)==null?void 0:t.length)||0)}catch(a){console.error("加载条目详情失败:",a),r.value=e.messages||[]}}}function oe(){var e;j.value&&((e=D.value)!=null&&e.original_text)&&j.value.scrollToText(D.value.original_text)}async function le(e){if(!_.value||S.value)return;r.value.push({role:"user",content:e,timestamp:new Date().toISOString()});const t=r.value.length;r.value.push({role:"assistant",content:"",timestamp:new Date().toISOString(),suggestion_snapshot:null,isStreaming:!0}),S.value=!0;let a="";try{await x.sendChatMessageStream(c.value,_.value,e,"deepseek",{onChunk:s=>{a+=s,r.value[t].content=a},onSuggestion:s=>{b.value=s,r.value[t].suggestion_snapshot=s},onDone:s=>{r.value[t].isStreaming=!1;const o=n.value.find(g=>g.id===f.value);o&&(o.status="in_progress",o.current_suggestion=b.value,o.message_count=r.value.length)},onError:s=>{console.error("流式对话失败:",s),r.value[t].content="抱歉，对话出错了："+s.message,r.value[t].isStreaming=!1,r.value[t].isError=!0}})}catch(s){console.error("发送消息失败:",s),d.error("发送消息失败: "+(s.message||"请重试")),a||(r.value.pop(),r.value.pop())}finally{S.value=!1}}async function ie(e){if(_.value)try{await x.completeItem(c.value,_.value,e);const t=n.value.find(a=>a.id===f.value);t&&(t.chat_status="completed",t.status="completed",t.current_suggestion=e),d.success("条目已确认"),H()}catch(t){console.error("完成条目失败:",t),d.error("完成条目失败: "+(t.message||"请重试"))}}async function re(){if(!(!_.value||C.value)){C.value=!0;try{const e=ce(r.value),a=await x.generateSingleModification(c.value,_.value,e,"用户确认此风险需要处理"),s=n.value.find(o=>o.id===f.value);s&&(s.has_modification=!0,s.modification_id=a.data.id,s.suggested_text=a.data.suggested_text,s.modification_reason=a.data.modification_reason),b.value=a.data.suggested_text,d.success("已生成修改建议")}catch(e){console.error("生成修改建议失败:",e),d.error("生成修改建议失败: "+(e.message||"请重试"))}finally{C.value=!1}}}async function ue(){if(_.value)try{await x.skipItem(c.value,_.value);const e=n.value.find(t=>t.id===f.value);e&&(e.is_skipped=!0,e.chat_status="skipped",e.status="skipped"),d.info("已跳过此条目"),H()}catch(e){console.error("跳过条目失败:",e),d.error("跳过条目失败: "+(e.message||"请重试"))}}function ce(e){return!e||e.length===0?"":e.map(t=>`${t.role==="user"?"用户":"AI"}: ${t.content}`).join(`

`)}async function H(){const e=n.value.find(t=>t.chat_status!=="completed"&&t.chat_status!=="skipped"&&t.status!=="completed"&&t.status!=="skipped");e?await k(e):K.confirm("恭喜！所有条目已审阅完成。是否导出结果？","审阅完成",{confirmButtonText:"导出 Word",cancelButtonText:"稍后导出",type:"success"}).then(()=>{Q("word")}).catch(()=>{})}async function Q(e){var t,a,s;if(e==="word")try{d.info("正在生成修订版 Word 文档...");const o=await V.exportRedline(c.value),g=new Blob([o.data],{type:"application/vnd.openxmlformats-officedocument.wordprocessingml.document"}),h=window.URL.createObjectURL(g),p=document.createElement("a");p.href=h,p.download=`${((t=w.value)==null?void 0:t.document_filename)||"result"}_修订版.docx`,p.click(),window.URL.revokeObjectURL(h),d.success("导出成功")}catch(o){console.error("导出失败:",o),d.error("导出失败: "+(o.message||"请重试"))}else if(e==="json"){const o={task_id:c.value,document_name:(a=w.value)==null?void 0:a.document_filename,exported_at:new Date().toISOString(),items:n.value.map(m=>({id:m.id,type:m.item_type,priority:m.priority,original_text:m.original_text,final_suggestion:m.current_suggestion,status:m.status,risk_description:m.risk_description||m.modification_reason}))},g=new Blob([JSON.stringify(o,null,2)],{type:"application/json"}),h=window.URL.createObjectURL(g),p=document.createElement("a");p.href=h,p.download=`${((s=w.value)==null?void 0:s.document_filename)||"result"}_审阅结果.json`,p.click(),window.URL.revokeObjectURL(h),d.success("导出成功")}}function de(){T.value<n.value.length?K.confirm("还有未完成的条目，确定要离开吗？","确认离开",{confirmButtonText:"离开",cancelButtonText:"继续审阅",type:"warning"}).then(()=>{W.push("/")}).catch(()=>{}):W.push("/")}return(e,t)=>{var p,m,q;const a=L("el-icon"),s=L("el-dropdown-item"),o=L("el-dropdown-menu"),g=L("el-dropdown"),h=_e("loading");return $(),A("div",De,[i("div",Te,[i("div",Be,[i("button",{class:"back-btn",onClick:de},[l(a,null,{default:v(()=>[l(y(F))]),_:1}),t[0]||(t[0]=M(" 返回 ",-1))]),i("span",Le,P(((p=w.value)==null?void 0:p.document_filename)||"合同审阅"),1)]),i("div",Me,[i("button",{class:"switch-btn",disabled:!G.value,onClick:Z},[l(a,null,{default:v(()=>[l(y(F))]),_:1})],8,Pe),i("div",Ee,[i("span",Ue,P(R.value+1),1),t[1]||(t[1]=i("span",{class:"separator"},"/",-1)),i("span",je,P(n.value.length),1),N.value?($(),A("span",Ne,[l(a,{class:"is-loading"},{default:v(()=>[l(y(Ie))]),_:1})])):we("",!0)]),i("button",{class:"switch-btn",disabled:!J.value,onClick:ee},[l(a,null,{default:v(()=>[l(y(xe))]),_:1})],8,Oe)]),i("div",Ve,[i("div",Ae,[i("span",$e,P(T.value)+" 已完成",1),i("div",We,[i("div",{class:"progress-fill",style:ke({width:Y.value+"%"})},null,4)])]),l(g,{trigger:"click",onCommand:Q},{dropdown:v(()=>[l(o,null,{default:v(()=>[l(s,{command:"word"},{default:v(()=>[l(a,null,{default:v(()=>[l(y(be))]),_:1}),t[3]||(t[3]=M(" 导出 Word ",-1))]),_:1}),l(s,{command:"json"},{default:v(()=>[l(a,null,{default:v(()=>[l(y(Re))]),_:1}),t[4]||(t[4]=M(" 导出 JSON ",-1))]),_:1})]),_:1})]),default:v(()=>[i("button",{class:"export-btn",disabled:T.value===0},[l(a,null,{default:v(()=>[l(y(ye))]),_:1}),t[2]||(t[2]=M(" 导出 ",-1))],8,ze)]),_:1})])]),he(($(),A("div",Ge,[i("div",Je,[l(Se,{ref_key:"documentViewerRef",ref:j,"document-name":(m=w.value)==null?void 0:m.document_filename,paragraphs:z.value,"highlight-text":(q=D.value)==null?void 0:q.original_text,loading:U.value},null,8,["document-name","paragraphs","highlight-text","loading"])]),i("div",He,[l(Ce,{items:n.value,"active-item":D.value,messages:r.value,"current-suggestion":b.value,loading:S.value,streaming:te.value,"confirming-risk":C.value,onSelectItem:k,onSendMessage:le,onComplete:ie,onConfirmRisk:re,onSkip:ue,onLocate:oe},null,8,["items","active-item","messages","current-suggestion","loading","streaming","confirming-risk"])])])),[[h,E.value]])])}}},Xe=ve(Qe,[["__scopeId","data-v-bded1269"]]);export{Xe as default};
