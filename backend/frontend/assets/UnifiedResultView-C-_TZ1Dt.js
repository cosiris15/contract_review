import{_ as Ve,r as k,n as Z,q as Ie,a as v,c as j,b as h,g as e,w as l,f as d,t as r,h as p,d as S,e as pe,F as Ce,G as Se,H as $e,E as A,T as Ee,u as Ae,o as Le,U as ce,a0 as fe,v as He,x as ze,i as G,a5 as Ne,aa as Oe,l as je,m as Be,a2 as Pe,z as he,a9 as Fe,ab as We,M as Te}from"./index-BOoWkaEM.js";import{D as qe,C as Je}from"./ChatPanel-DlU3pMuI.js";import{u as Ge}from"./index-DZX06AQ0.js";const Ze={class:"result-list-view"},Ke={class:"stat-value"},Qe={class:"stat-label"},Xe={class:"stat-detail"},Ye={class:"stat-value"},et={class:"stat-label"},tt={class:"stat-detail"},lt={class:"stat-value"},at={class:"stat-label"},st={class:"stat-detail"},ot={class:"stat-value"},nt={class:"stat-label"},it={class:"stat-detail"},ut={class:"text-ellipsis"},rt={key:1},dt={class:"modification-list"},ct={class:"mod-header"},ft={class:"mod-reason"},pt={class:"mod-actions"},mt={class:"text-label"},vt=["innerHTML"],_t={key:1,class:"text-box original"},gt={class:"text-label"},yt=["innerHTML"],ht={key:1,class:"text-box suggested"},bt={__name:"ResultListView",props:{result:{type:Object,default:null},language:{type:String,default:"zh-CN"}},emits:["update-modification","update-action","refresh"],setup(B,{emit:_e}){const P=B,F=_e,C=k("risks"),K=k({}),H=k(!1),z=k(!1),N=k(null),R=k({description:"",action_type:"",urgency:"normal",responsible_party:"",deadline_suggestion:""}),ae=Z(()=>P.language==="en"),g=Z(()=>{var o;return((o=P.result)==null?void 0:o.summary)||{total_risks:0,high_risks:0,medium_risks:0,low_risks:0,total_modifications:0,must_modify:0,should_modify:0,total_actions:0,immediate_actions:0}}),u=Z(()=>ae.value?{materialType:{contract:"Contract",marketing:"Marketing Material"},riskLevel:{high:"High",medium:"Medium",low:"Low"},priority:{must:"Must",should:"Should",may:"May"},urgency:{immediate:"Immediate",soon:"Soon",normal:"Normal"},labels:{totalRisks:"Total Risks",highRisks:"High Risks",priorityNeeded:"Priority needed",modifications:"Modifications",actions:"Actions",risks:"Risks",highDetail:"H",mediumDetail:"M",lowDetail:"L",mustModify:"must",shouldModify:"should",immediateActions:"immediate",riskLevelCol:"Risk Level",riskType:"Risk Type",riskDescription:"Description",reason:"Reason",originalText:"Original Text",urgencyCol:"Urgency",actionType:"Action Type",specificAction:"Specific Action",responsibleParty:"Responsible Party",deadline:"Deadline",operation:"Operation",confirm:"Confirm",edit:"Edit",currentText:"Current Text",suggestedText:"Suggested Modification",save:"Save",confirmAdopt:"Confirm",diff:"Diff",fullText:"Full",noModifications:"No modification suggestions",noActions:"No action recommendations"}}:{materialType:{contract:"合同",marketing:"营销材料"},riskLevel:{high:"高",medium:"中",low:"低"},priority:{must:"必须",should:"应该",may:"可以"},urgency:{immediate:"立即",soon:"尽快",normal:"一般"},labels:{totalRisks:"风险总数",highRisks:"高风险",priorityNeeded:"需优先处理",modifications:"修改建议",actions:"行动建议",risks:"风险点",highDetail:"高",mediumDetail:"中",lowDetail:"低",mustModify:"必须",shouldModify:"应该",immediateActions:"立即处理",riskLevelCol:"风险等级",riskType:"风险类型",riskDescription:"风险描述",reason:"判定理由",originalText:"原文摘录",urgencyCol:"紧急程度",actionType:"行动类型",specificAction:"具体行动",responsibleParty:"负责方",deadline:"建议时限",operation:"操作",confirm:"确认",edit:"编辑",currentText:"当前文本",suggestedText:"建议修改为",save:"保存",confirmAdopt:"确认采纳",diff:"差异",fullText:"全文",noModifications:"无修改建议",noActions:"无行动建议"}});Ie(()=>P.result,()=>{se()},{immediate:!0});function x(o){var i,w;if(!K.value[o]){const _=(w=(i=P.result)==null?void 0:i.modifications)==null?void 0:w.find(L=>L.id===o);K.value[o]={showDiff:!0,isEditing:!1,editText:(_==null?void 0:_.user_modified_text)||(_==null?void 0:_.suggested_text)||""}}return K.value[o]}function se(){var o;(o=P.result)!=null&&o.modifications&&P.result.modifications.forEach(i=>{K.value[i.id]||(K.value[i.id]={showDiff:!0,isEditing:!1,editText:i.user_modified_text||i.suggested_text||""})})}function me(o){return{high:"danger",medium:"warning",low:"info"}[o]||"info"}function ie(o){return u.value.riskLevel[o]||o}function ee(o){return{must:"danger",should:"warning",may:"info"}[o]||"info"}function te(o){return u.value.priority[o]||o}function D(o){return{immediate:"danger",soon:"warning",normal:"info"}[o]||"info"}function ue(o){return u.value.urgency[o]||o}function re(o,i){if(!o||!i)return{originalHtml:o||"",modifiedHtml:i||""};if(o===i)return{originalHtml:o,modifiedHtml:i};const w=s=>{const n=[];let m="",b=null;for(const M of s){const U=/[\u4e00-\u9fa5]/.test(M),c=/[a-zA-Z0-9]/.test(M),y=/\s/.test(M);let V;U?V="cn":c?V="en":y?V="space":V="punct",V==="cn"?(m&&n.push(m),n.push(M),m="",b=null):V===b&&V==="en"?m+=M:(m&&n.push(m),m=M,b=V)}return m&&n.push(m),n},_=w(o),L=w(i),W=_.length,q=L.length,T=Array(W+1).fill(null).map(()=>Array(q+1).fill(0));for(let s=1;s<=W;s++)for(let n=1;n<=q;n++)_[s-1]===L[n-1]?T[s][n]=T[s-1][n-1]+1:T[s][n]=Math.max(T[s-1][n],T[s][n-1]);const le=[];let $=W,E=q;for(;$>0&&E>0;)_[$-1]===L[E-1]?(le.unshift({origIdx:$-1,modIdx:E-1,token:_[$-1]}),$--,E--):T[$-1][E]>T[$][E-1]?$--:E--;const J=s=>s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");let X="",O=-1;for(const s of le){for(let n=O+1;n<s.origIdx;n++)X+=`<del class="diff-del">${J(_[n])}</del>`;X+=J(s.token),O=s.origIdx}for(let s=O+1;s<W;s++)X+=`<del class="diff-del">${J(_[s])}</del>`;let a="",t=-1;for(const s of le){for(let n=t+1;n<s.modIdx;n++)a+=`<ins class="diff-ins">${J(L[n])}</ins>`;a+=J(s.token),t=s.modIdx}for(let s=t+1;s<q;s++)a+=`<ins class="diff-ins">${J(L[s])}</ins>`;return{originalHtml:X,modifiedHtml:a}}function Q(o){const i=o.original_text||"",_=x(o.id).editText||o.user_modified_text||o.suggested_text||"";return re(i,_)}async function ge(o){const i=x(o.id);try{F("update-modification",o.id,{user_modified_text:i.editText,user_confirmed:!0}),i.isEditing=!1,o.user_confirmed=!0,o.user_modified_text=i.editText,A.success("保存成功")}catch{A.error("保存失败")}}async function oe(o,i){F("update-modification",o.id,i)}async function de(o,i){o.user_confirmed=i,F("update-action",o.id,i)}function ye(o){N.value=o.id,R.value={description:o.description||"",action_type:o.action_type||"",urgency:o.urgency||"normal",responsible_party:o.responsible_party||"",deadline_suggestion:o.deadline_suggestion||""},H.value=!0}async function ve(){var o,i;z.value=!0;try{const w=(i=(o=P.result)==null?void 0:o.actions)==null?void 0:i.find(_=>_.id===N.value);w&&(Object.assign(w,R.value),w.user_confirmed=!0),F("update-action",N.value,{...R.value,user_confirmed:!0}),H.value=!1,A.success("保存成功")}catch{A.error("保存失败")}finally{z.value=!1}}return(o,i)=>{const w=v("el-card"),_=v("el-col"),L=v("el-row"),W=v("el-badge"),q=v("el-tag"),T=v("el-table-column"),le=v("el-popover"),$=v("el-table"),E=v("el-tab-pane"),J=v("el-switch"),X=v("el-checkbox"),O=v("el-button"),a=v("el-input"),t=v("el-empty"),s=v("el-tabs"),n=v("el-form-item"),m=v("el-option"),b=v("el-select"),M=v("el-form"),U=v("el-dialog");return h(),j("div",Ze,[e(L,{gutter:16,class:"stat-cards"},{default:l(()=>[e(_,{span:6},{default:l(()=>[e(w,{class:"stat-card danger"},{default:l(()=>[d("div",Ke,r(g.value.total_risks),1),d("div",Qe,r(u.value.labels.totalRisks),1),d("div",Xe,r(u.value.labels.highDetail)+" "+r(g.value.high_risks)+" / "+r(u.value.labels.mediumDetail)+" "+r(g.value.medium_risks)+" / "+r(u.value.labels.lowDetail)+" "+r(g.value.low_risks),1)]),_:1})]),_:1}),e(_,{span:6},{default:l(()=>[e(w,{class:"stat-card warning"},{default:l(()=>[d("div",Ye,r(g.value.high_risks),1),d("div",et,r(u.value.labels.highRisks),1),d("div",tt,r(u.value.labels.priorityNeeded),1)]),_:1})]),_:1}),e(_,{span:6},{default:l(()=>[e(w,{class:"stat-card primary"},{default:l(()=>[d("div",lt,r(g.value.total_modifications),1),d("div",at,r(u.value.labels.modifications),1),d("div",st,r(u.value.labels.mustModify)+" "+r(g.value.must_modify)+" / "+r(u.value.labels.shouldModify)+" "+r(g.value.should_modify),1)]),_:1})]),_:1}),e(_,{span:6},{default:l(()=>[e(w,{class:"stat-card success"},{default:l(()=>[d("div",ot,r(g.value.total_actions),1),d("div",nt,r(u.value.labels.actions),1),d("div",it,r(u.value.labels.immediateActions)+" "+r(g.value.immediate_actions),1)]),_:1})]),_:1})]),_:1}),e(w,{class:"content-card"},{default:l(()=>[e(s,{modelValue:C.value,"onUpdate:modelValue":i[0]||(i[0]=c=>C.value=c)},{default:l(()=>[e(E,{label:u.value.labels.risks,name:"risks"},{label:l(()=>{var c,y;return[d("span",null,[p(r(u.value.labels.risks)+" ",1),e(W,{value:((y=(c=B.result)==null?void 0:c.risks)==null?void 0:y.length)||0,type:"danger"},null,8,["value"])])]}),default:l(()=>{var c;return[e($,{data:((c=B.result)==null?void 0:c.risks)||[],stripe:"",border:""},{default:l(()=>[e(T,{label:u.value.labels.riskLevelCol,width:"100",align:"center"},{default:l(({row:y})=>[e(q,{type:me(y.risk_level)},{default:l(()=>[p(r(ie(y.risk_level)),1)]),_:2},1032,["type"])]),_:1},8,["label"]),e(T,{prop:"risk_type",label:u.value.labels.riskType,width:"120"},null,8,["label"]),e(T,{prop:"description",label:u.value.labels.riskDescription,"min-width":"200"},null,8,["label"]),e(T,{prop:"reason",label:u.value.labels.reason,"min-width":"200"},null,8,["label"]),e(T,{label:u.value.labels.originalText,width:"200"},{default:l(({row:y})=>{var V;return[(V=y.location)!=null&&V.original_text?(h(),S(le,{key:0,trigger:"hover",width:"400",placement:"top"},{reference:l(()=>[d("span",ut,r(y.location.original_text.slice(0,50))+"... ",1)]),default:l(()=>[d("div",null,r(y.location.original_text),1)]),_:2},1024)):(h(),j("span",rt,"-"))]}),_:1},8,["label"])]),_:1},8,["data"])]}),_:1},8,["label"]),e(E,{label:u.value.labels.modifications,name:"modifications"},{label:l(()=>{var c,y;return[d("span",null,[p(r(u.value.labels.modifications)+" ",1),e(W,{value:((y=(c=B.result)==null?void 0:c.modifications)==null?void 0:y.length)||0,type:"primary"},null,8,["value"])])]}),default:l(()=>{var c,y,V;return[d("div",dt,[(h(!0),j(Ce,null,Se(((c=B.result)==null?void 0:c.modifications)||[],f=>(h(),S(w,{key:f.id,class:$e(["modification-card",{confirmed:f.user_confirmed}])},{default:l(()=>[d("div",ct,[e(q,{type:ee(f.priority)},{default:l(()=>[p(r(te(f.priority)),1)]),_:2},1032,["type"]),d("span",ft,r(f.modification_reason),1),d("div",pt,[e(J,{modelValue:x(f.id).showDiff,"onUpdate:modelValue":I=>x(f.id).showDiff=I,"active-text":u.value.labels.diff,"inactive-text":u.value.labels.fullText,size:"small",style:{"margin-right":"12px"}},null,8,["modelValue","onUpdate:modelValue","active-text","inactive-text"]),e(X,{modelValue:f.user_confirmed,"onUpdate:modelValue":I=>f.user_confirmed=I,onChange:I=>oe(f,{user_confirmed:I})},{default:l(()=>[p(r(u.value.labels.confirmAdopt),1)]),_:1},8,["modelValue","onUpdate:modelValue","onChange"])])]),e(L,{gutter:20,class:"mod-content"},{default:l(()=>[e(_,{span:12},{default:l(()=>[d("div",mt,r(u.value.labels.currentText),1),x(f.id).showDiff?(h(),j("div",{key:0,class:"text-box diff-view",innerHTML:Q(f).originalHtml},null,8,vt)):(h(),j("div",_t,r(f.original_text),1))]),_:2},1024),e(_,{span:12},{default:l(()=>[d("div",gt,[p(r(u.value.labels.suggestedText)+" ",1),x(f.id).isEditing?(h(),S(O,{key:1,type:"success",link:"",size:"small",onClick:I=>ge(f)},{default:l(()=>[p(r(u.value.labels.save),1)]),_:1},8,["onClick"])):(h(),S(O,{key:0,type:"primary",link:"",size:"small",onClick:I=>x(f.id).isEditing=!0},{default:l(()=>[p(r(u.value.labels.edit),1)]),_:1},8,["onClick"]))]),x(f.id).showDiff&&!x(f.id).isEditing?(h(),j("div",{key:0,class:"text-box diff-view suggested",innerHTML:Q(f).modifiedHtml},null,8,yt)):x(f.id).isEditing?(h(),S(a,{key:2,type:"textarea",rows:4,modelValue:x(f.id).editText,"onUpdate:modelValue":I=>x(f.id).editText=I},null,8,["modelValue","onUpdate:modelValue"])):(h(),j("div",ht,r(x(f.id).editText||f.suggested_text),1))]),_:2},1024)]),_:2},1024)]),_:2},1032,["class"]))),128)),(V=(y=B.result)==null?void 0:y.modifications)!=null&&V.length?pe("",!0):(h(),S(t,{key:0,description:u.value.labels.noModifications},null,8,["description"]))])]}),_:1},8,["label"]),e(E,{label:u.value.labels.actions,name:"actions"},{label:l(()=>{var c,y;return[d("span",null,[p(r(u.value.labels.actions)+" ",1),e(W,{value:((y=(c=B.result)==null?void 0:c.actions)==null?void 0:y.length)||0,type:"success"},null,8,["value"])])]}),default:l(()=>{var c,y,V;return[e($,{data:((c=B.result)==null?void 0:c.actions)||[],stripe:"",border:""},{default:l(()=>[e(T,{label:u.value.labels.urgencyCol,width:"100",align:"center"},{default:l(({row:f})=>[e(q,{type:D(f.urgency)},{default:l(()=>[p(r(ue(f.urgency)),1)]),_:2},1032,["type"])]),_:1},8,["label"]),e(T,{prop:"action_type",label:u.value.labels.actionType,width:"120"},null,8,["label"]),e(T,{prop:"description",label:u.value.labels.specificAction,"min-width":"250"},null,8,["label"]),e(T,{prop:"responsible_party",label:u.value.labels.responsibleParty,width:"100"},null,8,["label"]),e(T,{prop:"deadline_suggestion",label:u.value.labels.deadline,width:"120"},{default:l(({row:f})=>[p(r(f.deadline_suggestion||"-"),1)]),_:1},8,["label"]),e(T,{label:u.value.labels.operation,width:"130",align:"center"},{default:l(({row:f})=>[e(X,{modelValue:f.user_confirmed,"onUpdate:modelValue":I=>f.user_confirmed=I,onChange:I=>de(f,I),style:{"margin-right":"8px"}},{default:l(()=>[p(r(u.value.labels.confirm),1)]),_:1},8,["modelValue","onUpdate:modelValue","onChange"]),e(O,{type:"primary",link:"",size:"small",onClick:I=>ye(f)},{default:l(()=>[p(r(u.value.labels.edit),1)]),_:1},8,["onClick"])]),_:1},8,["label"])]),_:1},8,["data"]),(V=(y=B.result)==null?void 0:y.actions)!=null&&V.length?pe("",!0):(h(),S(t,{key:0,description:u.value.labels.noActions},null,8,["description"]))]}),_:1},8,["label"])]),_:1},8,["modelValue"])]),_:1}),e(U,{modelValue:H.value,"onUpdate:modelValue":i[7]||(i[7]=c=>H.value=c),title:"编辑行动建议",width:"500px","close-on-click-modal":!1},{footer:l(()=>[e(O,{onClick:i[6]||(i[6]=c=>H.value=!1)},{default:l(()=>[...i[8]||(i[8]=[p("取消",-1)])]),_:1}),e(O,{type:"primary",onClick:ve,loading:z.value},{default:l(()=>[...i[9]||(i[9]=[p(" 保存 ",-1)])]),_:1},8,["loading"])]),default:l(()=>[e(M,{model:R.value,"label-width":"80px"},{default:l(()=>[e(n,{label:"具体行动"},{default:l(()=>[e(a,{modelValue:R.value.description,"onUpdate:modelValue":i[1]||(i[1]=c=>R.value.description=c),type:"textarea",rows:3,placeholder:"请输入具体行动描述"},null,8,["modelValue"])]),_:1}),e(n,{label:"行动类型"},{default:l(()=>[e(b,{modelValue:R.value.action_type,"onUpdate:modelValue":i[2]||(i[2]=c=>R.value.action_type=c),style:{width:"100%"}},{default:l(()=>[e(m,{label:"沟通协商",value:"沟通协商"}),e(m,{label:"补充材料",value:"补充材料"}),e(m,{label:"法务确认",value:"法务确认"}),e(m,{label:"内部审批",value:"内部审批"}),e(m,{label:"核实信息",value:"核实信息"})]),_:1},8,["modelValue"])]),_:1}),e(n,{label:"紧急程度"},{default:l(()=>[e(b,{modelValue:R.value.urgency,"onUpdate:modelValue":i[3]||(i[3]=c=>R.value.urgency=c),style:{width:"100%"}},{default:l(()=>[e(m,{label:"立即处理",value:"immediate"}),e(m,{label:"尽快处理",value:"soon"}),e(m,{label:"一般",value:"normal"})]),_:1},8,["modelValue"])]),_:1}),e(n,{label:"负责方"},{default:l(()=>[e(a,{modelValue:R.value.responsible_party,"onUpdate:modelValue":i[4]||(i[4]=c=>R.value.responsible_party=c),placeholder:"请输入负责方"},null,8,["modelValue"])]),_:1}),e(n,{label:"建议时限"},{default:l(()=>[e(a,{modelValue:R.value.deadline_suggestion,"onUpdate:modelValue":i[5]||(i[5]=c=>R.value.deadline_suggestion=c),placeholder:"如：签署前、3个工作日内"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}},kt=Ve(bt,[["__scopeId","data-v-067832f2"]]),xt={class:"unified-result-view"},wt={class:"result-header"},Tt={class:"header-left"},Vt={class:"document-name"},Ct={class:"header-center"},Rt={class:"header-right"},Dt={key:0,class:"progress-info"},Mt={class:"progress-text"},Ut={class:"result-content"},It={class:"content-left"},St={class:"content-right"},$t={class:"redline-dialog-content"},Et={class:"export-option"},At={class:"option-header"},Lt={class:"option-count"},Ht={class:"export-option"},zt={class:"option-header"},Nt={class:"option-count"},Ot={key:1,class:"export-progress"},jt={class:"progress-header"},Bt={__name:"UnifiedResultView",setup(B){const _e=Ee(),P=Ae(),F=Ge(),C=Z(()=>_e.params.taskId),K=k(!1),H=k("interactive"),z=k(null),N=k(null),R=k(!1),ae=k(!1),g=k([]),u=k(null),x=k([]),se=k(""),me=k([]),ie=k(null),ee=k(!1),te=k(!1),D=k(null),ue=k(!1),re=k(!1);let Q=null;const ge=Z(()=>{var a;return!!((a=z.value)!=null&&a.standard_filename)}),oe=Z(()=>g.value.find(a=>a.id===u.value)),de=Z(()=>g.value.filter(a=>a.status==="completed").length),ye=Z(()=>g.value.length===0?0:Math.round(de.value/g.value.length*100)),ve=Z(()=>{var a;return(a=N.value)!=null&&a.modifications?N.value.modifications.filter(t=>t.user_confirmed).length:0}),o=Z(()=>{var a;return(a=N.value)!=null&&a.actions?N.value.actions.filter(t=>t.user_confirmed).length:0});Le(async()=>{await i()});async function i(){K.value=!0;try{const[a,t]=await Promise.all([ce.getTask(C.value),fe.getInteractiveItems(C.value)]);z.value=a.data,g.value=t.data||[],await F.loadResult(C.value),N.value=F.reviewResult,w();const s=g.value.find(n=>n.status!=="completed");s?await _(s):g.value.length>0&&await _(g.value[0])}catch(a){console.error("加载数据失败:",a),A.error("加载数据失败: "+(a.message||"请重试"))}finally{K.value=!1}}async function w(){R.value=!0;try{const a=await fe.getDocumentText(C.value);me.value=a.data.paragraphs||[]}catch(a){console.error("加载文档内容失败:",a)}finally{R.value=!1}}async function _(a){var t;if(u.value!==a.id){u.value=a.id,x.value=[],se.value=a.current_suggestion||a.suggested_text||"";try{const n=(await fe.getItemDetail(C.value,a.id)).data;x.value=n.messages||[],se.value=n.current_suggestion||a.suggested_text||"";const m=g.value.find(b=>b.id===a.id);m&&(m.status=n.status,m.message_count=((t=n.messages)==null?void 0:t.length)||0)}catch(s){console.error("加载条目详情失败:",s),x.value=a.messages||[]}}}function L(){var a;ie.value&&((a=oe.value)!=null&&a.original_text)&&ie.value.scrollToText(oe.value.original_text)}async function W(a){if(!(!u.value||ae.value)){x.value.push({role:"user",content:a,timestamp:new Date().toISOString()}),ae.value=!0;try{const s=(await fe.sendChatMessage(C.value,u.value,a,"deepseek")).data;x.value.push({role:"assistant",content:s.assistant_reply,timestamp:new Date().toISOString(),suggestion_snapshot:s.updated_suggestion}),se.value=s.updated_suggestion;const n=g.value.find(m=>m.id===u.value);n&&(n.status="in_progress",n.current_suggestion=s.updated_suggestion,n.message_count=x.value.length)}catch(t){console.error("发送消息失败:",t),A.error("发送消息失败: "+(t.message||"请重试")),x.value.pop()}finally{ae.value=!1}}}async function q(a){if(u.value)try{await fe.completeItem(C.value,u.value,a);const t=g.value.find(n=>n.id===u.value);t&&(t.status="completed",t.current_suggestion=a),A.success("条目已确认");const s=g.value.find(n=>n.status!=="completed");s?await _(s):Te.confirm("恭喜！所有条目已审阅完成。是否导出结果？","审阅完成",{confirmButtonText:"导出 Word",cancelButtonText:"稍后导出",type:"success"}).then(()=>{$("word")}).catch(()=>{})}catch(t){console.error("完成条目失败:",t),A.error("完成条目失败: "+(t.message||"请重试"))}}async function T(a,t){try{await F.updateModification(C.value,a,t)}catch{A.error("更新失败")}}async function le(a,t){try{typeof t=="boolean"?await F.updateAction(C.value,a,t):await F.updateAction(C.value,a,t)}catch{A.error("更新失败")}}async function $(a){var t,s;if(a==="word")ee.value=!0,D.value=null;else if(a==="json"){const n={task_id:C.value,document_name:(t=z.value)==null?void 0:t.document_filename,exported_at:new Date().toISOString(),items:g.value.map(U=>({id:U.id,type:U.item_type,priority:U.priority,original_text:U.original_text,final_suggestion:U.current_suggestion,status:U.status,risk_description:U.risk_description||U.modification_reason}))},m=new Blob([JSON.stringify(n,null,2)],{type:"application/json"}),b=window.URL.createObjectURL(m),M=document.createElement("a");M.href=b,M.download=`${((s=z.value)==null?void 0:s.document_filename)||"result"}_审阅结果.json`,M.click(),window.URL.revokeObjectURL(b),A.success("导出成功")}else if(a==="excel"){const n=ce.exportExcel(C.value);n&&window.open(n,"_blank")}}async function E(){te.value=!0,D.value={status:"pending",progress:0,message:"正在启动导出..."};try{const a=await ce.startRedlineExport(C.value,null,re.value);D.value=a.data,Q&&clearInterval(Q),Q=setInterval(J,1e3)}catch(a){console.error("启动导出失败:",a),D.value={status:"failed",progress:0,message:"启动失败",error:a.message},te.value=!1}}async function J(){try{const a=await ce.getRedlineExportStatus(C.value);D.value=a.data,(a.data.status==="completed"||a.data.status==="failed")&&(Q&&(clearInterval(Q),Q=null),te.value=!1)}catch(a){console.error("获取导出状态失败:",a)}}async function X(){ue.value=!0;try{const a=await ce.downloadRedlineExport(C.value),t=a.headers["content-disposition"];let s="document_redline.docx";if(t){const M=t.match(/filename\*=UTF-8''([^;\s]+)/);if(M)s=decodeURIComponent(M[1]);else{const U=t.match(/filename="?([^"]+)"?/);U&&(s=U[1])}}const n=new Blob([a.data],{type:"application/vnd.openxmlformats-officedocument.wordprocessingml.document"}),m=window.URL.createObjectURL(n),b=document.createElement("a");b.href=m,b.download=s,document.body.appendChild(b),b.click(),document.body.removeChild(b),window.URL.revokeObjectURL(m),A.success("文件下载成功"),ee.value=!1}catch(a){console.error("下载失败:",a),A.error(a.message||"下载失败，请重试")}finally{ue.value=!1}}function O(){H.value==="interactive"&&de.value<g.value.length?Te.confirm("还有未完成的条目，确定要离开吗？","确认离开",{confirmButtonText:"离开",cancelButtonText:"继续审阅",type:"warning"}).then(()=>{P.push("/")}).catch(()=>{}):P.push("/")}return(a,t)=>{var be,ke,xe,we;const s=v("el-icon"),n=v("el-button"),m=v("el-divider"),b=v("el-tag"),M=v("el-radio-button"),U=v("el-radio-group"),c=v("el-progress"),y=v("el-dropdown-item"),V=v("el-dropdown-menu"),f=v("el-dropdown"),I=v("el-alert"),Re=v("el-checkbox"),De=v("el-dialog"),Me=He("loading");return ze((h(),j("div",xt,[d("div",wt,[d("div",Tt,[e(n,{text:"",onClick:O},{default:l(()=>[e(s,null,{default:l(()=>[e(G(Ne))]),_:1}),t[4]||(t[4]=p(" 返回 ",-1))]),_:1}),e(m,{direction:"vertical"}),d("span",Vt,r(((be=z.value)==null?void 0:be.document_filename)||"审阅结果"),1),ge.value?(h(),S(b,{key:0,type:"success",size:"small"},{default:l(()=>[...t[5]||(t[5]=[p("已应用标准",-1)])]),_:1})):(h(),S(b,{key:1,type:"info",size:"small"},{default:l(()=>[...t[6]||(t[6]=[p("AI 自主审阅",-1)])]),_:1}))]),d("div",Ct,[e(U,{modelValue:H.value,"onUpdate:modelValue":t[0]||(t[0]=Y=>H.value=Y),size:"small"},{default:l(()=>[e(M,{value:"interactive"},{default:l(()=>[e(s,null,{default:l(()=>[e(G(Oe))]),_:1}),t[7]||(t[7]=p(" 交互视图 ",-1))]),_:1}),e(M,{value:"list"},{default:l(()=>[e(s,null,{default:l(()=>[e(G(je))]),_:1}),t[8]||(t[8]=p(" 列表视图 ",-1))]),_:1})]),_:1},8,["modelValue"])]),d("div",Rt,[H.value==="interactive"?(h(),j("div",Dt,[e(c,{percentage:ye.value,"stroke-width":8,style:{width:"120px"}},null,8,["percentage"]),d("span",Mt,r(de.value)+"/"+r(g.value.length),1)])):pe("",!0),e(f,{trigger:"click",onCommand:$},{dropdown:l(()=>[e(V,null,{default:l(()=>[e(y,{command:"word"},{default:l(()=>[e(s,null,{default:l(()=>[e(G(he))]),_:1}),t[10]||(t[10]=p(" 导出 Word（修订版） ",-1))]),_:1}),e(y,{command:"json"},{default:l(()=>[e(s,null,{default:l(()=>[e(G(Fe))]),_:1}),t[11]||(t[11]=p(" 导出 JSON ",-1))]),_:1}),e(y,{command:"excel"},{default:l(()=>[e(s,null,{default:l(()=>[e(G(he))]),_:1}),t[12]||(t[12]=p(" 导出 Excel ",-1))]),_:1})]),_:1})]),default:l(()=>[e(n,{type:"primary"},{default:l(()=>[e(s,null,{default:l(()=>[e(G(Be))]),_:1}),t[9]||(t[9]=p(" 导出 ",-1)),e(s,{class:"el-icon--right"},{default:l(()=>[e(G(Pe))]),_:1})]),_:1})]),_:1})])]),d("div",Ut,[H.value==="interactive"?(h(),j(Ce,{key:0},[d("div",It,[e(qe,{ref_key:"documentViewerRef",ref:ie,"document-name":(ke=z.value)==null?void 0:ke.document_filename,paragraphs:me.value,"highlight-text":(xe=oe.value)==null?void 0:xe.original_text,loading:R.value},null,8,["document-name","paragraphs","highlight-text","loading"])]),d("div",St,[e(Je,{items:g.value,"active-item":oe.value,messages:x.value,"current-suggestion":se.value,loading:ae.value,onSelectItem:_,onSendMessage:W,onComplete:q,onLocate:L},null,8,["items","active-item","messages","current-suggestion","loading"])])],64)):(h(),S(kt,{key:1,result:N.value,language:((we=z.value)==null?void 0:we.language)||"zh-CN",onUpdateModification:T,onUpdateAction:le,onRefresh:i},null,8,["result","language"]))]),e(De,{modelValue:ee.value,"onUpdate:modelValue":t[3]||(t[3]=Y=>ee.value=Y),title:"导出修订版 Word",width:"500px"},{footer:l(()=>{var Y;return[e(n,{onClick:t[2]||(t[2]=ne=>ee.value=!1)},{default:l(()=>{var ne;return[p(r(((ne=D.value)==null?void 0:ne.status)==="completed"?"关闭":"取消"),1)]}),_:1}),((Y=D.value)==null?void 0:Y.status)==="completed"?(h(),S(n,{key:0,type:"success",onClick:X,loading:ue.value},{default:l(()=>[...t[22]||(t[22]=[p(" 下载文件 ",-1)])]),_:1},8,["loading"])):(h(),S(n,{key:1,type:"primary",onClick:E,loading:te.value,disabled:ve.value===0&&o.value===0},{default:l(()=>[p(r(te.value?"正在导出...":"开始导出"),1)]),_:1},8,["loading","disabled"]))]}),default:l(()=>{var Y,ne;return[d("div",$t,[D.value?pe("",!0):(h(),S(I,{key:0,title:"提示：生成修订版文档预计需要 2-3 分钟，请耐心等待",type:"info","show-icon":"",closable:!1,style:{"margin-bottom":"16px"}})),d("div",Et,[d("div",At,[e(s,null,{default:l(()=>[e(G(he))]),_:1}),t[13]||(t[13]=d("span",null,"修改建议（修订标记）",-1))]),t[15]||(t[15]=d("div",{class:"option-desc"}," 将已确认的修改建议以删除线和插入标记形式显示 ",-1)),d("div",Lt,[t[14]||(t[14]=p(" 已确认 ",-1)),d("strong",null,r(ve.value),1),p(" 条 / 共 "+r(((ne=(Y=N.value)==null?void 0:Y.modifications)==null?void 0:ne.length)||0)+" 条 ",1)])]),e(m),d("div",Ht,[d("div",zt,[e(Re,{modelValue:re.value,"onUpdate:modelValue":t[1]||(t[1]=Ue=>re.value=Ue)},{default:l(()=>[e(s,null,{default:l(()=>[e(G(We))]),_:1}),t[16]||(t[16]=d("span",null,"行动建议（批注）",-1))]),_:1},8,["modelValue"])]),t[19]||(t[19]=d("div",{class:"option-desc"}," 将已确认的行动建议作为批注添加到对应风险点的文本位置 ",-1)),d("div",Nt,[t[17]||(t[17]=p(" 已确认 ",-1)),d("strong",null,r(o.value),1),t[18]||(t[18]=p(" 条 ",-1))])]),D.value?(h(),j("div",Ot,[e(m),d("div",jt,[d("span",null,r(D.value.message),1),D.value.status==="completed"?(h(),S(b,{key:0,type:"success",size:"small"},{default:l(()=>[...t[20]||(t[20]=[p("完成",-1)])]),_:1})):D.value.status==="failed"?(h(),S(b,{key:1,type:"danger",size:"small"},{default:l(()=>[...t[21]||(t[21]=[p("失败",-1)])]),_:1})):(h(),S(b,{key:2,type:"info",size:"small"},{default:l(()=>[p(r(D.value.progress)+"%",1)]),_:1}))]),e(c,{percentage:D.value.progress,status:D.value.status==="completed"?"success":D.value.status==="failed"?"exception":"","stroke-width":10,style:{"margin-top":"8px"}},null,8,["percentage","status"])])):pe("",!0)])]}),_:1},8,["modelValue"])])),[[Me,K.value]])}}},qt=Ve(Bt,[["__scopeId","data-v-0f09b69e"]]);export{qt as default};
