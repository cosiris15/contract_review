# 架构演进说明：新一代 (Gen 3.0) 智能合同审查 Agent 开发蓝图

**To: Claude**
**From: Chen Chu**

## 1. 核心任务目标
我稍后将向你提供我们上一代合同审查方案的代码。你的任务是：**阅读旧代码，并严格根据本蓝图定义的新一代 (Gen 3.0) 架构目标，协助我进行全面的代码重构和 Vibe Coding 开发。**

新方案的核心定位是面向客户的 Web 端 SaaS 产品。它不再是一个单向执行的流水线工具，而是一个具备“自主编排、状态记忆、人机协同”能力的 Agent 系统。

## 2. 新一代架构核心原则与目标设计

我们需要在新的代码仓库中实现以下四大核心机制：

### 2.1 架构模式：Orchestrator-Worker (主控网关 + 远程微服务)
* **主控层 (本地核心代码库):** 负责维护用户 Session、解析文档结构、管理状态机（如 LangGraph）以及控制交互流。主程序**必须**剥离复杂的法律审查 Prompt、长文本检索管道或硬编码的规则逻辑。
* **执行层 (Refly.ai Workflows 作为 Skills):** 所有的核心法律技能——如事实核查、条款对标检查、风险逻辑推算等——将全部作为独立的工作流部署在 **Refly.ai** 平台上。
* **解耦对接:** 主控层仅需知道 "When & What to call" (何时调用哪个 Skill)。它通过 HTTP API 异步调用 Refly.ai 工作流，并处理网络超时、轮询 (Polling) 或 Webhook 回调。

### 2.2 控制流：Stateful & Human-in-the-loop (状态化与人机协同)
* **状态机编排:** 引入 LangGraph（或其他状态管理框架）来驱动审查流程。支持循环推理 (Reasoning Loop)，例如：`识别出风险 -> 检索标准 -> 提议修改策略 -> 验证策略`。
* **强审批机制 (Interrupts):** 法律场景要求绝对的严谨。Agent 在生成实质性的文本修改建议后，必须在工作流中挂起 (Pause)，等待 Web 端用户明确触发“批准 (Approve) / 拒绝 (Reject)”的指令后，才能继续合并文本或流转到下一步。


### 2.3 交互范式：Chat + Canvas (对话与画布双屏协同)
* **前端结构:** 必须支持类似 OpenAI Canvas 或 Cursor 的双屏 UI，以适应长文本阅读。
    * **侧边栏 (Chat):** 用于用户输入审查要求（如“重点看违约责任”），以及 Agent 汇报进度、解释风险判定依据。
    * **主视图 (Canvas):** 集成富文本编辑器，实时展示合同正文。
* **结构化渲染:** 所有的文本修改动作，Agent 必须输出严格规范的 JSON 数据（如包含 `original_text`, `proposed_text`, `action_type` 的 Diff 数据）。前端根据 JSON 在 Canvas 中渲染“红线修订 (Redlining)”，而非让大模型直接重写整篇文档。

### 2.4 数据与接口契约
* 内部流转及内外 API 通信必须基于严格的强类型模型定义（如 Pydantic schemas）。确保大模型结构化输出的稳定性，作为系统运转的基石。

## 3. 你的行动指令 (Action Items)

在阅读完我提供的旧代码后，请按以下步骤协助我：

1.  **架构 Gap 诊断:** 评估旧代码与上述新蓝图的差距。明确指出哪些模块应该被彻底废弃，哪些模块的逻辑需要被抽离到 Refly.ai，以及哪些基础代码可以改造成主控层的路由逻辑。
2.  **API 调用封装设计:** 优先为我规划一个 `ReflySkillCaller` 核心类，要求能够优雅地封装向 Refly 发起异步请求、轮询任务状态并提取结构化 JSON 结果的逻辑。
3.  **状态机拓扑设计:** 根据合同审查逻辑，设计一个基于 LangGraph 的核心执行图（Graph）代码骨架，必须清晰展示 `Human_Approval` 挂起节点的设计思路。
4.  **前端数据流转方案:** 提出将后端的 JSON Diff 数据安全地推送到前端，并在富文本编辑器中完成 Redline 渲染的技术链路建议。

请确认你已完全理解上述架构蓝图。待我发送旧代码后，我们将正式开始重构作业。