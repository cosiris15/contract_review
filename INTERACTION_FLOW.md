# 十行合同 - 当前交互流程文档

> 最后更新：2025年12月
> 用于后续开发参考

---

## 一、项目概述

AI辅助法务文本审阅系统，支持两种审阅模式：
- **标准模式**：使用预先定义的审核标准进行三阶段审阅
- **交互模式**：无需预设标准，AI自主审阅 + 多轮对话迭代

---

## 二、用户交互流程总览

```
┌─────────────────────────────────────────────────────────────────┐
│                         首页 (HomeView)                          │
│                                                                 │
│  [新建审阅任务] ──────────────────────────────────────────────►  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    审阅流程页 (ReviewView)                        │
│                                                                 │
│  步骤1: 上传合同文档                                              │
│         └─ 自动识别：合同各方、材料类型、推荐任务名称                  │
│         └─ 弹出身份选择框（可查看文档预览）                          │
│                                                                 │
│  步骤2: 直接开始审阅（默认 AI 智能审阅模式）                         │
│         └─ 无需选择任何配置，上传文档后即可开始                       │
│                                                                 │
│  [高级选项]（默认折叠，点击展开）                                   │
│         ├─ 选择/上传审核标准                                      │
│         ├─ 选择业务条线                                          │
│         └─ 填写特殊要求                                          │
│                                                                 │
│  [开始审阅] ─────────────────────────────────────────────────►   │
└─────────────────────────────────────────────────────────────────┘
                              │
           ┌──────────────────┴──────────────────┐
           │                                     │
           ▼                                     ▼
┌─────────────────────────┐        ┌─────────────────────────────┐
│  标准模式结果页            │        │  交互审阅页                   │
│  (UnifiedResultView)     │        │  (InteractiveReviewView)    │
│                         │        │                             │
│  ├─ 风险点列表            │        │  ┌───────────┬───────────┐  │
│  ├─ 修改建议列表（可编辑）  │        │  │ 文档查看器  │  对话面板   │  │
│  ├─ 行动建议列表（可编辑）  │        │  │           │           │  │
│  └─ 统计摘要             │        │  │ 段落列表   │ 条目tabs  │  │
│                         │        │  │ 高亮定位   │ 原文vs建议 │  │
│  [导出]                  │        │  │           │ 对话历史   │  │
│   ├─ Word修订版          │        │  │           │ 输入框    │  │
│   ├─ Excel              │        │  │           │           │  │
│   ├─ JSON               │        │  └───────────┴───────────┘  │
│   └─ CSV                │        │                             │
└─────────────────────────┘        │  [标记完成] [导出]           │
                                   └─────────────────────────────┘
```

---

## 三、标准模式详细流程

### 3.1 审阅过程

```
用户操作                          后端处理                         前端展示
─────────────────────────────────────────────────────────────────────────

1. 上传文档 ──────────────►  DocumentPreprocessor          显示识别结果
   (PDF/Word/TXT)            ├─ 提取文本                    ├─ 合同各方
                             ├─ 识别合同各方                 ├─ 材料类型
                             └─ 推荐任务名称                 └─ 推荐名称

2. 选择标准 ──────────────►  加载标准内容                   显示标准预览
   ├─ 上传文件(Excel/CSV)
   ├─ 选择内置模板
   └─ 从标准库选择

3. 可选配置
   ├─ 选择业务条线
   └─ 填写特殊要求

4. 开始审阅 ──────────────►  ReviewEngine.review_document()
                             │
                             ├─ 阶段1: 风险识别 ─────────►  进度: 33%
                             │   └─ 生成 RiskPoint[] (含深度分析)
                             │
                             ├─ 阶段2: 修改建议 ─────────►  进度: 66%
                             │   └─ 生成 ModificationSuggestion[]
                             │   └─ (可通过 skip_modifications 跳过)
                             │
                             └─ 阶段3: 行动建议 ─────────►  进度: 100%
                                 └─ 生成 ActionRecommendation[]

5. 查看结果 ◄──────────────  返回 ReviewResult              UnifiedResultView
                                                          ├─ 风险点表
                                                          ├─ 修改建议表
                                                          └─ 行动建议表
```

### 3.2 结果编辑

| 操作 | API | 说明 |
|------|-----|------|
| 编辑修改建议 | `PATCH /api/tasks/{taskId}/result/modifications/{id}` | 修改建议文本、优先级 |
| 编辑行动建议 | `PATCH /api/tasks/{taskId}/result/actions/{id}` | 修改描述、紧急程度 |
| 确认条目 | 同上，设置 `user_confirmed=true` | 标记为已确认 |

---

## 四、交互模式详细流程

### 4.0 设计理念：分析与修改分离

交互模式采用"分析-讨论-修改"三阶段设计，核心理念：

1. **分析阶段**：让AI充分发挥能力
   - 移除输出限制，进行深度分析
   - 生成详细的 `analysis` 字段
   - 不生成修改建议，专注于问题发现

2. **讨论阶段**：用户与AI充分交流
   - 基于深度分析结果讨论
   - 确认哪些风险需要处理
   - 用户可以提出自己的见解

3. **修改阶段**：应用最小改动原则
   - 仅在用户确认后生成修改建议
   - 遵循"奥卡姆剃刀"原则
   - 保持原文风格，最小化改动

### 4.1 启动审阅

```
用户操作                          后端处理                         前端展示
─────────────────────────────────────────────────────────────────────────

1. 上传文档 ──────────────►  同标准模式                     同标准模式

2. 可选配置
   ├─ 选择标准（非必须）
   └─ 选择业务条线

3. 深度交互审阅 ───────────►  InteractiveReviewEngine       进入交互页面
                             └─ unified_review()
                                 └─ 生成风险分析结果
                                    ├─ risks[] (含深度analysis)
                                    ├─ modifications[] (可选跳过)
                                    └─ actions[]
```

### 4.2 交互页面布局

```
┌────────────────────────────────────────────────────────────────────────┐
│  InteractiveReviewView                                                  │
├──────────────────────────────┬─────────────────────────────────────────┤
│                              │                                         │
│  DocumentViewer              │  ChatPanel                              │
│  ─────────────────────────   │  ─────────────────────────────────────  │
│                              │                                         │
│  段落1                        │  [条目1] [条目2] [条目3] ...  ← tabs    │
│  段落2  ← 高亮当前条目位置      │  ─────────────────────────────────────  │
│  段落3                        │                                         │
│  段落4                        │  原文：xxx                              │
│  ...                         │  建议：xxx                              │
│                              │  风险说明：xxx                           │
│  可滚动                       │  ─────────────────────────────────────  │
│  点击定位                      │                                         │
│                              │  [AI] 基于合同分析，建议修改为...          │
│                              │  [用户] 能否保留原有表述？                 │
│                              │  [AI] 可以，但需要注意...                 │
│                              │  ...                                    │
│                              │  ─────────────────────────────────────  │
│                              │  [输入框________________] [发送]         │
│                              │                                         │
│                              │  [标记完成]                              │
│                              │                                         │
└──────────────────────────────┴─────────────────────────────────────────┘
```

### 4.3 对话交互

```
用户操作                          后端处理                         数据变化
─────────────────────────────────────────────────────────────────────────

选择条目 ────────────────────►  getItemDetail()              加载对话历史

发送消息 ────────────────────►  sendChatMessage()
"请解释为什么要这样修改"          │
                               ├─ 调用 LLM 生成回复
                               ├─ 保存消息到 InteractiveChat
                               └─ 可能更新 current_suggestion

发送消息 ────────────────────►  同上
"请改成更温和的表述"              └─ 生成新建议，更新 suggestion_snapshot

标记完成 ────────────────────►  completeItem()               status='completed'
                               └─ 保存最终建议
```

### 4.4 修改建议生成（新增）

```
用户操作                          后端处理                         数据变化
─────────────────────────────────────────────────────────────────────────

批量生成修改 ───────────────────►  generate_modifications_batch()
(用户确认多个风险点后)              │
                                 ├─ 调用 LLM 批量生成修改建议
                                 ├─ 应用最小改动原则
                                 └─ 返回 ModificationSuggestion[]

单条生成修改 ───────────────────►  generate_single_modification()
(讨论后针对单个风险)                │
                                 ├─ 包含讨论摘要和用户决定
                                 ├─ 调用 LLM 生成定制化修改
                                 └─ 返回 ModificationSuggestion
```

---

## 五、导出功能

### 5.1 支持的导出格式

| 格式 | API | 说明 |
|------|-----|------|
| Word修订版 | `POST /api/tasks/{taskId}/export/redline/start` | 异步，带修订标记 |
| Excel | `GET /api/tasks/{taskId}/export/excel` | 同步直接下载 |
| JSON | `GET /api/tasks/{taskId}/export/json` | 完整结果 |
| CSV | `GET /api/tasks/{taskId}/export/csv` | 表格格式 |

### 5.2 Word修订版流程

```
1. 启动导出 ─────────────────►  redline_generator
                               ├─ 解析原文档
                               ├─ 应用修改建议
                               │   ├─ 删除线标记原文
                               │   └─ 插入标记新文本
                               └─ 可选：添加批注（行动建议）

2. 轮询状态 ─────────────────►  返回进度百分比

3. 下载文件 ◄────────────────   返回 .docx 文件
```

---

## 六、关键API端点

### 6.1 任务管理
```
POST   /api/tasks                    创建任务
GET    /api/tasks/{taskId}           获取任务详情
GET    /api/tasks/{taskId}/status    获取状态（轮询）
DELETE /api/tasks/{taskId}           删除任务
```

### 6.2 文档处理
```
POST   /api/tasks/{taskId}/document     上传文档
POST   /api/tasks/{taskId}/preprocess   预处理（识别各方）
GET    /api/tasks/{taskId}/document/text 获取段落化文本
```

### 6.3 审阅
```
POST   /api/tasks/{taskId}/review                标准模式审阅
POST   /api/tasks/{taskId}/unified-review        交互模式审阅（轮询）
POST   /api/tasks/{taskId}/unified-review-stream 交互模式审阅（SSE流式）
GET    /api/tasks/{taskId}/result                获取结果
```

### 6.4 交互对话
```
GET    /api/interactive/{taskId}/items              获取所有条目
GET    /api/interactive/{taskId}/items/{itemId}     获取条目详情
POST   /api/interactive/{taskId}/items/{itemId}/chat 发送消息
POST   /api/interactive/{taskId}/items/{itemId}/complete 标记完成
```

### 6.5 修改建议生成（新增）
```
POST   /api/tasks/{taskId}/generate-modifications              批量生成修改建议
       Body: { risk_ids: string[], user_notes?: string }
       用于用户确认多个风险点后，批量生成修改建议

POST   /api/tasks/{taskId}/risks/{riskId}/generate-modification 单条生成修改建议
       Body: { discussion_summary: string, user_decision: string }
       用于讨论后针对单个风险点生成定制化修改
```

---

## 七、数据模型关系

```
ReviewTask (任务)
    │
    ├── document (文档)
    ├── standard (标准，可选)
    ├── business_line (业务条线，可选)
    │
    └── ReviewResult (结果)
            │
            ├── RiskPoint[] (风险点)
            │       │
            │       ├── analysis (深度分析，新字段)
            │       └──┐
            │          │
            ├── ModificationSuggestion[] (修改建议)
            │       │   关联 risk_id
            │       │   可延迟生成（用户确认后）
            │       │
            │       └── InteractiveChat (对话，交互模式)
            │
            └── ActionRecommendation[] (行动建议)
                    │
                    └── InteractiveChat (对话，交互模式)
```

---

## 八、前端路由

| 路由 | 组件 | 功能 |
|------|------|------|
| `/` | HomeView | 首页 |
| `/documents` | DocumentsView | 文档/任务列表 |
| `/review/:taskId` | ReviewView | 审阅流程（两种模式入口） |
| `/interactive/:taskId` | InteractiveReviewView | 交互审阅工作区 |
| `/review-result/:taskId` | UnifiedResultView | 统一结果页 |
| `/standards` | StandardsView | 标准库管理 |
| `/business` | BusinessView | 业务条线管理 |

---

## 九、状态管理 (Pinia Store)

### review store (主store)
```javascript
{
  currentTask: Task,          // 当前任务
  reviewResult: ReviewResult, // 审阅结果
  isReviewing: boolean,       // 审阅中
  progress: {                 // 进度
    phase: string,
    percentage: number
  }
}
```

### settings store
```javascript
{
  llmProvider: 'deepseek' | 'gemini'  // LLM选择
}
```

---

## 十、后续开发注意事项

1. **两种模式的入口统一在 ReviewView**
   - 标准模式：需要选择标准
   - 交互模式：标准可选

2. **交互模式的对话记录**
   - 存储在 `interactive_chats` 表
   - 每个条目（修改/行动建议）有独立对话

3. **导出时机**
   - 标准模式：审阅完成后即可导出
   - 交互模式：建议在条目对话完成后导出

4. **LLM Fallback**
   - 主：DeepSeek
   - 备：Gemini
   - 自动切换，用户无感知

5. **流式输出**
   - 交互对话支持 SSE (Server-Sent Events) 流式响应
   - 前端实时显示 AI 回复，带打字光标效果
   - 后端 API: `POST /api/interactive/{task_id}/items/{item_id}/chat/stream`
   - 事件类型：
     - `chunk`: 文本片段
     - `suggestion`: 更新后的建议
     - `done`: 完成信号
     - `error`: 错误信息

6. **流式审阅（边审边看）**
   - 审阅过程支持 SSE 流式推送风险点
   - 后端 API: `POST /api/tasks/{task_id}/unified-review-stream`
   - 核心组件：
     - `IncrementalRiskParser`: 增量 JSON 解析器，使用状态机解析流式输出
     - `unified_review_stream()`: 异步生成器，边解析边 yield 风险点
   - 事件类型：
     - `start`: 审阅开始 `{task_id}`
     - `progress`: 进度更新 `{percentage, message}`
     - `risk`: 新风险点 `{data, index}` - 每个风险单独推送
     - `complete`: 审阅完成 `{summary, actions, total_risks}`
     - `error`: 错误 `{message}`
   - 用户体验优化：
     - 第一条风险点到达即更新状态为 `partial_ready`，用户可立即跳转
     - 后续风险在后台继续接收，自动追加到列表
     - 等待时间从 60-120 秒缩短到约 30 秒（第一条风险生成时间）
   - 降级策略：
     - 流式审阅失败自动回退到传统轮询模式
     - 如已收到部分风险，继续使用已有结果

7. **分析与修改分离（重要）**
   - 风险识别阶段：移除输出限制，充分发挥AI分析能力
   - RiskPoint 新增 `analysis` 字段存储深度分析
   - 初步审阅可通过 `skip_modifications=true` 跳过修改建议生成
   - 修改建议可延迟到用户确认风险后再生成
   - 修改生成阶段：严格遵循最小改动原则（奥卡姆剃刀）

8. **修改建议生成时机**
   - 批量生成：用户确认多个风险点后，调用 `/generate-modifications`
   - 单条生成：讨论后针对单个风险，调用 `/risks/{riskId}/generate-modification`
   - 两种方式都应用最小改动原则

---

## 十一、完整工作流程图 (Dify/Refly 迁移参考)

> 以下流程图用于迁移到 Dify/Refly 等工作流平台时参考

### 11.1 标准模式完整工作流

```
                                    ┌─────────────────┐
                                    │    用户输入      │
                                    │  ─────────────  │
                                    │  • 上传文档      │
                                    │  • 我方身份      │
                                    │  • 材料类型      │
                                    │  • 语言         │
                                    └────────┬────────┘
                                             │
                                             ▼
┌────────────────────────────────────────────────────────────────────────────────┐
│  节点1: 文档预处理 (document_preprocessing)                                      │
│  ──────────────────────────────────────────                                    │
│  输入: file, use_ocr                                                           │
│  处理:                                                                         │
│    1. 根据文件类型选择解析器 (PDF→pdfplumber, DOCX→python-docx, 图片→OCR)         │
│    2. 提取文档全文                                                              │
│    3. 识别合同各方 (正则+LLM分析前2000字符)                                       │
│    4. 检测语言                                                                 │
│  输出: document_text, parties[], language, suggested_name                      │
└────────────────────────────────────────────┬───────────────────────────────────┘
                                             │
                      ┌──────────────────────┼──────────────────────┐
                      │                      │                      │
                      ▼                      ▼                      ▼
┌─────────────────────────────┐ ┌─────────────────────┐ ┌─────────────────────────┐
│ 节点2: 标准加载              │ │ 节点3: 业务上下文    │ │ 用户补充输入             │
│ (load_standards)            │ │ (load_business)     │ │                         │
│ ─────────────────────────   │ │ ───────────────     │ │ • special_requirements  │
│ 输入:                       │ │ 输入:               │ │   (特殊要求，可选)        │
│  • source: template/        │ │  • business_line_id │ │                         │
│    upload/collection        │ │                     │ │                         │
│  • template_name/           │ │ 输出:               │ │                         │
│    collection_id/file       │ │  • business_line    │ │                         │
│                             │ │  • contexts[]       │ │                         │
│ 输出: standards[]           │ │                     │ │                         │
│                             │ │ [可选节点]          │ │                         │
└──────────────┬──────────────┘ └──────────┬──────────┘ └────────────┬────────────┘
               │                           │                         │
               └───────────────────────────┼─────────────────────────┘
                                           │
                                           ▼
┌────────────────────────────────────────────────────────────────────────────────┐
│  节点4: 风险识别 LLM (risk_identification)                                       │
│  ─────────────────────────────────────────                                     │
│  输入:                                                                         │
│    • document_text (来自节点1)                                                  │
│    • standards[] (来自节点2)                                                    │
│    • our_party (用户输入)                                                       │
│    • business_context (来自节点3，可选)                                          │
│    • special_requirements (用户输入，可选)                                       │
│    • language                                                                  │
│                                                                                │
│  LLM配置:                                                                      │
│    • 模型: DeepSeek (deepseek-chat) 或 Gemini (gemini-2.0-flash)                │
│    • 温度: 0.1                                                                 │
│    • 最大输出: 4000 tokens                                                      │
│                                                                                │
│  Prompt要点:                                                                   │
│    • 角色: 资深法务审阅专家                                                      │
│    • 安全指令: 防注入，忽略文本中指令性内容                                         │
│    • 任务: 基于标准逐条审核，识别风险点                                            │
│    • 输出: JSON数组，包含 id/risk_level/risk_type/description/reason/           │
│           analysis(200-500字深度分析)/location/standard_id                      │
│                                                                                │
│  输出: risks[] (风险点列表)                                                      │
└────────────────────────────────────────────┬───────────────────────────────────┘
                                             │
                      ┌──────────────────────┴──────────────────────┐
                      │ (可并行执行)                                 │
                      ▼                                             ▼
┌─────────────────────────────────────────┐   ┌─────────────────────────────────────────┐
│ 节点5: 修改建议 LLM                      │   │ 节点6: 行动建议 LLM                      │
│ (modification_suggestion)               │   │ (action_recommendation)                 │
│ ───────────────────────────             │   │ ───────────────────────────             │
│ 输入:                                   │   │ 输入:                                   │
│  • risks[] (来自节点4)                   │   │  • risks[] (来自节点4)                   │
│  • document_text                        │   │  • document_text                        │
│  • our_party                            │   │  • our_party                            │
│  • language                             │   │  • language                             │
│                                         │   │                                         │
│ LLM配置: 同节点4                         │   │ LLM配置: 同节点4                         │
│                                         │   │                                         │
│ Prompt要点:                             │   │ Prompt要点:                             │
│  • 修改原则: 奥卡姆剃刀/最小改动          │   │  • 行动类型: negotiate/supplement/       │
│  • 精确引用原文                          │   │    verify/legal_consult/other           │
│  • 保持合同整体风格                      │   │  • 关联风险点                            │
│  • 商业可接受性                          │   │  • 紧急程度                              │
│                                         │   │                                         │
│ 输出: modifications[]                   │   │ 输出: actions[]                         │
│  • id, risk_id, original_text           │   │  • id, related_risk_ids[]               │
│  • suggested_text, modification_reason  │   │  • action_type, description             │
│  • priority (must/should/may)           │   │  • urgency, responsible_party           │
│  • is_addition                          │   │                                         │
└──────────────────┬──────────────────────┘   └──────────────────┬──────────────────────┘
                   │                                             │
                   └─────────────────────┬───────────────────────┘
                                         │
                                         ▼
┌────────────────────────────────────────────────────────────────────────────────┐
│  节点7: 结果合并与统计 (result_aggregation)                                      │
│  ───────────────────────────────────────                                       │
│  输入:                                                                         │
│    • risks[] (来自节点4)                                                        │
│    • modifications[] (来自节点5)                                                │
│    • actions[] (来自节点6)                                                      │
│                                                                                │
│  处理:                                                                         │
│    1. 合并三个列表                                                              │
│    2. 计算统计摘要:                                                             │
│       • total_risks, high_risks, medium_risks, low_risks                       │
│       • total_modifications, must/should/may_modifications                     │
│       • total_actions                                                          │
│    3. 记录使用的LLM模型和时间戳                                                  │
│                                                                                │
│  输出: review_result (完整审阅结果)                                              │
│    {                                                                           │
│      risks: [...],                                                             │
│      modifications: [...],                                                     │
│      actions: [...],                                                           │
│      summary: { total_risks, high_risks, ... },                                │
│      llm_model: "deepseek-chat",                                               │
│      reviewed_at: "2025-01-15T10:30:00Z"                                       │
│    }                                                                           │
└────────────────────────────────────────────┬───────────────────────────────────┘
                                             │
                                             ▼
                                    ┌─────────────────┐
                                    │    输出结果      │
                                    │  ─────────────  │
                                    │  • 风险点列表    │
                                    │  • 修改建议列表  │
                                    │  • 行动建议列表  │
                                    │  • 统计摘要      │
                                    └─────────────────┘
```

### 11.2 交互模式完整工作流

```
                                    ┌─────────────────┐
                                    │    用户输入      │
                                    │  ─────────────  │
                                    │  • 上传文档      │
                                    │  • 我方身份      │
                                    │  • 标准 (可选)   │
                                    │  • 业务条线(可选)│
                                    └────────┬────────┘
                                             │
                                             ▼
┌────────────────────────────────────────────────────────────────────────────────┐
│  节点1-2: 文档预处理 + 标准加载 (同标准模式)                                      │
└────────────────────────────────────────────┬───────────────────────────────────┘
                                             │
                                             ▼
┌────────────────────────────────────────────────────────────────────────────────┐
│  节点3: 统一深度分析 LLM (unified_deep_analysis)                                 │
│  ──────────────────────────────────────────────                                │
│  输入:                                                                         │
│    • document_text                                                             │
│    • standards[] (可为空 - 无标准时AI自主分析)                                   │
│    • our_party                                                                 │
│    • special_requirements (可选)                                               │
│    • skip_modifications: true (跳过修改建议，专注分析)                           │
│                                                                                │
│  特点:                                                                         │
│    • 有标准时: 基于标准识别 + AI自主发挥                                         │
│    • 无标准时: 完全依靠AI专业知识全面分析                                         │
│    • 强调 analysis 字段质量 (200-500字深度分析)                                  │
│    • 不生成修改建议，让用户先讨论确认                                             │
│                                                                                │
│  输出: risks[] (仅含分析，无修改建议)                                            │
│    [                                                                           │
│      {                                                                         │
│        id, risk_level, risk_type, description, reason,                         │
│        analysis: "【风险分析】...\n【法律依据】...\n【建议方向】...",              │
│        location                                                                │
│      },                                                                        │
│      ...                                                                       │
│    ]                                                                           │
└────────────────────────────────────────────┬───────────────────────────────────┘
                                             │
                                             ▼
                                    ┌─────────────────┐
                                    │  初步分析结果    │
                                    │  (进入交互页面)  │
                                    └────────┬────────┘
                                             │
                    ┌────────────────────────┴────────────────────────┐
                    │                                                 │
                    ▼                                                 │
    ┌───────────────────────────────────────┐                         │
    │  用户选择条目开始对话                   │                         │
    │  ─────────────────────                │                         │
    │  选择某个风险点进行讨论                 │                         │
    └───────────────┬───────────────────────┘                         │
                    │                                                 │
                    ▼                                                 │
┌────────────────────────────────────────────────────────────────┐    │
│  节点4: 多轮对话 LLM (interactive_chat) [循环节点]              │    │
│  ─────────────────────────────────────────                     │    │
│  输入:                                                         │    │
│    • item_id: 当前讨论的条目ID                                  │    │
│    • item_type: "risk" | "modification" | "action"             │    │
│    • item_content: 条目内容                                     │    │
│    • chat_history: 历史对话                                     │    │
│      [                                                         │    │
│        {role: "user", content: "请解释..."},                    │    │
│        {role: "assistant", content: "这个风险..."},             │    │
│        ...                                                     │    │
│      ]                                                         │    │
│    • document_text: 文档全文 (供引用)                            │    │
│    • user_message: 用户当前消息                                  │    │
│                                                                │    │
│  LLM配置:                                                      │    │
│    • 温度: 0.3 (略高以增加对话自然度)                            │    │
│    • 流式输出: 是 (SSE)                                         │    │
│                                                                │    │
│  Prompt要点:                                                   │    │
│    • 角色: 用户的法务顾问                                        │    │
│    • 直接回答用户问题                                            │    │
│    • 引用法律条文时注明出处                                      │    │
│    • 可在对话中更新修改建议                                      │    │
│                                                                │    │
│  输出:                                                         │    │
│    • assistant_message: AI回复                                 │    │
│    • updated_suggestion: 更新后的建议 (如有)                     │    │
│                                                                │    │
│  ┌──────────────────────────────────────────────────────────┐  │    │
│  │  循环: 用户继续发送消息 → AI回复 → ...                     │  │    │
│  │  退出条件: 用户点击"标记完成"或切换到其他条目               │  │    │
│  └──────────────────────────────────────────────────────────┘  │    │
└────────────────────────────────────────────┬───────────────────┘    │
                                             │                        │
                                             ▼                        │
                                    ┌─────────────────┐               │
                                    │  用户标记完成    │               │
                                    │  或切换条目      │               │
                                    └────────┬────────┘               │
                                             │                        │
                    ┌────────────────────────┼────────────────────────┘
                    │                        │
                    │ (继续讨论其他条目)       │ (所有条目讨论完毕)
                    │                        │
                    └───────┐                ▼
                            │       ┌─────────────────┐
                            │       │  用户确认风险    │
                            │       │  准备生成修改    │
                            │       └────────┬────────┘
                            │                │
                            │                ▼
                            │  ┌────────────────────────────────────────────────────────┐
                            │  │  节点5: 修改建议生成 LLM (batch_modification_generation) │
                            │  │  ──────────────────────────────────────────────────    │
                            │  │  触发方式:                                              │
                            │  │    A. 批量生成: POST /tasks/{id}/generate-modifications │
                            │  │       Body: { risk_ids: [...], user_notes: "..." }     │
                            │  │    B. 单条生成: POST /tasks/{id}/risks/{rid}/generate.. │
                            │  │       Body: { discussion_summary, user_decision }      │
                            │  │                                                        │
                            │  │  输入:                                                  │
                            │  │    • confirmed_risks: 用户确认的风险点                   │
                            │  │    • chat_summaries: 各风险点的讨论摘要 (如有)            │
                            │  │    • document_text                                     │
                            │  │    • our_party                                         │
                            │  │                                                        │
                            │  │  Prompt要点:                                            │
                            │  │    • 最小改动原则 (奥卡姆剃刀)                            │
                            │  │    • 参考讨论中用户的倾向                                 │
                            │  │    • 保持合同整体风格一致                                 │
                            │  │                                                        │
                            │  │  输出: modifications[]                                  │
                            │  └────────────────────────────────────────┬───────────────┘
                            │                                          │
                            └──────────────────────────────────────────┤
                                                                       │
                                                                       ▼
                                                              ┌─────────────────┐
                                                              │    最终结果      │
                                                              │  ─────────────  │
                                                              │  • 风险分析列表  │
                                                              │  • 讨论记录      │
                                                              │  • 修改建议列表  │
                                                              │  • 可导出       │
                                                              └─────────────────┘
```

### 11.3 数据流向图

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              数据流向总览                                        │
└─────────────────────────────────────────────────────────────────────────────────┘

用户输入
    │
    ├─► file (文档文件)
    ├─► our_party (我方身份: 甲方/乙方/...)
    ├─► material_type (材料类型: contract/marketing)
    ├─► language (语言: zh-CN/en)
    ├─► standard_source (标准来源: template/upload/collection)
    ├─► business_line_id (业务条线ID, 可选)
    └─► special_requirements (特殊要求, 可选)
           │
           ▼
    ┌──────────────────────────────────────────────────────────────────────────┐
    │                          节点间数据传递                                    │
    │                                                                          │
    │   节点1 ───document_text───┬──────────────────────────────────────────►  │
    │         ───parties[]───────┤                                             │
    │         ───language────────┤                                             │
    │                            │                                             │
    │   节点2 ───standards[]─────┼──────────────────────────────────────────►  │
    │                            │                                             │
    │   节点3 ───business_context┼──────────────────────────────────────────►  │
    │                            │                                             │
    │                            ▼                                             │
    │                     ┌─────────────┐                                      │
    │                     │   节点4     │                                      │
    │                     │  风险识别   │                                      │
    │                     │    LLM     │                                      │
    │                     └──────┬──────┘                                      │
    │                            │                                             │
    │                     risks[]│                                             │
    │                            │                                             │
    │              ┌─────────────┼─────────────┐                               │
    │              ▼             │             ▼                               │
    │       ┌─────────────┐     │      ┌─────────────┐                        │
    │       │   节点5     │     │      │   节点6     │                        │
    │       │  修改建议   │     │      │  行动建议   │                        │
    │       │    LLM     │     │      │    LLM     │                        │
    │       └──────┬──────┘     │      └──────┬──────┘                        │
    │              │            │             │                               │
    │   modifications[]        │      actions[]                              │
    │              │            │             │                               │
    │              └────────────┼─────────────┘                               │
    │                           │                                             │
    │                           ▼                                             │
    │                    ┌─────────────┐                                      │
    │                    │   节点7     │                                      │
    │                    │  结果合并   │                                      │
    │                    └──────┬──────┘                                      │
    │                           │                                             │
    └───────────────────────────┼──────────────────────────────────────────────┘
                                │
                                ▼
                         review_result
                                │
    ┌───────────────────────────┼───────────────────────────────┐
    │                           │                               │
    ▼                           ▼                               ▼
┌────────────┐          ┌────────────┐                  ┌────────────┐
│  前端展示   │          │  数据存储   │                  │   导出     │
│            │          │            │                  │            │
│ • 风险表    │          │ • tasks    │                  │ • JSON     │
│ • 修改表    │          │ • results  │                  │ • Excel    │
│ • 行动表    │          │ • chats    │                  │ • Word     │
│ • 统计     │          │            │                  │ • CSV      │
└────────────┘          └────────────┘                  └────────────┘
```

### 11.4 LLM 节点配置速查表

| 节点 | 模型 | 温度 | 最大输出 | 超时 | 输出格式 |
|------|------|------|----------|------|----------|
| 风险识别 | DeepSeek/Gemini | 0.1 | 4000 | 120s | JSON数组 |
| 修改建议 | DeepSeek/Gemini | 0.1 | 4000 | 120s | JSON数组 |
| 行动建议 | DeepSeek/Gemini | 0.1 | 4000 | 120s | JSON数组 |
| 交互对话 | DeepSeek/Gemini | 0.3 | 2000 | 60s | 自然语言+可选JSON |

### 11.5 Dify/Refly 节点映射建议

```
本系统节点                    Dify/Refly 建议节点类型
─────────────────────────────────────────────────────────

文档预处理                 →  代码节点 (Python)
                             或 自定义工具节点

标准加载                   →  数据库查询节点
                             或 HTTP请求节点 (调用API)

业务上下文加载              →  数据库查询节点
                             或 HTTP请求节点

风险识别 LLM               →  LLM节点
                             配置: 使用自定义Prompt模板
                             输出: JSON解析

修改建议 LLM               →  LLM节点
                             可与风险识别并行或串行

行动建议 LLM               →  LLM节点
                             可与修改建议并行

结果合并                   →  代码节点 (Python/JavaScript)
                             聚合多个LLM输出

多轮对话 LLM               →  对话型LLM节点
                             配置: 记忆/上下文管理

条件分支                   →  条件节点
                             判断: 有无标准、交互/标准模式
```

### 11.6 变量命名规范

```yaml
# 输入变量
input.file                    # 上传的文档文件
input.our_party               # 我方身份
input.material_type           # 材料类型
input.language                # 语言
input.standard_source         # 标准来源
input.business_line_id        # 业务条线ID
input.special_requirements    # 特殊要求

# 中间变量
var.document_text             # 文档全文
var.parties                   # 识别的各方
var.standards                 # 审核标准列表
var.business_context          # 业务背景
var.risks                     # 风险点列表
var.modifications             # 修改建议列表
var.actions                   # 行动建议列表

# 交互模式变量
var.current_item_id           # 当前讨论条目ID
var.chat_history              # 对话历史
var.user_message              # 用户消息

# 输出变量
output.review_result          # 完整审阅结果
output.summary                # 统计摘要
```

---

## 十二、附录: Prompt 模板索引

详细的 Prompt 模板请参考 `docs/WORKFLOW_SPECIFICATION.md` 文件，包括:

1. **风险识别 Prompt** - 第5.1节
2. **修改建议 Prompt** - 第5.2节
3. **行动建议 Prompt** - 第5.3节
4. **交互对话 Prompt** - 第5.4节
5. **补充条款生成 Prompt** - 第5.5节

---

*文档结束*
